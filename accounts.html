<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund Flow - Accounts</title>
    <link id="favicon" rel="icon" type="image/png" href="images/fundflow-logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>tailwind.config = { darkMode: 'class', theme: { extend: { colors: { dark: { bg: '#000000', card: '#111827' } } } } }</script>
    <style>
        body { font-family: 'Inter', sans-serif; } 
        ::-webkit-scrollbar { width: 4px; } 
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; } 
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; } 
        .hidden { display: none !important; } 
        .no-scrollbar::-webkit-scrollbar { display: none; } 
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.2em 1.2em;
        }
    </style>

    <!-- IMMEDIATE THEME INIT (PREVENTS FLASH) -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const isDark = savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>

    <!-- FIREBASE & AUTH GUARD -->
    <script type="module">
        import { auth, db } from "./firebase-config.js";
        
        import { 
            onAuthStateChanged, 
            signOut, 
            sendPasswordResetEmail
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Exports
        window.auth = auth;
        window.db = db;
        
        // AUTH ACTIONS
        window.logout = () => { 
            if(window.showConfirmModal) {
                window.showConfirmModal(
                    "Sign Out", 
                    "Are you sure you want to sign out?", 
                    () => signOut(auth).then(() => window.location.href = 'index.html')
                );
            } else {
                if(confirm("Sign Out?")) signOut(auth).then(() => window.location.href = 'index.html');
            }
        };

        window.handleForgotPassword = async () => {
            const user = auth.currentUser;
            if (user && user.email) {
                try {
                    await sendPasswordResetEmail(auth, user.email);
                    window.showCustomAlert("Email Sent", `Password reset email sent to ${user.email}. Please check your inbox.`);
                } catch (e) {
                    window.showCustomAlert("Error", "Error sending email: " + e.message);
                }
            }
        };

        window.saveProfileChanges = saveProfileChanges;
        window.handleDeleteAccount = handleDeleteAccount;

        // DATA SYNC LOGIC (CONFLICT RESOLUTION)
        window.saveData = async () => {
            // Update timestamp first to claim this version is "newest"
            window.state.lastUpdated = Date.now();
            localStorage.setItem('moneyFlowStateV3', JSON.stringify(window.state));
            
            const user = auth.currentUser;
            if (user) {
                try {
                    await setDoc(doc(db, 'artifacts', 'fundflow-default', 'users', user.uid, 'data', 'mainState'), window.state);
                    console.log("Cloud Save Success");
                } catch (e) { console.error("Cloud Save Error:", e); }
            }
        };

        // AUTH GUARD & DATA LOADER
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                console.log("Logged in:", user.email);
                if(window.updateUserProfileUI) window.updateUserProfileUI(user);

                try {
                    const docRef = doc(db, 'artifacts', 'fundflow-default', 'users', user.uid, 'data', 'mainState');
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const cloudData = docSnap.data();
                        const localData = window.state || {};
                        
                        const cloudTime = cloudData.lastUpdated || 0;
                        const localTime = localData.lastUpdated || 0;

                        const isLocalEmpty = (!localData.accounts || localData.accounts.length === 0) && 
                                             (!localData.expenses || localData.expenses.length === 0);
                        
                        const isCloudHasData = (cloudData.accounts && cloudData.accounts.length > 0);

                        if (isLocalEmpty && isCloudHasData) {
                             console.log("Sync: Local is empty. Force pulling from Cloud.");
                             window.state = { ...cloudData };
                             localStorage.setItem('moneyFlowStateV3', JSON.stringify(window.state));
                        } else if (cloudTime > localTime) {
                            console.log("Sync: Cloud is newer. Updating local.");
                            window.state = { ...window.state, ...cloudData };
                            localStorage.setItem('moneyFlowStateV3', JSON.stringify(window.state));
                        } else if (localTime > cloudTime) {
                            console.log("Sync: Local is newer. Pushing to cloud.");
                            window.saveData(); 
                        } else {
                            if(!window.state || Object.keys(window.state).length === 0) {
                                window.state = { ...cloudData };
                            }
                        }
                        
                        if(window.updateGreeting) window.updateGreeting(true, user);
                    } else {
                        if(!window.state) {
                            window.state = {
                                accounts: [], expenses: [], savings: [], allocations: [], 
                                transfers: [], savingsHistory: [], income: 0, lastUpdated: Date.now()
                            };
                        }
                        saveData(); 
                        if(window.updateGreeting) window.updateGreeting(false, user);
                    }
                    if(window.renderApp) window.renderApp();
                } catch (e) {
                    console.error("Sync Error:", e);
                }
            }
        });
    </script>
</head>
<!-- Removed 'transition-colors duration-300' to prevent black flash on load -->
<body class="bg-gray-100 dark:bg-gray-950 text-gray-900 dark:text-gray-100 flex justify-center min-h-screen p-2 text-[10px]">

    <div class="w-full max-w-6xl bg-white dark:bg-black min-h-[90vh] shadow-2xl relative border border-gray-200 dark:border-gray-800 rounded-3xl flex flex-col md:flex-row overflow-hidden my-auto z-10">
        
        <!-- SIDEBAR -->
        <aside class="w-full md:w-64 lg:w-72 bg-gray-50/80 dark:bg-gray-900/50 border-r border-gray-200 dark:border-gray-800 p-4 flex flex-col relative overflow-y-auto">
            
            <!-- HEADER -->
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <img src="images/fundflow-logo.png" alt="Logo" class="w-5 h-5 object-contain drop-shadow-sm hover:scale-105 transition-transform">
                    <div>
                        <h1 class="text-xs font-bold tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-blue-600">FUND FLOW</h1>
                        <p class="text-[7px] text-gray-500 uppercase tracking-widest leading-none">Finance Manager</p>
                    </div>
                </div>
                <div class="flex gap-1">
                    <button onclick="toggleTheme()" class="p-1.5 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-500 hover:text-cyan-500 transition-colors">
                         <i data-lucide="moon" class="icon-moon w-3 h-3 hidden"></i>
                         <i data-lucide="sun" class="icon-sun w-3 h-3 hidden"></i>
                    </button>
                    <!-- SETTINGS TOGGLE (Uses settings.js) -->
                    <button onclick="toggleSettings(true)" class="p-1.5 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-500 hover:text-cyan-500 transition-colors">
                        <i data-lucide="settings" class="w-3 h-3"></i>
                    </button>
                    <button onclick="logout()" class="p-1.5 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors" title="Sign Out">
                        <i data-lucide="log-out" class="w-3 h-3"></i>
                    </button>
                </div>
            </div>

             <!-- ADJUSTED SIDEBAR CARD TO MATCH SAVINGS.HTML (p-3) -->
             <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 rounded-xl p-3 border border-gray-200 dark:border-gray-700 shadow-sm relative overflow-hidden mb-3">
                <label class="text-gray-500 dark:text-gray-400 text-[9px] font-medium uppercase tracking-wider mb-0.5 block">Liquid Assets</label>
                <div class="flex items-center border-b border-gray-200 dark:border-gray-600 pb-1 mb-1">
                    <span id="total-assets-display" class="bg-transparent text-lg font-bold w-full focus:outline-none placeholder-gray-300 dark:placeholder-gray-700">₱0</span>
                </div>
                 <div class="flex justify-between items-center text-[9px] p-1.5 bg-gray-100 dark:bg-black/20 rounded-lg">
                    <span class="text-gray-500 dark:text-gray-400">Cash + Banks + Goals</span>
                </div>
            </div>

            <div class="flex-1">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-cyan-600 dark:text-cyan-400 text-[9px] font-bold flex items-center gap-1.5"><i data-lucide="activity" class="w-3 h-3"></i> Credit & Payables</h3>
                </div>
                <!-- Container for Credit Stats (Now a single card style) -->
                <div id="credit-stats-container" class="space-y-2"></div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 p-4 lg:p-6 overflow-y-auto pb-20 bg-white dark:bg-black relative">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-sm font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                        <i data-lucide="wallet" class="text-cyan-500 w-4 h-4"></i> 
                        <span>My Accounts</span>
                    </h2>
                    <!-- Added Description -->
                    <p class="text-[9px] text-gray-500 mt-0.5">Manage your bank accounts, wallets, and credit cards.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="openTransferModal()" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 text-[10px] font-bold p-1.5 px-2 rounded-lg flex items-center gap-1.5 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all" title="Transfer">
                        <i data-lucide="arrow-right-left" class="w-3 h-3"></i> 
                        <span class="hidden sm:inline">Transfer</span>
                    </button>
                    <button onclick="openAddAccountModal()" class="bg-gray-900 dark:bg-white text-white dark:text-black text-[10px] font-bold p-1.5 px-2 rounded-lg flex items-center gap-1.5 shadow-lg transition-all" title="Add Account">
                        <i data-lucide="plus" class="w-3 h-3"></i> 
                        <span class="hidden sm:inline">Add Account</span>
                    </button>
                </div>
            </div>
            
            <div class="space-y-6">
                <!-- Daily / Wallet Section -->
                <div>
                    <h3 class="text-[10px] font-bold text-gray-400 dark:text-gray-500 mb-2 uppercase tracking-wider flex items-center gap-1.5"><i data-lucide="banknote" class="w-3 h-3"></i> Daily / Wallet</h3>
                    <div id="accounts-daily-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"></div>
                </div>

                <!-- Savings Section -->
                <div>
                    <h3 class="text-[10px] font-bold text-gray-400 dark:text-gray-500 mb-2 uppercase tracking-wider flex items-center gap-1.5"><i data-lucide="piggy-bank" class="w-3 h-3"></i> Savings & Goals</h3>
                    <div id="accounts-savings-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"></div>
                </div>

                <!-- Credit Section -->
                <div>
                    <h3 class="text-[10px] font-bold text-gray-400 dark:text-gray-500 mb-2 uppercase tracking-wider flex items-center gap-1.5"><i data-lucide="credit-card" class="w-3 h-3"></i> Credit Cards & Loans</h3>
                    <div id="accounts-credit-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"></div>
                </div>
            </div>

            <!-- NAVBAR -->
            <div class="fixed bottom-14 left-0 right-0 md:left-56 lg:left-64 flex justify-center z-50 pointer-events-none">
                <nav class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl border border-gray-200 dark:border-gray-800 shadow-2xl rounded-full px-4 py-2 flex items-center gap-1 pointer-events-auto transition-all hover:scale-105">
                    <a href="dashboard.html" class="flex flex-col items-center justify-center w-10 h-9 rounded-xl text-gray-400 hover:text-cyan-600 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all">
                        <i data-lucide="layout-dashboard" class="w-3 h-3 mb-0.5"></i>
                        <span class="text-[7px] font-medium">Home</span>
                    </a>
                    <a href="budget.html" class="flex flex-col items-center justify-center w-10 h-9 rounded-xl text-gray-400 hover:text-cyan-600 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all">
                        <i data-lucide="pie-chart" class="w-3 h-3 mb-0.5"></i>
                        <span class="text-[7px] font-medium">Budget</span>
                    </a>
                    <a href="savings.html" class="flex flex-col items-center justify-center w-10 h-9 rounded-xl text-gray-400 hover:text-cyan-600 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all">
                        <i data-lucide="piggy-bank" class="w-3 h-3 mb-0.5"></i>
                        <span class="text-[7px] font-bold">Save</span>
                    </a>
                    <a href="accounts.html" class="flex flex-col items-center justify-center w-10 h-9 rounded-xl bg-cyan-50 dark:bg-cyan-900/20 text-cyan-600 dark:text-cyan-400 transition-all">
                        <i data-lucide="wallet" class="w-3 h-3 mb-0.5"></i>
                        <span class="text-[7px] font-medium">Wallet</span>
                    </a>
                </nav>
            </div>
        </main>
    </div>
    
    <!-- ACCOUNT DETAILS MODAL (Compact) -->
    <div id="account-details-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 w-full max-w-md rounded-2xl p-5 shadow-2xl animate-fade-in flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-3 pb-3 border-b border-gray-100 dark:border-gray-800">
                <div>
                    <h3 id="details-account-name" class="font-bold text-base text-gray-900 dark:text-white">Account Details</h3>
                    <p id="details-account-type" class="text-[10px] text-gray-500">Savings Account</p>
                </div>
                <div class="flex gap-2">
                    <button id="btn-edit-from-details" class="p-1.5 bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg text-gray-600 dark:text-gray-300 transition-colors">
                        <i data-lucide="edit-2" class="w-3.5 h-3.5"></i>
                    </button>
                    <button onclick="closeAccountDetailsModal()" class="text-gray-500 hover:text-gray-900 dark:hover:text-white transition-colors">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
            
            <div class="overflow-y-auto flex-1 pr-1 space-y-4">
                <div class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-900 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                    <span class="block text-[10px] text-gray-500 uppercase tracking-wider mb-0.5" id="details-balance-label">Current Balance</span>
                    <span id="details-account-balance" class="block text-2xl font-bold text-gray-900 dark:text-white tracking-tight">₱0.00</span>
                </div>

                <div id="details-credit-breakdown" class="hidden grid grid-cols-3 gap-2 text-center bg-gray-50 dark:bg-gray-800/50 rounded-xl p-2 border border-gray-200 dark:border-gray-800">
                    <div>
                        <span class="block text-[9px] text-gray-500 uppercase mb-0.5">Installment</span>
                        <span id="details-installment" class="text-xs font-bold text-gray-700 dark:text-gray-300 truncate block">₱0</span>
                    </div>
                    <div class="border-x border-gray-200 dark:border-gray-700">
                        <span class="block text-[9px] text-gray-500 uppercase mb-0.5">Current Bill</span>
                        <span id="details-current-bill" class="text-xs font-bold text-cyan-600 dark:text-cyan-400 truncate block">₱0</span>
                    </div>
                    <div>
                        <span class="block text-[9px] text-gray-500 uppercase mb-0.5">Upcoming</span>
                        <span id="details-upcoming" class="text-xs font-bold text-gray-700 dark:text-gray-300 truncate block">₱0</span>
                    </div>
                </div>

                <div>
                    <h4 class="text-[10px] font-bold text-gray-500 mb-2 flex items-center gap-1.5 uppercase tracking-wider"><i data-lucide="history" class="w-3 h-3"></i> Recent Transactions</h4>
                    <div id="account-history-list" class="space-y-1.5"></div>
                </div>
            </div>

            <div id="details-credit-actions" class="hidden mt-3 pt-3 border-t border-gray-100 dark:border-gray-800">
                <button onclick="closeAccountDetailsModal(); openInstallmentModal(currentViewingAccountId)" class="w-full bg-gray-900 dark:bg-white text-white dark:text-black font-bold py-2.5 rounded-xl text-xs hover:opacity-90 transition-opacity">Add Installment / Loan</button>
            </div>
        </div>
    </div>

    <!-- USER PROFILE / EDIT MODAL (Compact) -->
    <div id="user-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[110] flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 w-full max-w-sm rounded-2xl p-5 shadow-2xl animate-fade-in relative">
            <button onclick="document.getElementById('user-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 dark:hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
            
            <div class="flex flex-col items-center mb-4">
                <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-full flex items-center justify-center text-white text-lg font-bold mb-2 shadow-lg" id="profile-initial">U</div>
                <h3 class="text-base font-bold text-gray-900 dark:text-white" id="profile-name">User</h3>
                <p class="text-[10px] text-gray-500 dark:text-gray-400" id="profile-email">email@example.com</p>
            </div>

            <div class="space-y-3">
                <div>
                    <label class="block text-[10px] font-bold text-gray-500 dark:text-gray-400 mb-1 ml-1">Username</label>
                    <input type="text" id="edit-username" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-xs dark:text-white outline-none focus:border-cyan-500 transition-all">
                </div>

                <div>
                    <button type="button" onclick="document.getElementById('password-fields').classList.toggle('hidden')" class="text-[10px] font-bold text-cyan-600 dark:text-cyan-400 hover:underline flex items-center gap-1">
                        <i data-lucide="lock" class="w-3 h-3"></i> Change Password?
                    </button>
                    
                    <div id="password-fields" class="hidden mt-2 space-y-2 p-2 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-100 dark:border-gray-800">
                        <div>
                            <input type="password" id="edit-current-password" placeholder="Current Password" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-xs dark:text-white outline-none focus:border-red-500 transition-all">
                        </div>
                        <div>
                            <input type="password" id="edit-new-password" placeholder="New Password" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-xs dark:text-white outline-none focus:border-cyan-500 transition-all">
                        </div>
                        
                        <div class="pt-1 text-center">
                            <button type="button" onclick="handleForgotPassword()" class="text-[9px] text-gray-500 hover:text-cyan-500 hover:underline">
                                Forgot password? Send reset email
                            </button>
                        </div>
                    </div>
                </div>

                <button id="btn-save-profile" onclick="saveProfileChanges()" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2.5 rounded-xl text-xs flex items-center justify-center gap-2 transition-all shadow-lg shadow-cyan-500/20">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- ADD ACCOUNT MODAL (Compact) -->
    <div id="add-account-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[110] flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 w-full max-w-sm rounded-2xl p-4 shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-3">
                <h3 id="modal-account-title" class="font-bold text-base text-gray-900 dark:text-white">Add New Account</h3>
                <button onclick="closeAddAccountModal()" class="text-gray-500 hover:text-gray-900 dark:hover:text-white transition-colors">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1">Account Name</label>
                        <input type="text" id="new-account-name" placeholder="e.g. My BPI" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-xs dark:text-white outline-none focus:border-cyan-500">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1" id="balance-label">Current Balance</label>
                        <input type="number" id="new-account-balance" placeholder="0.00" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-xs dark:text-white outline-none focus:border-cyan-500">
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] text-gray-500 mb-1.5">Account Type (Tag)</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="account-tag" value="daily" class="peer sr-only">
                            <div class="text-center py-1.5 rounded-lg border border-gray-200 dark:border-gray-700 peer-checked:bg-green-100 peer-checked:border-green-500 peer-checked:text-green-700 dark:peer-checked:bg-green-900/30 dark:peer-checked:text-green-300 text-[10px] font-medium transition-all">
                                Daily
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="account-tag" value="savings" class="peer sr-only">
                            <div class="text-center py-1.5 rounded-lg border border-gray-200 dark:border-gray-700 peer-checked:bg-cyan-100 peer-checked:border-cyan-500 peer-checked:text-cyan-700 dark:peer-checked:bg-cyan-900/30 dark:peer-checked:text-cyan-300 text-[10px] font-medium transition-all">
                                Savings
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="account-tag" value="credit" class="peer sr-only">
                            <div class="text-center py-1.5 rounded-lg border border-gray-200 dark:border-gray-700 peer-checked:bg-red-100 peer-checked:border-red-500 peer-checked:text-red-700 dark:peer-checked:bg-red-900/30 dark:peer-checked:text-red-300 text-[10px] font-medium transition-all">
                                Credit
                            </div>
                        </label>
                    </div>
                </div>
                
                <div id="credit-fields" class="hidden space-y-2 pt-2 border-t border-gray-100 dark:border-gray-800">
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1">Credit Limit</label>
                        <input type="number" id="new-account-limit" placeholder="e.g. 30000" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-xs dark:text-white outline-none focus:border-cyan-500">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] text-gray-500 mb-1">Statement Day</label>
                            <input type="number" id="new-account-statement" placeholder="e.g. 5" min="1" max="31" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-xs dark:text-white outline-none focus:border-cyan-500">
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-500 mb-1">Due Day</label>
                            <input type="number" id="new-account-due" placeholder="e.g. 25" min="1" max="31" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-xs dark:text-white outline-none focus:border-cyan-500">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] text-gray-500 mb-1">Select Provider</label>
                    <input type="text" id="account-provider-search" oninput="renderAccountProviderGrid()" placeholder="Search..." class="w-full mb-2 bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-[10px] dark:text-white outline-none focus:border-cyan-500">
                    <div class="h-32 overflow-y-auto border border-gray-200 dark:border-gray-800 rounded-xl bg-gray-50/50 dark:bg-gray-900/50 p-1.5 custom-scrollbar">
                        <div id="account-provider-grid" class="grid grid-cols-2 gap-1.5"></div>
                    </div>
                </div>
                
                <div class="flex gap-2 pt-2 justify-end">
                    <button id="btn-save-account" onclick="submitNewAccount()" class="flex-1 bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2.5 rounded-xl text-xs">Save</button>
                    <button id="btn-delete-account" onclick="deleteCurrentAccount()" class="hidden p-2.5 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL HAS BEEN REMOVED AND MOVED TO settings.js -->

    <!-- OTHER MODALS (Transfer, Installment) - Compact -->
    <div id="transfer-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 w-full max-w-sm rounded-2xl p-5 shadow-2xl animate-fade-in flex flex-col h-auto">
            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-base dark:text-white">Transfer / Pay</h3><button onclick="closeTransferModal()" class="text-gray-500"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            
            <div class="space-y-3 relative">
                
                <div class="relative z-[50]">
                    <label class="block text-[10px] text-gray-500 mb-1 ml-1">From Account</label>
                    <div class="relative" id="transfer-from-container">
                        <button onclick="toggleDropdown('transfer-from')" id="transfer-from-btn" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-xl px-3 py-2.5 dark:text-white outline-none flex items-center justify-between cursor-pointer transition-all hover:border-cyan-500 relative text-left shadow-sm min-h-[44px] shadow-sm group">
                            <span class="text-gray-400 text-xs">Select Source</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400 pointer-events-none group-hover:text-cyan-500 transition-colors"></i>
                        </button>
                        <div id="transfer-from-dropdown" class="custom-dropdown-menu absolute left-0 right-0 top-[calc(100%+4px)] bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl max-h-56 overflow-y-auto hidden animate-fade-in w-full z-[60] p-1.5"></div>
                        <input type="hidden" id="transfer-from-value">
                    </div>
                </div>

                <div class="flex justify-center relative z-0 -my-2.5 pointer-events-none">
                    <div class="bg-gray-100 dark:bg-gray-800 p-1.5 rounded-full text-gray-400 dark:text-gray-500 shadow-sm border border-white dark:border-gray-700 relative z-10">
                        <i data-lucide="arrow-down" class="w-3 h-3"></i>
                    </div>
                </div>

                <div class="relative z-[40]">
                    <label class="block text-[10px] text-gray-500 mb-1 ml-1">To Account</label>
                    <div class="relative" id="transfer-to-container">
                        <button onclick="toggleDropdown('transfer-to')" id="transfer-to-btn" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-xl px-3 py-2.5 dark:text-white outline-none flex items-center justify-between cursor-pointer transition-all hover:border-cyan-500 relative text-left shadow-sm min-h-[44px] shadow-sm group">
                            <span class="text-gray-400 text-xs">Select Destination</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400 pointer-events-none group-hover:text-cyan-500 transition-colors"></i>
                        </button>
                        <div id="transfer-to-dropdown" class="custom-dropdown-menu absolute left-0 right-0 top-[calc(100%+4px)] bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl max-h-56 overflow-y-auto hidden animate-fade-in w-full z-[60] p-1.5"></div>
                        <input type="hidden" id="transfer-to-value">
                    </div>
                </div>

                <div class="relative z-10">
                    <label class="block text-[10px] text-gray-500 mb-1 ml-1">Amount to Transfer</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-400 font-bold text-xs">₱</span>
                        <input type="number" id="transfer-amount" placeholder="0.00" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-xl py-2.5 pl-6 pr-3 dark:text-white font-bold outline-none text-base focus:border-cyan-500 transition-all">
                    </div>
                    
                    <div id="transfer-smart-pay" class="hidden mt-2 flex gap-2 overflow-x-auto no-scrollbar">
                         <button id="btn-pay-full" class="whitespace-nowrap px-2 py-1 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-[10px] font-bold rounded-lg border border-red-100 dark:border-red-800 hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors flex items-center gap-1">
                            Pay Full Balance <span id="val-pay-full" class="font-normal opacity-80">(₱0)</span>
                         </button>
                    </div>
                </div>
            </div>

            <div class="pt-4 relative z-0">
                <button onclick="submitTransfer()" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-cyan-500/20 transition-all active:scale-[0.98] text-xs">Confirm Transfer</button>
            </div>
        </div>
    </div>

    <div id="installment-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 w-full max-w-sm rounded-2xl p-5 shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-base dark:text-white">Add Installment</h3><button onclick="closeInstallmentModal()" class="text-gray-500"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            
            <p class="text-[10px] text-gray-500 mb-4">Record a new loan or installment plan for this account.</p>

            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1">Principal Amount</label>
                        <input type="number" id="install-amount" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2.5 dark:text-white font-bold outline-none focus:border-cyan-500 text-xs" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1">Total Interest</label>
                        <input type="number" id="install-interest" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2.5 dark:text-white font-bold outline-none focus:border-cyan-500 text-xs" placeholder="0.00">
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] text-gray-500 mb-1">Terms</label>
                    <select id="install-terms" onchange="calculateInstallment()" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2.5 dark:text-white outline-none focus:border-cyan-500 text-xs">
                        <option value="1">1 Month (Next Billing)</option>
                        <option value="3">3 Months</option>
                        <option value="6">6 Months</option>
                        <option value="9">9 Months</option>
                        <option value="12">12 Months</option>
                        <option value="18">18 Months</option>
                        <option value="24">24 Months</option>
                    </select>
                </div>
                <div><label class="block text-[10px] text-gray-500 mb-1">Start Date</label><input type="date" id="install-date" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2.5 dark:text-white outline-none cursor-pointer focus:border-cyan-500 text-xs"></div>
                <div class="p-2.5 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-800 text-blue-700 dark:text-blue-300 text-[10px]">
                    Monthly Payment: <span id="install-monthly-display" class="font-bold">₱0.00</span>
                </div>
                <button onclick="submitInstallmentPlan()" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2.5 rounded-xl text-xs">Create Plan</button>
            </div>
        </div>
    </div>

    <!-- LINK SHARED SCRIPT -->
    <script src="script.js"></script>
    <script src="settings.js"></script>
    <script>
        // Exposed Functions for this page
        window.renderApp = renderApp;
        window.openAddAccountModal = openAddAccountModal;
        window.closeAddAccountModal = closeAddAccountModal;
        window.openEditAccountModal = openEditAccountModal;
        window.submitNewAccount = submitNewAccount;
        window.deleteCurrentAccount = deleteCurrentAccount;
        window.renderAccountProviderGrid = renderAccountProviderGrid;
        window.openTransferModal = openTransferModal;
        window.closeTransferModal = closeTransferModal;
        window.submitTransfer = submitTransfer;
        window.openAccountDetails = openAccountDetails;
        window.closeAccountDetailsModal = closeAccountDetailsModal;

        // Custom Dropdown Functions
        window.toggleDropdown = toggleDropdown;
        window.selectOption = selectOption;

        // Installment/Bill Functions
        window.openInstallmentModal = openInstallmentModal;
        window.closeInstallmentModal = closeInstallmentModal;
        window.submitInstallmentPlan = submitInstallmentPlan;
        window.calculateInstallment = calculateInstallment;
        window.deleteTransaction = deleteTransaction; 

        let selectedAccountProviderId = null; 
        let editingId = null;
        let installmentAccountId = null;
        let currentViewingAccountId = null;

        document.addEventListener('DOMContentLoaded', () => {
            try {
                loadState(); 
                initTheme();
                
                // Init Transfers if missing
                if(!state.transfers) state.transfers = [];

                // Toggle Credit Fields based on Tag
                const radios = document.getElementsByName('account-tag');
                radios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const creditFields = document.getElementById('credit-fields');
                        const balanceLabel = document.getElementById('balance-label');
                        if (e.target.value === 'credit') {
                            creditFields.classList.remove('hidden');
                            balanceLabel.innerText = 'Outstanding Balance (Debt)';
                            balanceLabel.classList.add('text-red-500');
                        } else {
                            creditFields.classList.add('hidden');
                            balanceLabel.innerText = 'Current Balance';
                            balanceLabel.classList.remove('text-red-500');
                        }
                    });
                });

                // Close dropdowns on click outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.relative')) {
                        document.querySelectorAll('.custom-dropdown-menu').forEach(d => d.classList.add('hidden'));
                    }
                });

                renderApp();
            } catch (e) { console.error("Init error:", e); }
        });

        /* --- RENDERERS --- */
        function renderApp() {
            renderAccounts(); 
            updateTotals();
            renderCreditStats();
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // --- UPDATED: CREDIT STATS TO MATCH SAVINGS STYLE ---
        function renderCreditStats() {
            const container = document.getElementById('credit-stats-container');
            if(!container) return;
            container.innerHTML = '';

            // 1. Calculate Stats
            const creditAccounts = state.accounts.filter(a => a.tag === 'credit');
            const totalDebt = creditAccounts.reduce((acc, curr) => acc + curr.balance, 0);
            const totalLimit = creditAccounts.reduce((acc, curr) => acc + (curr.creditLimit || 0), 0);
            
            let utilization = 0;
            if (totalLimit > 0) {
                utilization = (totalDebt / totalLimit) * 100;
            }

            const now = new Date();
            const oneMonth = new Date(); oneMonth.setMonth(now.getMonth() + 1);
            let monthlyDue = 0;

            state.expenses.forEach(exp => {
                const d = new Date(exp.id);
                if (d > now && d <= oneMonth) monthlyDue += exp.amount;
            });

            // NEW: Unified Card Style (Matching Total Savings in Savings.html)
            container.innerHTML = `
                <div class="bg-gradient-to-br from-red-50 to-orange-50 dark:from-red-900/20 dark:to-orange-900/20 rounded-xl p-3 border border-red-100 dark:border-red-900/30 shadow-sm relative overflow-hidden mb-3">
                    <label class="text-red-600 dark:text-red-400 text-[9px] font-bold uppercase tracking-wider mb-0.5 block flex items-center gap-1">
                        <i data-lucide="credit-card" class="w-3 h-3"></i> Total Debt
                    </label>
                    <div class="flex flex-col mb-2">
                        <span class="text-xl font-black text-gray-900 dark:text-white tracking-tight">₱${totalDebt.toLocaleString()}</span>
                        <span class="text-[9px] text-gray-500 dark:text-gray-400 font-medium">${utilization.toFixed(1)}% Credit Used</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-800 rounded-full h-1.5 overflow-hidden mb-1">
                        <div class="bg-gradient-to-r from-red-500 to-orange-600 h-1.5 rounded-full" style="width: ${utilization}%"></div>
                    </div>
                    <div class="flex justify-between items-center text-[9px] mt-1">
                        <span class="text-gray-400">Total Limit</span>
                        <span class="font-bold text-gray-600 dark:text-gray-300">₱${totalLimit.toLocaleString()}</span>
                    </div>
                </div>
                
                <div class="p-2 rounded-xl bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 text-center">
                    <span class="text-[8px] text-gray-500 uppercase">Est. Due This Month</span>
                    <span class="block text-xs font-bold text-red-600 dark:text-red-400 mt-0.5">₱${monthlyDue.toLocaleString()}</span>
                </div>
            `;
        }

        function renderAccountHistory(accountId) {
            const container = document.getElementById('account-history-list');
            if(!container) return;
            container.innerHTML = '';

            // 1. Get Expenses
            const expenses = state.expenses.filter(e => e.accountId == accountId).map(e => ({
                ...e,
                type: 'expense',
                label: e.note || 'Expense'
            }));

            // 2. Get Transfers
            const transfers = (state.transfers || []).filter(t => t.from == accountId || t.to == accountId).map(t => {
                const isOut = t.from == accountId;
                const otherId = isOut ? t.to : t.from;
                const otherAcc = state.accounts.find(a => a.id == otherId);
                return {
                    id: t.id,
                    amount: t.amount,
                    date: t.date || new Date(t.id).toISOString(),
                    type: isOut ? 'transfer_out' : 'transfer_in',
                    label: isOut ? `Transfer to ${otherAcc?.name || 'Unknown'}` : `Transfer from ${otherAcc?.name || 'Unknown'}`
                };
            });

            // Merge & Sort
            const allTx = [...expenses, ...transfers].sort((a,b) => {
                const dA = new Date(a.date || a.id).getTime();
                const dB = new Date(b.date || b.id).getTime();
                return dB - dA;
            });

            if(allTx.length === 0) {
                container.innerHTML = '<div class="text-[10px] text-gray-400 text-center py-2">No transactions found</div>';
                return;
            }

            allTx.forEach(tx => {
                const dateObj = new Date(tx.date || tx.id);
                const dateStr = dateObj.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                
                let icon = 'receipt';
                let colorClass = 'text-gray-900 dark:text-white';
                let amountPrefix = '-';
                let bgClass = 'bg-gray-100 dark:bg-gray-700';
                let deleteType = 'expense';

                if(tx.type === 'transfer_in') {
                    icon = 'arrow-down-left';
                    colorClass = 'text-green-600 dark:text-green-400';
                    amountPrefix = '+';
                    bgClass = 'bg-green-100 dark:bg-green-900/20 text-green-600';
                    deleteType = 'transfer';
                } else if(tx.type === 'transfer_out') {
                    icon = 'arrow-up-right';
                    colorClass = 'text-blue-600 dark:text-blue-400';
                    bgClass = 'bg-blue-100 dark:bg-blue-900/20 text-blue-600';
                    deleteType = 'transfer';
                } else {
                    // Expense
                    colorClass = 'text-red-600 dark:text-red-400';
                    bgClass = 'bg-red-100 dark:bg-red-900/20 text-red-600';
                }

                container.insertAdjacentHTML('beforeend', `
                    <div class="flex justify-between items-center p-2 rounded-lg border border-gray-100 dark:border-gray-700/50 hover:bg-white dark:hover:bg-gray-700 transition-colors group">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <div class="w-5 h-5 rounded-md ${bgClass} flex items-center justify-center shrink-0"><i data-lucide="${icon}" class="w-3 h-3"></i></div>
                            <div class="overflow-hidden">
                                <span class="text-[10px] font-bold text-gray-700 dark:text-gray-300 truncate block">${tx.label}</span>
                                <span class="text-[8px] text-gray-400 block">${dateStr}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-bold font-mono ${colorClass}">${amountPrefix}₱${Number(tx.amount).toLocaleString()}</span>
                            <button onclick="deleteTransaction('${tx.id}', '${accountId}', '${deleteType}')" class="opacity-0 group-hover:opacity-100 p-1 hover:bg-red-100 dark:hover:bg-red-900/30 text-red-500 rounded transition-all"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                `);
            });
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        /* --- DELETE TRANSACTION LOGIC --- */
        function deleteTransaction(txId, currentAccountId, type) {
            showConfirmModal(
                "Delete Transaction?",
                "This will permanently delete the transaction and reverse its effect on your balance.",
                () => {
                    if (type === 'expense') {
                        const expense = state.expenses.find(e => e.id == txId);
                        if (expense) {
                            const acc = state.accounts.find(a => a.id == expense.accountId);
                            if (acc) {
                                // Reverse balance change
                                if (acc.tag === 'credit' || acc.type === 'credit') {
                                    // Expense increased debt, so deleting it reduces debt (balance)
                                    acc.balance -= expense.amount;
                                    
                                    // Reverse Interest if it was part of this expense
                                    if (expense.interestPortion) {
                                        acc.interestBalance = Math.max(0, (acc.interestBalance || 0) - expense.interestPortion);
                                    }
                                } else {
                                    // Expense reduced funds, so deleting it refunds it
                                    acc.balance += expense.amount;
                                }
                            }
                            state.expenses = state.expenses.filter(e => e.id != txId);
                        }
                    } else if (type === 'transfer') {
                        const transfer = state.transfers.find(t => t.id == txId);
                        if (transfer) {
                            const fromAcc = state.accounts.find(a => a.id == transfer.from);
                            const toAcc = state.accounts.find(a => a.id == transfer.to);
                            
                            // Revert From Account
                            if (fromAcc) {
                                if (fromAcc.tag === 'credit') fromAcc.balance -= transfer.amount; 
                                else fromAcc.balance += transfer.amount; 
                            }
                            
                            // Revert To Account
                            if (toAcc) {
                                if (toAcc.tag === 'credit') {
                                    toAcc.balance += transfer.amount;
                                } else {
                                    toAcc.balance -= transfer.amount;
                                }
                            }
                            state.transfers = state.transfers.filter(t => t.id != txId);
                        }
                    }
                    
                    saveData(); // Calls the robust sync saver
                    renderApp();
                    if(currentAccountId) openAccountDetails(currentAccountId); // Refresh modal if open
                }
            );
        }

        function updateTotals() {
            const elAssets = document.getElementById('total-assets-display');
            if(elAssets) {
                let liquid = 0;
                const savingsBySource = {};
                state.savings.forEach(goal => {
                    if (goal.includeInTotal) savingsBySource[goal.source] = (savingsBySource[goal.source] || 0) + Number(goal.current);
                });
                state.accounts.forEach(acc => {
                    if (acc.tag !== 'credit') { // Filter liquid assets
                        liquid += acc.balance + (savingsBySource[acc.providerId] || 0);
                    }
                });
                elAssets.innerText = `₱${liquid.toLocaleString()}`;
            }
        }

        function renderAccounts() {
            const dailyList = document.getElementById('accounts-daily-list');
            const savingsList = document.getElementById('accounts-savings-list');
            const creditList = document.getElementById('accounts-credit-list');
            
            const savingsBySource = {};
            state.savings.forEach(goal => {
                if (goal.includeInTotal) savingsBySource[goal.source] = (savingsBySource[goal.source] || 0) + Number(goal.current);
            });

            // UPDATED: Compact Card Function matching Savings.html size/style
            const createCard = (acc, isCredit = false) => {
                let provider = PROVIDERS.find(p => p.id === acc.providerId) || { color: 'bg-gray-600', icon: 'wallet' };
                const savingsHere = savingsBySource[acc.id] || 0; 
                
                if (isCredit) {
                    const limit = acc.creditLimit || 0;
                    const debt = acc.balance; 
                    const interestBal = acc.interestBalance || 0;
                    const principalDebt = Math.max(0, debt - interestBal);
                    const available = limit > 0 ? Math.max(0, limit - principalDebt) : 0;
                    
                    const todayTime = Date.now();
                    const futureExpenses = state.expenses.filter(e => e.accountId === acc.id && e.id > todayTime);
                    const installmentTotal = futureExpenses.reduce((sum, e) => sum + e.amount, 0);

                    const now = new Date();
                    const currentMonthExpenses = state.expenses.filter(e => {
                        if (e.accountId !== acc.id) return false;
                        const d = new Date(e.id);
                        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    });
                    const currentBill = currentMonthExpenses.reduce((sum, e) => sum + e.amount, 0);
                    const upcomingBill = Math.max(0, debt - currentBill);

                    const cardBg = "bg-gradient-to-br from-slate-900 to-black border-slate-800";

                    return `
                    <div onclick="openAccountDetails('${acc.id}')" class="relative group overflow-hidden rounded-2xl ${cardBg} p-3 border border-gray-700 shadow-sm cursor-pointer transition-all hover:scale-[1.01] hover:shadow-2xl hover:border-gray-500">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-lg ${provider.color} flex items-center justify-center text-white shadow-lg">
                                    <i data-lucide="${provider.icon}" class="w-4 h-4"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-white text-[10px] leading-tight">${acc.name}</h3>
                                    <span class="text-[8px] text-gray-400 uppercase tracking-wider">${provider.name}</span>
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); openTransferModal('${acc.id}')" class="bg-white/10 hover:bg-white/20 text-white text-[8px] font-bold py-1 px-2 rounded-full backdrop-blur-sm border border-white/10 transition-colors flex items-center gap-1">
                                Pay <i data-lucide="arrow-right" class="w-2.5 h-2.5"></i>
                            </button>
                        </div>

                        <div class="mb-2">
                            <span class="block text-[8px] text-gray-400 uppercase tracking-widest mb-0.5">Outstanding</span>
                            <span class="block text-lg font-mono font-bold text-white tracking-tight leading-none">₱${debt.toLocaleString()}</span>
                        </div>

                        <div class="grid grid-cols-3 gap-1 text-center w-full mb-2">
                            <div class="overflow-hidden">
                                <span class="block text-[7px] text-gray-500 uppercase mb-0.5 truncate">Installment</span>
                                <span class="text-[9px] font-bold text-gray-300 truncate block">₱${installmentTotal.toLocaleString()}</span>
                            </div>
                            <div class="border-x border-white/10 px-1 overflow-hidden">
                                <span class="block text-[7px] text-gray-500 uppercase mb-0.5 truncate">Bill</span>
                                <span class="text-[9px] font-bold text-white truncate block">₱${currentBill.toLocaleString()}</span>
                            </div>
                            <div class="overflow-hidden">
                                <span class="block text-[7px] text-gray-500 uppercase mb-0.5 truncate">Next</span>
                                <span class="text-[9px] font-bold text-gray-300 truncate block">₱${upcomingBill.toLocaleString()}</span>
                            </div>
                        </div>

                         <div class="pt-1.5 border-t border-white/10">
                             <div class="flex justify-between text-[7px] mb-0.5 text-gray-400">
                                 <span>L: ₱${limit.toLocaleString()}</span>
                                 <span>A: ₱${available.toLocaleString()}</span>
                             </div>
                             <div class="h-1 w-full bg-gray-800 rounded-full overflow-hidden">
                                 <div class="h-full bg-cyan-600" style="width: ${limit > 0 ? (principalDebt/limit)*100 : 0}%"></div>
                             </div>
                         </div>
                    </div>`;
                } 
                
                // Liquid Asset Logic (Compact Rounded-2xl matching Savings)
                else {
                    const total = acc.balance + savingsHere;
                    const hasInterest = provider.interest && provider.interest !== '0%';
                    const interestBadge = hasInterest 
                        ? `<span class="text-[7px] bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-1 py-0 rounded-full font-medium flex items-center gap-0.5 border border-green-200 dark:border-green-800"><i data-lucide="trending-up" class="w-2 h-2"></i> ${provider.interest}</span>` 
                        : '';

                    return `
                        <div onclick="openAccountDetails('${acc.id}')" class="group bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 p-3 rounded-2xl relative overflow-hidden cursor-pointer hover:border-cyan-500 transition-all shadow-sm hover:shadow-cyan-500/10">
                            
                            <div class="flex justify-between items-start mb-2 relative z-10">
                                <div class="flex items-center gap-2">
                                    <div class="w-8 h-8 rounded-lg ${provider.color} flex items-center justify-center text-white shadow-lg shadow-cyan-500/20">
                                        <i data-lucide="${provider.icon}" class="w-4 h-4"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-900 dark:text-white text-[10px]">${acc.name}</h3>
                                        <p class="text-[8px] text-gray-500">${provider.name}</p>
                                    </div>
                                </div>
                                ${interestBadge}
                            </div>

                            <div class="mb-2 relative z-10">
                                <span class="block text-[8px] text-gray-500 uppercase tracking-wider mb-0.5">Total Assets</span>
                                <span class="block text-lg font-bold text-gray-900 dark:text-white tracking-tight leading-none">₱${total.toLocaleString()}</span>
                            </div>

                            <div class="space-y-1 bg-gray-50 dark:bg-gray-800/50 rounded-lg p-1.5 border border-gray-100 dark:border-gray-800 relative z-10">
                                <div class="flex justify-between items-center text-[9px]">
                                    <span class="text-gray-500">Available</span>
                                    <span class="font-bold text-gray-700 dark:text-gray-300">₱${acc.balance.toLocaleString()}</span>
                                </div>
                                ${savingsHere > 0 ? `
                                <div class="flex justify-between items-center text-[9px] pt-0.5 border-t border-gray-200 dark:border-gray-700">
                                    <span class="text-orange-500 flex items-center gap-0.5"><i data-lucide="lock" class="w-2.5 h-2.5"></i> Locked</span>
                                    <span class="font-bold text-orange-600 dark:text-orange-400">₱${savingsHere.toLocaleString()}</span>
                                </div>` : ''}
                            </div>

                            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity z-20">
                                <button onclick="event.stopPropagation(); openTransferModal('${acc.id}')" class="p-1 bg-gray-100 dark:bg-gray-700 hover:bg-cyan-100 dark:hover:bg-cyan-900/30 text-gray-600 dark:text-gray-300 hover:text-cyan-600 dark:hover:text-cyan-400 rounded-md transition-colors shadow-sm" title="Transfer">
                                    <i data-lucide="arrow-right-left" class="w-3 h-3"></i>
                                </button>
                            </div>
                            
                            <div class="absolute -top-10 -right-10 w-24 h-24 bg-gray-5 dark:bg-gray-800/50 rounded-full blur-2xl pointer-events-none z-0"></div>
                        </div>`;
                }
            };

            if (dailyList && savingsList && creditList) {
                // Filter by Tag
                const banks = state.accounts.filter(a => a.tag === 'daily' || (!a.tag && a.type !== 'credit')); // Default to daily if no tag
                const savings = state.accounts.filter(a => a.tag === 'savings');
                const credits = state.accounts.filter(a => a.tag === 'credit');

                dailyList.innerHTML = banks.length ? banks.map(a => createCard(a, false)).join('') : '<div class="col-span-full text-center text-[10px] text-gray-400 py-4">No daily accounts</div>';
                savingsList.innerHTML = savings.length ? savings.map(a => createCard(a, false)).join('') : '<div class="col-span-full text-center text-[10px] text-gray-400 py-4">No savings accounts</div>';
                creditList.innerHTML = credits.length ? credits.map(a => createCard(a, true)).join('') : '<div class="col-span-full text-center text-[10px] text-gray-400 py-4">No credit accounts</div>';
            }
        }

        /* --- BILL / INSTALLMENT LOGIC --- */
        function openInstallmentModal(accId) {
            const acc = state.accounts.find(a => a.id === accId);
            if(!acc) return;
            installmentAccountId = accId;
            
            document.getElementById('install-amount').value = '';
            document.getElementById('install-interest').value = ''; 
            document.getElementById('install-date').value = new Date().toISOString().split('T')[0];
            
            const termSelect = document.getElementById('install-terms');
            if(termSelect) termSelect.value = "1";

            document.getElementById('installment-modal').classList.remove('hidden');
            calculateInstallment(); 
        }

        function closeInstallmentModal() {
            document.getElementById('installment-modal').classList.add('hidden');
        }

        function calculateInstallment() {
            const amount = Number(document.getElementById('install-amount').value);
            const interest = Number(document.getElementById('install-interest').value) || 0;
            const terms = Number(document.getElementById('install-terms').value);
            
            let monthly = 0;
            if (terms > 0) {
                monthly = (amount + interest) / terms;
            }
            document.getElementById('install-monthly-display').innerText = `₱${monthly.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        function submitInstallmentPlan() {
            const amount = Number(document.getElementById('install-amount').value);
            const interest = Number(document.getElementById('install-interest').value) || 0;
            const terms = Number(document.getElementById('install-terms').value);
            const dateVal = document.getElementById('install-date').value;
            
            if(!amount || !dateVal) return showCustomAlert("Error", "Please fill required fields");
            
            const startDate = new Date(dateVal);
            const monthlyAmount = (amount + interest) / terms;
            const monthlyInterest = interest / terms; 
            const accIndex = state.accounts.findIndex(a => a.id === installmentAccountId);
            const acc = state.accounts[accIndex];
            
            acc.balance += (amount + interest);
            acc.interestBalance = (acc.interestBalance || 0) + interest;

            for(let i = 0; i < terms; i++) {
                const dueDate = new Date(startDate);
                dueDate.setMonth(startDate.getMonth() + i);
                
                const noteLabel = terms === 1 ? `Bill/Loan - ${acc.name}` : `Installment (${i+1}/${terms}) - ${acc.name}`;

                state.expenses.push({
                    id: dueDate.getTime(), 
                    amount: monthlyAmount,
                    interestPortion: monthlyInterest, 
                    note: noteLabel,
                    accountId: installmentAccountId,
                    category: 'bills',
                    repeat: false
                });
            }
            
            closeInstallmentModal();
            saveData();
            renderApp();
            showCustomAlert("Success", `Plan created! Debt increased by ₱${(amount + interest).toLocaleString()}.`);
        }

        /* --- ACCOUNT DETAILS MODAL (View + History) --- */
        function openAccountDetails(id) {
            const acc = state.accounts.find(a => a.id === id);
            if (!acc) return;
            currentViewingAccountId = id;

            document.getElementById('details-account-name').innerText = acc.name;
            document.getElementById('details-account-type').innerText = acc.tag ? acc.tag.toUpperCase() : 'ACCOUNT';
            document.getElementById('details-account-balance').innerText = `₱${acc.balance.toLocaleString()}`;
            
            const editBtn = document.getElementById('btn-edit-from-details');
            editBtn.onclick = () => {
                closeAccountDetailsModal();
                openEditAccountModal(id);
            };

            const creditBreakdown = document.getElementById('details-credit-breakdown');
            const creditActions = document.getElementById('details-credit-actions');
            const balanceLabel = document.getElementById('details-balance-label');

            if (acc.tag === 'credit') {
                creditBreakdown.classList.remove('hidden');
                creditActions.classList.remove('hidden');
                balanceLabel.innerText = "Total Outstanding Balance";
                balanceLabel.classList.add('text-red-500');

                const todayTime = Date.now();
                const futureExpenses = state.expenses.filter(e => e.accountId === acc.id && e.id > todayTime);
                const installmentTotal = futureExpenses.reduce((sum, e) => sum + e.amount, 0);
                
                const now = new Date();
                const currentMonthExpenses = state.expenses.filter(e => {
                        if (e.accountId !== acc.id) return false;
                        const d = new Date(e.id);
                        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
                const currentBill = currentMonthExpenses.reduce((sum, e) => sum + e.amount, 0);
                
                const upcomingBill = Math.max(0, acc.balance - currentBill);

                document.getElementById('details-installment').innerText = `₱${installmentTotal.toLocaleString()}`;
                document.getElementById('details-current-bill').innerText = `₱${currentBill.toLocaleString()}`;
                document.getElementById('details-upcoming').innerText = `₱${upcomingBill.toLocaleString()}`;

            } else {
                creditBreakdown.classList.add('hidden');
                creditActions.classList.add('hidden');
                balanceLabel.innerText = "Current Balance";
                balanceLabel.classList.remove('text-red-500');
            }

            renderAccountHistory(id);
            document.getElementById('account-details-modal').classList.remove('hidden');
        }

        function closeAccountDetailsModal() {
            document.getElementById('account-details-modal').classList.add('hidden');
        }

        /* --- ADD/EDIT ACCOUNT MODAL (Form) --- */
        function openAddAccountModal() {
            editingId = null;
            const el = document.getElementById('add-account-modal');
            if(!el) return;
            document.getElementById('modal-account-title').innerText = "New Account";
            document.getElementById('new-account-name').value = '';
            document.getElementById('new-account-balance').value = '';
            document.getElementById('new-account-limit').value = '';
            document.getElementById('new-account-statement').value = '';
            document.getElementById('new-account-due').value = '';
            document.getElementById('account-provider-search').value = '';
            
            const radios = document.getElementsByName('account-tag');
            if(radios[0]) radios[0].checked = true;
            
            const creditFields = document.getElementById('credit-fields');
            creditFields.classList.add('hidden');
            
            document.getElementById('balance-label').innerText = 'Current Balance';
            document.getElementById('balance-label').classList.remove('text-red-500');

            document.getElementById('btn-delete-account').classList.add('hidden');
            
            selectedAccountProviderId = null;
            renderAccountProviderGrid();
            el.classList.remove('hidden');
        }

        function closeAddAccountModal() { const el = document.getElementById('add-account-modal'); if(el) el.classList.add('hidden'); }

        function openEditAccountModal(id) {
            const acc = state.accounts.find(a => a.id === id);
            const el = document.getElementById('add-account-modal');
            if (!acc || !el) return;
            editingId = id;
            document.getElementById('modal-account-title').innerText = "Edit Account";
            document.getElementById('new-account-name').value = acc.name;
            document.getElementById('new-account-balance').value = acc.balance;
            
            const radios = document.getElementsByName('account-tag');
            radios.forEach(r => {
                if(r.value === acc.tag) r.checked = true;
            });

            const creditFields = document.getElementById('credit-fields');
            const balanceLabel = document.getElementById('balance-label');
            
            if (acc.tag === 'credit') {
                creditFields.classList.remove('hidden');
                document.getElementById('new-account-limit').value = acc.creditLimit || '';
                document.getElementById('new-account-statement').value = acc.statementDate || '';
                document.getElementById('new-account-due').value = acc.dueDate || '';
                balanceLabel.innerText = 'Outstanding Balance (Debt)';
                balanceLabel.classList.add('text-red-500');
            } else {
                creditFields.classList.add('hidden');
                balanceLabel.innerText = 'Current Balance';
                balanceLabel.classList.remove('text-red-500');
            }

            document.getElementById('btn-delete-account').classList.remove('hidden');
            selectedAccountProviderId = acc.providerId;
            renderAccountProviderGrid();
            el.classList.remove('hidden');
        }

        // UPDATED: Compact 2-Column Grid for Providers (Icon + Name Only)
        function renderAccountProviderGrid() {
            const container = document.getElementById('account-provider-grid');
            if (!container) return;
            container.innerHTML = '';
            const search = document.getElementById('account-provider-search').value.toLowerCase();
            
            PROVIDERS.filter(p => p.name.toLowerCase().includes(search)).forEach(p => {
                const isSel = selectedAccountProviderId === p.id;
                container.insertAdjacentHTML('beforeend', `
                    <div onclick="selectedAccountProviderId='${p.id}'; renderAccountProviderGrid();" class="cursor-pointer flex items-center gap-2 p-2 rounded-lg border transition-all ${isSel ? 'ring-1 ring-cyan-500 bg-cyan-50 dark:bg-cyan-900/20 border-cyan-500' : 'border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800'}">
                        <div class="w-6 h-6 rounded-md ${p.color} flex items-center justify-center text-white shrink-0 shadow-sm"><i data-lucide="${p.icon}" class="w-3.5 h-3.5"></i></div>
                        <span class="text-[10px] font-bold text-gray-700 dark:text-gray-300 truncate">${p.name}</span>
                    </div>
                `);
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function submitNewAccount() {
            const name = document.getElementById('new-account-name').value;
            const balance = Number(document.getElementById('new-account-balance').value);
            const limit = Number(document.getElementById('new-account-limit').value);
            const due = document.getElementById('new-account-due').value;
            const statement = document.getElementById('new-account-statement').value;
            
            let tag = 'savings';
            const radios = document.getElementsByName('account-tag');
            radios.forEach(r => { if(r.checked) tag = r.value; });

            if(!name || !selectedAccountProviderId) return showCustomAlert("Error", "Details required");
            
            const provider = PROVIDERS.find(p => p.id === selectedAccountProviderId);
            
            const data = { 
                id: editingId || Date.now().toString(), 
                name, 
                balance, 
                providerId: selectedAccountProviderId, 
                type: provider.type, 
                tag: tag, 
                creditLimit: tag === 'credit' ? limit : null,
                statementDate: tag === 'credit' ? statement : null,
                dueDate: tag === 'credit' ? due : null
            };

            if (editingId) {
                const idx = state.accounts.findIndex(x => x.id === editingId);
                if (idx !== -1) {
                        data.interestBalance = state.accounts[idx].interestBalance || 0;
                        state.accounts[idx] = data;
                }
            } else state.accounts.push(data);
            
            closeAddAccountModal();
            saveData(); 
            renderApp();
        }

        function deleteCurrentAccount() {
            if (editingId) {
                showConfirmModal(
                    "Delete Account?",
                    "Are you sure you want to delete this account? This cannot be undone.",
                    () => {
                        state.accounts = state.accounts.filter(x => x.id !== editingId);
                        closeAddAccountModal();
                        saveData();
                        renderApp();
                    }
                );
            }
        }

        /* --- TRANSFER CUSTOM DROPDOWN LOGIC --- */
        function toggleDropdown(id) {
            const dropdown = document.getElementById(`${id}-dropdown`);
            if(!dropdown) return;
            const isHidden = dropdown.classList.contains('hidden');
            
            document.querySelectorAll('.custom-dropdown-menu').forEach(d => d.classList.add('hidden'));
            
            if(isHidden) {
                renderDropdownOptions(id);
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        function renderDropdownOptions(targetId) {
            const container = document.getElementById(`${targetId}-dropdown`);
            if(!container) return;
            container.innerHTML = '';

            state.accounts.forEach(acc => {
                const provider = PROVIDERS.find(p => p.id === acc.providerId) || { color: 'bg-gray-600', icon: 'wallet' };
                
                container.insertAdjacentHTML('beforeend', `
                    <div onclick="selectOption('${targetId}', '${acc.id}')" class="custom-option group flex items-center justify-between my-1 flex items-center justify-between p-2 mb-1.5 last:mb-0 rounded-xl bg-gray-50 dark:bg-gray-800/50 border border-transparent hover:border-cyan-500 hover:bg-white dark:hover:bg-gray-800 cursor-pointer transition-all shadow-sm">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <div class="w-5 h-5 rounded-md ${provider.color} flex items-center justify-center text-white shrink-0">
                                <i data-lucide="${provider.icon}" class="w-3 h-3"></i>
                            </div>
                            <span class="text-xs font-medium text-gray-700 dark:text-gray-200 truncate group-hover:text-cyan-600 dark:group-hover:text-cyan-400">${acc.name}</span>
                        </div>
                        <span class="text-[10px] font-mono text-gray-500 whitespace-nowrap">₱${acc.balance.toLocaleString()}</span>
                    </div>
                `);
            });
            
            if(state.accounts.length === 0) {
                    container.innerHTML = '<div class="p-4 text-center text-[10px] text-gray-400">No accounts found.</div>';
            }
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function selectOption(targetId, accId) {
            const acc = state.accounts.find(a => a.id === accId);
            if(!acc) return;
            const provider = PROVIDERS.find(p => p.id === acc.providerId) || { color: 'bg-gray-600', icon: 'wallet' };

            document.getElementById(`${targetId}-value`).value = accId;

            const btn = document.getElementById(`${targetId}-btn`);
            btn.innerHTML = `
                <div class="flex items-center gap-2 w-full overflow-hidden">
                    <div class="w-5 h-5 rounded-md ${provider.color} flex items-center justify-center text-white shrink-0">
                        <i data-lucide="${provider.icon}" class="w-3 h-3"></i>
                    </div>
                    <span class="block text-xs font-bold text-gray-900 dark:text-white truncate flex-1 text-left">${acc.name}</span>
                    <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400 shrink-0 ml-auto"></i>
                </div>
            `;
            
            document.getElementById(`${targetId}-dropdown`).classList.add('hidden');
            
            if (targetId === 'transfer-to') {
                checkSmartPayLogic(accId);
            }

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function checkSmartPayLogic(toAccountId) {
            const acc = state.accounts.find(a => a.id === toAccountId);
            const smartPayContainer = document.getElementById('transfer-smart-pay');
            const amountInput = document.getElementById('transfer-amount');
            
            if (acc && acc.tag === 'credit') {
                const now = new Date();
                const currentMonthExpenses = state.expenses.filter(e => {
                        if (e.accountId !== acc.id) return false;
                        const d = new Date(e.id);
                        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
                const currentBill = currentMonthExpenses.reduce((sum, e) => sum + e.amount, 0);
                
                smartPayContainer.classList.remove('hidden');
                
                const suggestAmount = currentBill > 0 ? currentBill : acc.balance;
                amountInput.value = suggestAmount;

                const btnPayFull = document.getElementById('btn-pay-full');
                document.getElementById('val-pay-full').innerText = `(₱${acc.balance.toLocaleString()})`;
                
                btnPayFull.onclick = () => {
                    amountInput.value = acc.balance;
                };

            } else {
                smartPayContainer.classList.add('hidden');
                amountInput.value = '';
            }
        }

        function openTransferModal(targetId = null) {
            if (state.accounts.length < 2) return showCustomAlert("Error", "Need 2 accounts to transfer");
            
            const el = document.getElementById('transfer-modal');
            if(!el) return;
            
            document.getElementById('transfer-from-value').value = '';
            document.getElementById('transfer-to-value').value = '';
            document.getElementById('transfer-amount').value = '';
            document.getElementById('transfer-smart-pay').classList.add('hidden');
            
            const defaultContent = `
                <div class="flex items-center justify-between w-full">
                    <span class="text-gray-400 text-xs">Select Account</span>
                    <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                </div>`;
                
            document.getElementById('transfer-from-btn').innerHTML = defaultContent;
            document.getElementById('transfer-to-btn').innerHTML = defaultContent;

            if (targetId) {
                selectOption('transfer-to', targetId);
                const likelySource = state.accounts.find(a => a.tag !== 'credit' && a.id !== targetId);
                if (likelySource) selectOption('transfer-from', likelySource.id);
            }

            el.classList.remove('hidden');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function closeTransferModal() { const el = document.getElementById('transfer-modal'); if(el) el.classList.add('hidden'); }

        function submitTransfer() {
            const fromId = document.getElementById('transfer-from-value').value;
            const toId = document.getElementById('transfer-to-value').value;
            const amount = Number(document.getElementById('transfer-amount').value);
            
            if (!fromId || !toId) return showCustomAlert("Error", "Select both accounts");
            if (fromId === toId) return showCustomAlert("Error", "Same account selected");
            if (!amount || amount <= 0) return showCustomAlert("Error", "Invalid amount");

            const from = state.accounts.find(a => a.id == fromId);
            const to = state.accounts.find(a => a.id == toId);
            
            if (from.tag !== 'credit' && from.balance < amount) return showCustomAlert("Error", "Insufficient funds");
            
            const transferRecord = {
                id: Date.now(),
                from: fromId,
                to: toId,
                amount: amount,
                date: new Date().toISOString()
            };
            
            if(!state.transfers) state.transfers = [];
            state.transfers.push(transferRecord);

            if (from.tag === 'credit') {
                from.balance += amount; 
            } else {
                from.balance -= amount; 
            }
            
            if (to.tag === 'credit') {
                to.balance -= amount; 
            } else {
                to.balance += amount; 
            }
            
            closeTransferModal();
            saveData();
            renderApp();
            showCustomAlert("Success", "Transfer complete");
        }
    </script>
</body>
</html>