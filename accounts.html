<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund Flow - Accounts</title>
    <link id="favicon" rel="icon" type="image/png" href="images/fundflow-logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <script>tailwind.config = { darkMode: 'class', theme: { extend: { colors: { dark: { bg: '#000000', card: '#111827' } }, fontFamily: { mono: ['Share Tech Mono', 'monospace'] } } } }</script>
    <style>
        body { font-family: 'Inter', sans-serif; } 
        ::-webkit-scrollbar { width: 4px; } 
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; } 
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; } 
        .hidden { display: none !important; } 
        .no-scrollbar::-webkit-scrollbar { display: none; } 
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.2em 1.2em;
        }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #E5E7EB; border-radius: 10px; }
        .dark .custom-scroll::-webkit-scrollbar-thumb { background: #374151; }
        /* Card Gradient */
        .card-gradient { background: linear-gradient(135deg, #1f2937 0%, #111827 100%); }
        .card-shine { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(125deg, rgba(255,255,255,0) 30%, rgba(255,255,255,0.05) 40%, rgba(255,255,255,0) 50%); pointer-events: none; }
    </style>

    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const isDark = savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>

    <script type="module">
        import { auth, db } from "./firebase-config.js";
        import { onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.auth = auth;
        window.db = db;
        
        // Initialize Empty State Globally to avoid crashes
        window.state = {
            accounts: [], expenses: [], savings: [], allocations: [], 
            transfers: [], savingsHistory: [], income: 0,
            recurring: { enabled: true, amount: 0, frequency: 'weekly', day: 1, date: 1 },
            settings: { dashboardView: 'weekly' },
            lastUpdated: Date.now()
        };

        window.logout = () => { 
            if(window.showConfirmModal) {
                window.showConfirmModal("Sign Out", "Are you sure you want to sign out?", () => signOut(auth).then(() => {
                    localStorage.removeItem('moneyFlowStateV3');
                    window.location.href = 'index.html';
                }));
            } else {
                if(confirm("Sign Out?")) {
                    localStorage.removeItem('moneyFlowStateV3');
                    signOut(auth).then(() => window.location.href = 'index.html');
                }
            }
        };

        window.handleForgotPassword = async () => {
            const user = auth.currentUser;
            if (user && user.email) {
                try {
                    await sendPasswordResetEmail(auth, user.email);
                    window.showCustomAlert("Email Sent", `Password reset email sent to ${user.email}.`);
                } catch (e) { window.showCustomAlert("Error", "Error sending email: " + e.message); }
            }
        };

        window.saveProfileChanges = saveProfileChanges;
        window.handleDeleteAccount = handleDeleteAccount;

        // ROBUST DATA SYNC (Matched with Dashboard.html)
        window.saveData = async () => {
            if (!window.state) return;
            window.state.lastUpdated = Date.now();
            
            // Save locally
            localStorage.setItem('moneyFlowStateV3', JSON.stringify(window.state));
            
            const user = auth.currentUser;
            if (user) {
                try {
                    await setDoc(doc(db, 'artifacts', 'fundflow-default', 'users', user.uid, 'data', 'mainState'), window.state);
                } catch (e) { console.error("Cloud Save Error:", e); }
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                try {
                    // Load local first for speed
                    loadState(); 
                    if(window.renderApp) window.renderApp();

                    const docRef = doc(db, 'artifacts', 'fundflow-default', 'users', user.uid, 'data', 'mainState');
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        // EXISTING ACCOUNT: Check Timestamps to prevent overwrite
                        const cloudData = docSnap.data();
                        const localData = window.state || {};
                        
                        // Check if Cloud is newer than Local
                        if (cloudData.lastUpdated > (localData.lastUpdated || 0)) {
                            console.log("Sync: Cloud is newer. Updating local.");
                            window.state = { ...window.state, ...cloudData };
                            // Ensure transfers exists for older data
                            if (!window.state.transfers) window.state.transfers = [];
                            localStorage.setItem('moneyFlowStateV3', JSON.stringify(window.state));
                            if(window.renderApp) window.renderApp();
                        } else {
                            console.log("Sync: Local is newer or equal. Pushing to Cloud.");
                            window.saveData(); // Push local changes to cloud
                        }
                    } else {
                        // NEW ACCOUNT / GUEST: Start Fresh (Clean Slate)
                        console.log("Sync: New account detected. Initializing empty state.");
                        
                        if(!localStorage.getItem('moneyFlowStateV3')) {
                             window.state = {
                                accounts: [], expenses: [], savings: [], allocations: [], 
                                transfers: [], savingsHistory: [], income: 0, 
                                recurring: { enabled: true, amount: 0, frequency: 'weekly', day: 1, date: 1 },
                                settings: { dashboardView: 'weekly' },
                                lastUpdated: Date.now()
                            };
                        }
                        
                        await setDoc(docRef, window.state);
                        localStorage.setItem('moneyFlowStateV3', JSON.stringify(window.state));
                    }
                } catch (e) {
                    console.error("Sync Error:", e);
                }
            }
        });
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-950 text-gray-900 dark:text-gray-100 flex justify-center min-h-screen p-2 text-[10px]">

    <div class="w-full max-w-6xl bg-white dark:bg-black min-h-[90vh] shadow-2xl relative border border-gray-200 dark:border-gray-800 rounded-3xl flex flex-col md:flex-row overflow-hidden my-auto z-10">
        
        <aside class="w-full md:w-64 lg:w-72 bg-gray-50/80 dark:bg-gray-900/50 border-r border-gray-200 dark:border-gray-800 p-4 flex flex-col relative overflow-y-auto">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-2">
                    <img src="images/fundflow-logo.png" alt="Logo" class="w-5 h-5 object-contain drop-shadow-sm hover:scale-105 transition-transform">
                    <div>
                        <h1 class="text-xs font-bold tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-blue-600">FUND FLOW</h1>
                        <p class="text-[7px] text-gray-500 uppercase tracking-widest leading-none">Finance Manager</p>
                    </div>
                </div>
                <div class="flex gap-1">
                    <button onclick="toggleTheme()" class="p-1.5 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-500 hover:text-cyan-500 transition-colors">
                         <i data-lucide="moon" class="icon-moon w-3 h-3 hidden"></i>
                         <i data-lucide="sun" class="icon-sun w-3 h-3 hidden"></i>
                    </button>
                    <button onclick="toggleSettings(true)" class="p-1.5 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-500 hover:text-cyan-500 transition-colors">
                        <i data-lucide="settings" class="w-3 h-3"></i>
                    </button>
                    <button onclick="logout()" class="p-1.5 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors" title="Sign Out">
                        <i data-lucide="log-out" class="w-3 h-3"></i>
                    </button>
                </div>
            </div>

             <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 rounded-xl p-3 border border-gray-200 dark:border-gray-700 shadow-sm relative overflow-hidden mb-3">
                <label class="text-gray-500 dark:text-gray-400 text-[9px] font-medium uppercase tracking-wider mb-0.5 block">Liquid Assets</label>
                <div class="flex items-center border-b border-gray-200 dark:border-gray-600 pb-1 mb-1">
                    <span id="total-assets-display" class="bg-transparent text-lg font-bold w-full focus:outline-none placeholder-gray-300 dark:placeholder-gray-700">₱0</span>
                </div>
                 <div class="flex justify-between items-center text-[9px] p-1.5 bg-gray-100 dark:bg-black/20 rounded-lg">
                    <span class="text-gray-500 dark:text-gray-400">Cash + Banks + Goals</span>
                </div>
            </div>

            <div class="flex-1">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-cyan-600 dark:text-cyan-400 text-[9px] font-bold flex items-center gap-1.5"><i data-lucide="activity" class="w-3 h-3"></i> Credit & Payables</h3>
                </div>
                <div id="credit-stats-container" class="space-y-2"></div>
            </div>
        </aside>

        <main class="flex-1 p-4 lg:p-6 overflow-y-auto pb-20 bg-white dark:bg-black relative">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-sm font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                        <i data-lucide="wallet" class="text-cyan-500 w-4 h-4"></i> 
                        <span>My Accounts</span>
                    </h2>
                    <p class="text-[9px] text-gray-500 mt-0.5">Manage your bank accounts, wallets, and credit cards.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="openTransferModal()" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 text-[10px] font-bold p-1.5 px-2 rounded-lg flex items-center gap-1.5 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all" title="Transfer">
                        <i data-lucide="arrow-right-left" class="w-3 h-3"></i> 
                        <span class="hidden sm:inline">Transfer</span>
                    </button>
                    <button onclick="openAddAccountModal()" class="bg-gray-900 dark:bg-white text-white dark:text-black text-[10px] font-bold p-1.5 px-2 rounded-lg flex items-center gap-1.5 shadow-lg transition-all" title="Add Account">
                        <i data-lucide="plus" class="w-3 h-3"></i> 
                        <span class="hidden sm:inline">Add Account</span>
                    </button>
                </div>
            </div>
            
            <div class="space-y-6">
                <div>
                    <h3 class="text-[10px] font-bold text-gray-400 dark:text-gray-500 mb-2 uppercase tracking-wider flex items-center gap-1.5"><i data-lucide="banknote" class="w-3 h-3"></i> Daily / Wallet</h3>
                    <div id="accounts-daily-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"></div>
                </div>

                <div>
                    <h3 class="text-[10px] font-bold text-gray-400 dark:text-gray-500 mb-2 uppercase tracking-wider flex items-center gap-1.5"><i data-lucide="piggy-bank" class="w-3 h-3"></i> Savings & Goals</h3>
                    <div id="accounts-savings-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"></div>
                </div>

                <div>
                    <h3 class="text-[10px] font-bold text-gray-400 dark:text-gray-500 mb-2 uppercase tracking-wider flex items-center gap-1.5"><i data-lucide="credit-card" class="w-3 h-3"></i> Credit Cards & Loans</h3>
                    <div id="accounts-credit-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"></div>
                </div>
            </div>

            <div class="fixed bottom-14 left-0 right-0 md:left-64 lg:left-72 flex justify-center z-50 pointer-events-none">
                <nav class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl border border-gray-200 dark:border-gray-800 shadow-2xl rounded-full px-4 py-2 flex items-center gap-1 pointer-events-auto transition-all hover:scale-105">
                    <a href="dashboard.html" class="flex flex-col items-center justify-center w-12 h-10 rounded-xl text-gray-400 hover:text-cyan-600 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all">
                        <i data-lucide="layout-dashboard" class="w-3.5 h-3.5 mb-0.5"></i>
                        <span class="text-[8px] font-medium">Home</span>
                    </a>
                    <a href="budget.html" class="flex flex-col items-center justify-center w-12 h-10 rounded-xl text-gray-400 hover:text-cyan-600 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all">
                        <i data-lucide="pie-chart" class="w-3.5 h-3.5 mb-0.5"></i>
                        <span class="text-[8px] font-medium">Budget</span>
                    </a>
                    <a href="savings.html" class="flex flex-col items-center justify-center w-12 h-10 rounded-xl text-gray-400 hover:text-cyan-600 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all">
                        <i data-lucide="piggy-bank" class="w-3.5 h-3.5 mb-0.5"></i>
                        <span class="text-[8px] font-bold">Save</span>
                    </a>
                    <a href="accounts.html" class="flex flex-col items-center justify-center w-12 h-10 rounded-xl bg-cyan-50 dark:bg-cyan-900/20 text-cyan-600 dark:text-cyan-400 transition-all">
                        <i data-lucide="wallet" class="w-3.5 h-3.5 mb-0.5"></i>
                        <span class="text-[8px] font-medium">Wallet</span>
                    </a>
                </nav>
            </div>
        </main>
    </div>
    
    <div id="account-details-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 w-full max-w-sm rounded-2xl p-0 shadow-2xl animate-fade-in flex flex-col h-auto max-h-[85vh] overflow-hidden">
            
            <div id="details-hero-bg" class="relative p-5 pb-6">
                <!-- Virtual Card Container (Hidden for Credit Accounts) -->
                <div class="relative w-full aspect-[1.586/1] rounded-xl shadow-2xl overflow-hidden mb-4 transition-transform hover:scale-[1.02]" id="virtual-card-container">
                    <div class="absolute inset-0 bg-gradient-to-br from-gray-800 to-black z-0" id="virtual-card-bg"></div>
                    <div class="card-shine z-10"></div>
                    
                    <div class="relative z-20 h-full flex flex-col justify-between p-5">
                        <div class="flex justify-between items-start">
                            <div class="text-white font-bold tracking-wider text-xs uppercase opacity-90" id="card-provider-name">BANK</div>
                            <div class="text-white font-bold italic opacity-80 text-[10px]" id="card-type-label">DEBIT</div>
                        </div>
                        
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-6 bg-yellow-200 rounded-md opacity-80 flex items-center justify-center shadow-sm"><div class="w-4 h-4 border border-yellow-600 rounded-sm opacity-50"></div></div>
                            <i data-lucide="wifi" class="w-5 h-5 text-white/50 rotate-90"></i>
                        </div>

                        <div>
                            <p class="text-lg font-mono text-white tracking-widest shadow-black drop-shadow-md flex justify-between" id="card-number-display">•••• •••• •••• ••••</p>
                        </div>

                        <div class="flex justify-between items-end text-white">
                            <div>
                                <p class="text-[6px] text-gray-300 uppercase tracking-wider mb-0.5">Card Holder</p>
                                <p class="font-medium text-xs tracking-wide uppercase truncate max-w-[120px]" id="card-holder-name">User Name</p>
                            </div>
                            <div class="flex gap-4">
                                <div>
                                    <p class="text-[6px] text-gray-300 uppercase tracking-wider mb-0.5">Expires</p>
                                    <p class="font-mono text-[10px]" id="card-expiry-display">MM/YY</p>
                                </div>
                                <div>
                                    <p class="text-[6px] text-gray-300 uppercase tracking-wider mb-0.5">CVV</p>
                                    <p class="font-mono text-[10px]" id="card-cvv-display">•••</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center px-1 mt-2">
                    <div>
                        <span class="text-[10px] text-gray-500 dark:text-gray-400 uppercase tracking-wider block mb-0.5" id="details-balance-label">Current Balance</span>
                        <span id="details-account-balance" class="text-2xl font-bold text-gray-900 dark:text-white tracking-tight">₱0.00</span>
                    </div>
                    <button onclick="closeAccountDetailsModal()" class="p-2 bg-gray-100 dark:bg-gray-800 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-gray-500 dark:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>

                <div id="details-credit-progress" class="hidden mt-4 px-1">
                    <div class="flex justify-between text-gray-500 dark:text-gray-400 text-[9px] mb-1.5">
                        <span id="details-utilization-text">0% Used</span>
                        <span id="details-limit-text">Limit: ₱0</span>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-800 rounded-full h-2 overflow-hidden shadow-inner">
                        <div id="details-progress-bar" class="bg-gradient-to-r from-red-500 to-orange-500 h-2 rounded-full transition-all duration-700 shadow-md" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center border-b border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900 px-4 pt-3 pb-2">
                <span class="text-[10px] font-bold text-gray-500 uppercase tracking-wider flex items-center gap-1.5"><i data-lucide="history" class="w-3 h-3"></i> Recent Activity</span>
                <button id="btn-deposit-money" onclick="openDepositModal()" class="hidden text-[9px] font-bold text-green-600 bg-green-100 dark:bg-green-900/20 dark:text-green-400 px-2 py-1 rounded-lg flex items-center gap-1 hover:bg-green-200 dark:hover:bg-green-900/40 transition-all">
                    <i data-lucide="plus" class="w-3 h-3"></i> Deposit
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-4 bg-gray-50 dark:bg-black/20 custom-scroll relative">
                <div id="account-history-list" class="space-y-2"></div>
            </div>

            <div class="p-3 border-t border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900 grid gap-2" id="details-footer-actions"></div>
        </div>
    </div>

    <div id="deposit-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[150] flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 w-full max-w-sm rounded-2xl p-4 shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-base dark:text-white">Deposit Funds</h3>
                <button onclick="closeDepositModal()" class="text-gray-500"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] text-gray-500 mb-1">Amount</label>
                    <input type="number" id="deposit-amount" placeholder="0.00" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2.5 text-lg font-bold dark:text-white outline-none focus:border-green-500">
                </div>
                <div>
                    <label class="block text-[10px] text-gray-500 mb-1">Source / Note</label>
                    <input type="text" id="deposit-note" placeholder="e.g. Cash Deposit, Payroll" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-xs dark:text-white outline-none focus:border-green-500">
                </div>
                <button onclick="submitDeposit()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-xl shadow-lg transition-all text-xs">Confirm Deposit</button>
            </div>
        </div>
    </div>

    <div id="add-account-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[110] flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 w-full max-w-sm rounded-2xl p-4 shadow-2xl animate-fade-in flex flex-col h-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-3">
                <h3 id="modal-account-title" class="font-bold text-base text-gray-900 dark:text-white">Add New Account</h3>
                <button onclick="closeAddAccountModal()" class="text-gray-500 hover:text-gray-900 dark:hover:text-white transition-colors">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>
            
            <div class="overflow-y-auto pr-1 space-y-3 custom-scroll">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1">Account Name</label>
                        <input type="text" id="new-account-name" placeholder="e.g. My BPI" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-xs dark:text-white outline-none focus:border-cyan-500">
                    </div>
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1" id="balance-label">Current Balance</label>
                        <input type="number" id="new-account-balance" placeholder="0.00" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-xs dark:text-white outline-none focus:border-cyan-500">
                    </div>
                </div>

                <div id="account-details-fields" class="grid grid-cols-2 gap-3 p-2 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
                    <div class="col-span-2" id="account-number-container">
                        <label class="block text-[10px] text-gray-500 mb-1" id="acc-num-label">Account / Card Number</label>
                        <input type="text" id="new-account-number" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 16)" placeholder="10-16 digits" class="w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-xs dark:text-white outline-none focus:border-cyan-500 font-mono">
                    </div>
                    <div id="card-expiry-field">
                        <label class="block text-[10px] text-gray-500 mb-1">Expiry (MM/YY)</label>
                        <input type="text" id="new-account-expiry" placeholder="MM/YY" class="w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-xs dark:text-white outline-none focus:border-cyan-500 text-center">
                    </div>
                    <div id="card-cvv-field">
                        <label class="block text-[10px] text-gray-500 mb-1">CVV</label>
                        <input type="text" id="new-account-cvv" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,4)" placeholder="123" class="w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-xs dark:text-white outline-none focus:border-cyan-500 text-center">
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] text-gray-500 mb-1.5">Account Type (Tag)</label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="account-tag" value="daily" class="peer sr-only">
                            <div class="text-center py-1.5 rounded-lg border border-gray-200 dark:border-gray-700 peer-checked:bg-green-100 peer-checked:border-green-500 peer-checked:text-green-700 dark:peer-checked:bg-green-900/30 dark:peer-checked:text-green-300 text-[10px] font-medium transition-all">Daily</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="account-tag" value="savings" class="peer sr-only">
                            <div class="text-center py-1.5 rounded-lg border border-gray-200 dark:border-gray-700 peer-checked:bg-cyan-100 peer-checked:border-cyan-500 peer-checked:text-cyan-700 dark:peer-checked:bg-cyan-900/30 dark:peer-checked:text-cyan-300 text-[10px] font-medium transition-all">Savings</div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="account-tag" value="credit" class="peer sr-only">
                            <div class="text-center py-1.5 rounded-lg border border-gray-200 dark:border-gray-700 peer-checked:bg-red-100 peer-checked:border-red-500 peer-checked:text-red-700 dark:peer-checked:bg-red-900/30 dark:peer-checked:text-red-300 text-[10px] font-medium transition-all">Credit</div>
                        </label>
                    </div>
                </div>
                
                <div id="credit-fields" class="hidden space-y-2 pt-2 border-t border-gray-100 dark:border-gray-800">
                    <div>
                        <label class="block text-[10px] text-gray-500 mb-1">Credit Limit</label>
                        <input type="number" id="new-account-limit" placeholder="e.g. 30000" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-xs dark:text-white outline-none focus:border-cyan-500">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] text-gray-500 mb-1">Statement Day</label>
                            <input type="number" id="new-account-statement" placeholder="e.g. 5" min="1" max="31" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-xs dark:text-white outline-none focus:border-cyan-500">
                        </div>
                        <div>
                            <label class="block text-[10px] text-gray-500 mb-1">Due Day</label>
                            <input type="number" id="new-account-due" placeholder="e.g. 25" min="1" max="31" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-xs dark:text-white outline-none focus:border-cyan-500">
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-[10px] text-gray-500 mb-1">Provider</label>
                    <input type="text" id="account-provider-search" oninput="renderAccountProviderGrid()" placeholder="Search..." class="w-full mb-2 bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-[10px] dark:text-white outline-none focus:border-cyan-500">
                    <div class="h-24 overflow-y-auto border border-gray-200 dark:border-gray-800 rounded-xl bg-gray-50/50 dark:bg-gray-900/50 p-1.5 custom-scroll">
                        <div id="account-provider-grid" class="grid grid-cols-3 gap-1.5"></div>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-2 pt-3 mt-1 border-t border-gray-100 dark:border-gray-800 justify-end">
                <button id="btn-save-account" onclick="submitNewAccount()" class="flex-1 bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2.5 rounded-xl text-xs">Save</button>
                <button id="btn-delete-account" onclick="deleteCurrentAccount()" class="hidden p-2.5 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            </div>
        </div>
    </div>

    <div id="transfer-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 w-full max-w-sm rounded-2xl p-5 shadow-2xl animate-fade-in flex flex-col h-auto">
            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-base dark:text-white">Transfer / Pay</h3><button onclick="closeTransferModal()" class="text-gray-500"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="space-y-3 relative">
                <div class="relative z-[50]">
                    <label class="block text-[10px] text-gray-500 mb-1 ml-1">From Account</label>
                    <div class="relative" id="transfer-from-container">
                        <button onclick="toggleDropdown('transfer-from')" id="transfer-from-btn" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-xl px-3 py-2.5 dark:text-white outline-none flex items-center justify-between cursor-pointer transition-all hover:border-cyan-500 relative text-left shadow-sm min-h-[44px] shadow-sm group">
                            <span class="text-gray-400 text-xs">Select Source</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400 pointer-events-none group-hover:text-cyan-500 transition-colors"></i>
                        </button>
                        <div id="transfer-from-dropdown" class="custom-dropdown-menu absolute left-0 right-0 top-[calc(100%+4px)] bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl max-h-56 overflow-y-auto hidden animate-fade-in w-full z-[60] p-1.5"></div>
                        <input type="hidden" id="transfer-from-value">
                    </div>
                </div>
                <div class="flex justify-center relative z-0 -my-2.5 pointer-events-none">
                    <div class="bg-gray-100 dark:bg-gray-800 p-1.5 rounded-full text-gray-400 dark:text-gray-500 shadow-sm border border-white dark:border-gray-700 relative z-10"><i data-lucide="arrow-down" class="w-3 h-3"></i></div>
                </div>
                <div class="relative z-[40]">
                    <label class="block text-[10px] text-gray-500 mb-1 ml-1">To Account</label>
                    <div class="relative" id="transfer-to-container">
                        <button onclick="toggleDropdown('transfer-to')" id="transfer-to-btn" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-xl px-3 py-2.5 dark:text-white outline-none flex items-center justify-between cursor-pointer transition-all hover:border-cyan-500 relative text-left shadow-sm min-h-[44px] shadow-sm group">
                            <span class="text-gray-400 text-xs">Select Destination</span>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400 pointer-events-none group-hover:text-cyan-500 transition-colors"></i>
                        </button>
                        <div id="transfer-to-dropdown" class="custom-dropdown-menu absolute left-0 right-0 top-[calc(100%+4px)] bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl max-h-56 overflow-y-auto hidden animate-fade-in w-full z-[60] p-1.5"></div>
                        <input type="hidden" id="transfer-to-value">
                    </div>
                </div>
                <div class="relative z-10">
                    <label class="block text-[10px] text-gray-500 mb-1 ml-1">Amount to Transfer</label>
                    <div class="relative">
                        <span class="absolute left-3 top-3 text-gray-400 font-bold text-xs">₱</span>
                        <input type="number" id="transfer-amount" placeholder="0.00" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-xl py-2.5 pl-6 pr-3 dark:text-white font-bold outline-none text-base focus:border-cyan-500 transition-all">
                    </div>
                    <div id="transfer-smart-pay" class="hidden mt-2 flex gap-2 overflow-x-auto no-scrollbar">
                         <button id="btn-pay-full" class="whitespace-nowrap px-2 py-1 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-[10px] font-bold rounded-lg border border-red-100 dark:border-red-800 hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors flex items-center gap-1">Pay Full Balance <span id="val-pay-full" class="font-normal opacity-80">(₱0)</span></button>
                    </div>
                </div>
            </div>
            <div class="pt-4 relative z-0"><button onclick="submitTransfer()" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-cyan-500/20 transition-all active:scale-[0.98] text-xs">Confirm Transfer</button></div>
        </div>
    </div>

    <div id="installment-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 w-full max-w-sm rounded-2xl p-5 shadow-2xl animate-fade-in">
            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-base dark:text-white">Add Installment</h3><button onclick="closeInstallmentModal()" class="text-gray-500"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <p class="text-[10px] text-gray-500 mb-4">Record a new loan or installment plan for this account.</p>
            <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="block text-[10px] text-gray-500 mb-1">Principal Amount</label><input type="number" id="install-amount" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2.5 dark:text-white font-bold outline-none focus:border-cyan-500 text-xs" placeholder="0.00"></div>
                    <div><label class="block text-[10px] text-gray-500 mb-1">Total Interest</label><input type="number" id="install-interest" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2.5 dark:text-white font-bold outline-none focus:border-cyan-500 text-xs" placeholder="0.00"></div>
                </div>
                <div>
                    <label class="block text-[10px] text-gray-500 mb-1">Terms</label>
                    <select id="install-terms" onchange="calculateInstallment()" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2.5 dark:text-white outline-none focus:border-cyan-500 text-xs"><option value="1">1 Month (Next Billing)</option><option value="3">3 Months</option><option value="6">6 Months</option><option value="9">9 Months</option><option value="12">12 Months</option><option value="18">18 Months</option><option value="24">24 Months</option></select>
                </div>
                <div><label class="block text-[10px] text-gray-500 mb-1">Start Date</label><input type="date" id="install-date" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2.5 dark:text-white outline-none cursor-pointer focus:border-cyan-500 text-xs"></div>
                <div class="p-2.5 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-100 dark:border-blue-800 text-blue-700 dark:text-blue-300 text-[10px]">Monthly Payment: <span id="install-monthly-display" class="font-bold">₱0.00</span></div>
                <button onclick="submitInstallmentPlan()" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2.5 rounded-xl text-xs">Create Plan</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script src="settings.js"></script>
    <script>
        // Exposed Functions
        window.renderApp = renderApp;
        window.openAddAccountModal = openAddAccountModal;
        window.closeAddAccountModal = closeAddAccountModal;
        window.openEditAccountModal = openEditAccountModal;
        window.submitNewAccount = submitNewAccount;
        window.deleteCurrentAccount = deleteCurrentAccount;
        window.renderAccountProviderGrid = renderAccountProviderGrid;
        window.openTransferModal = openTransferModal;
        window.closeTransferModal = closeTransferModal;
        window.submitTransfer = submitTransfer;
        window.openAccountDetails = openAccountDetails;
        window.closeAccountDetailsModal = closeAccountDetailsModal;
        window.toggleDropdown = toggleDropdown;
        window.selectOption = selectOption;
        window.openInstallmentModal = openInstallmentModal;
        window.closeInstallmentModal = closeInstallmentModal;
        window.submitInstallmentPlan = submitInstallmentPlan;
        window.calculateInstallment = calculateInstallment;
        window.deleteTransaction = deleteTransaction; 
        // New Deposit Exports
        window.openDepositModal = openDepositModal;
        window.closeDepositModal = closeDepositModal;
        window.submitDeposit = submitDeposit;

        let selectedAccountProviderId = null; 
        let editingId = null;
        let installmentAccountId = null;
        let currentViewingAccountId = null;

        document.addEventListener('DOMContentLoaded', () => {
            try {
                loadState(); 
                initTheme();
                
                if(!state.accounts) state.accounts = [];
                if(!state.transfers) state.transfers = [];

                const radios = document.getElementsByName('account-tag');
                radios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        const creditFields = document.getElementById('credit-fields');
                        const balanceLabel = document.getElementById('balance-label');
                        const accNumLabel = document.getElementById('acc-num-label');
                        const accNumContainer = document.getElementById('account-number-container');
                        
                        // New: Virtual Card Field Hiding
                        const expiryField = document.getElementById('card-expiry-field');
                        const cvvField = document.getElementById('card-cvv-field');

                        if (e.target.value === 'credit') {
                            creditFields.classList.remove('hidden');
                            balanceLabel.innerText = 'Outstanding Balance (Debt)';
                            balanceLabel.classList.add('text-red-500');
                            accNumLabel.innerText = "Last 4 Digits";
                            
                            // Hide CVV/Expiry AND Account Number for Credit
                            accNumContainer.classList.add('hidden');
                            expiryField.classList.add('hidden');
                            cvvField.classList.add('hidden');
                        } else {
                            creditFields.classList.add('hidden');
                            balanceLabel.innerText = 'Current Balance';
                            balanceLabel.classList.remove('text-red-500');
                            accNumLabel.innerText = "Account Number";

                            // Show for others
                            accNumContainer.classList.remove('hidden');
                            expiryField.classList.remove('hidden');
                            cvvField.classList.remove('hidden');
                        }
                    });
                });

                // Auto-format Expiry Date
                const expiryInput = document.getElementById('new-account-expiry');
                if (expiryInput) {
                    expiryInput.addEventListener('input', function(e) {
                        let input = e.target.value.replace(/\D/g, ''); // Remove non-digits
                        if (input.length > 2) {
                            input = input.substring(0, 2) + '/' + input.substring(2, 4);
                        }
                        e.target.value = input.substring(0, 5); // Limit to MM/YY length
                    });
                }

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.relative')) {
                        document.querySelectorAll('.custom-dropdown-menu').forEach(d => d.classList.add('hidden'));
                    }
                });

                renderApp();
            } catch (e) { console.error("Init error:", e); }
        });

        /* --- RENDERERS --- */
        function renderApp() {
            renderAccounts(); 
            updateTotals();
            renderCreditStats();
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // --- NEW: CREDIT & PAYABLES STATS (SIDEBAR) ---
        function renderCreditStats() {
            const container = document.getElementById('credit-stats-container');
            if(!container) return;
            container.innerHTML = '';

            const creditAccounts = state.accounts.filter(a => a.tag === 'credit');
            const totalDebt = creditAccounts.reduce((acc, curr) => acc + curr.balance, 0);
            const totalLimit = creditAccounts.reduce((acc, curr) => acc + (curr.creditLimit || 0), 0);
            
            let utilization = 0;
            if (totalLimit > 0) utilization = (totalDebt / totalLimit) * 100;

            const now = new Date();
            const oneWeek = new Date(); oneWeek.setDate(now.getDate() + 7);
            const oneMonth = new Date(); oneMonth.setMonth(now.getMonth() + 1);

            let weeklyDue = 0;
            let monthlyDue = 0;
            let overdue = 0;

            state.expenses.forEach(exp => {
                const d = new Date(exp.id);
                if (d > now) {
                    if (d <= oneWeek) weeklyDue += exp.amount;
                    if (d <= oneMonth) monthlyDue += exp.amount;
                } else {
                    overdue += exp.amount;
                }
            });

            let insightTitle = "Good Payer";
            let insightMsg = "Keep it up!";
            let insightColor = "text-green-500";
            let insightBg = "bg-green-100 dark:bg-green-900/20";
            let icon = "thumbs-up";

            if (overdue > 0) {
                insightTitle = "Overdue Items";
                insightMsg = "You have past due bills.";
                insightColor = "text-red-500";
                insightBg = "bg-red-100 dark:bg-red-900/20";
                icon = "alert-circle";
            } else if (utilization > 80) {
                insightTitle = "High Usage";
                insightMsg = "Credit usage is high.";
                insightColor = "text-orange-500";
                insightBg = "bg-orange-100 dark:bg-orange-900/20";
                icon = "alert-triangle";
            } else if (utilization === 0 && totalDebt === 0) {
                 insightTitle = "Debt Free";
                 insightMsg = "No outstanding balances.";
                 icon = "check-circle";
            }

            container.insertAdjacentHTML('beforeend', `
                <div class="p-2 rounded-xl border border-gray-200 dark:border-gray-800 ${insightBg} flex items-center gap-2">
                    <div class="w-6 h-6 rounded-lg bg-white/50 dark:bg-black/20 flex items-center justify-center ${insightColor}">
                        <i data-lucide="${icon}" class="w-3 h-3"></i>
                    </div>
                    <div>
                        <h4 class="text-xs font-bold text-gray-900 dark:text-white">${insightTitle}</h4>
                        <p class="text-[9px] text-gray-500 dark:text-gray-400 leading-none">${insightMsg}</p>
                    </div>
                </div>
            `);

            container.insertAdjacentHTML('beforeend', `
                <div class="grid grid-cols-2 gap-1.5">
                    <div class="p-2 rounded-xl bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 text-center">
                        <span class="text-[8px] text-gray-500 uppercase">Due This Week</span>
                        <span class="block text-xs font-bold text-gray-900 dark:text-white mt-0.5">₱${weeklyDue.toLocaleString()}</span>
                    </div>
                    <div class="p-2 rounded-xl bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 text-center">
                        <span class="text-[8px] text-gray-500 uppercase">Due This Month</span>
                        <span class="block text-xs font-bold text-cyan-600 dark:text-cyan-400 mt-0.5">₱${monthlyDue.toLocaleString()}</span>
                    </div>
                </div>
            `);

            if (totalLimit > 0) {
                 container.insertAdjacentHTML('beforeend', `
                    <div class="p-2 rounded-xl bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800">
                        <div class="flex justify-between items-center mb-1.5">
                             <span class="text-[9px] font-bold text-gray-500 uppercase">Credit Utilization</span>
                             <span class="text-[9px] font-bold text-gray-900 dark:text-white">${utilization.toFixed(1)}%</span>
                        </div>
                        <div class="w-full bg-gray-100 dark:bg-gray-800 rounded-full h-1.5 overflow-hidden">
                            <div class="bg-gradient-to-r from-cyan-500 to-blue-600 h-1.5 rounded-full" style="width: ${utilization}%"></div>
                        </div>
                        <div class="flex justify-between mt-1 text-[8px] text-gray-400">
                            <span>Debt: ₱${totalDebt.toLocaleString()}</span>
                            <span>Limit: ₱${totalLimit.toLocaleString()}</span>
                        </div>
                    </div>
                `);
            }
        }

        function renderAccountHistory(accountId) {
            const container = document.getElementById('account-history-list');
            if(!container) return;
            container.innerHTML = '';

            const expenses = state.expenses.filter(e => e.accountId == accountId).map(e => ({
                ...e,
                type: 'expense',
                label: e.note || 'Expense'
            }));

            const transfers = (state.transfers || []).filter(t => t.from == accountId || t.to == accountId).map(t => {
                const isOut = t.from == accountId;
                
                // Handle External Deposits
                if (t.from === 'deposit_external' && !isOut) {
                     return {
                        id: t.id,
                        amount: t.amount,
                        date: t.date || new Date(t.id).toISOString(),
                        type: 'transfer_in',
                        label: `Deposit: ${t.note || 'Cash In'}`
                    };
                }

                const otherId = isOut ? t.to : t.from;
                const otherAcc = state.accounts.find(a => a.id == otherId);
                return {
                    id: t.id,
                    amount: t.amount,
                    date: t.date || new Date(t.id).toISOString(),
                    type: isOut ? 'transfer_out' : 'transfer_in',
                    label: isOut ? `Transfer to ${otherAcc?.name || 'Unknown'}` : `Transfer from ${otherAcc?.name || 'Unknown'}`
                };
            });

            const allTx = [...expenses, ...transfers].sort((a,b) => {
                const dA = new Date(a.date || a.id).getTime();
                const dB = new Date(b.date || b.id).getTime();
                return dB - dA;
            });

            if(allTx.length === 0) {
                container.innerHTML = '<div class="text-[10px] text-gray-400 text-center py-4">No recent transactions.</div>';
                return;
            }

            allTx.forEach(tx => {
                const dateObj = new Date(tx.date || tx.id);
                const dateStr = dateObj.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
                
                let icon = 'receipt';
                let colorClass = 'text-gray-900 dark:text-white';
                let amountPrefix = '-';
                let bgClass = 'bg-gray-100 dark:bg-gray-700';
                let deleteType = 'expense';

                if(tx.type === 'transfer_in') {
                    icon = 'arrow-down-left';
                    colorClass = 'text-green-600 dark:text-green-400';
                    amountPrefix = '+';
                    bgClass = 'bg-green-100 dark:bg-green-900/20 text-green-600';
                    deleteType = 'transfer';
                } else if(tx.type === 'transfer_out') {
                    icon = 'arrow-up-right';
                    colorClass = 'text-blue-600 dark:text-blue-400';
                    bgClass = 'bg-blue-100 dark:bg-blue-900/20 text-blue-600';
                    deleteType = 'transfer';
                } else {
                    colorClass = 'text-red-600 dark:text-red-400';
                    bgClass = 'bg-red-100 dark:bg-red-900/20 text-red-600';
                }

                container.insertAdjacentHTML('beforeend', `
                    <div class="flex justify-between items-center p-2 bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-xl group">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <div class="w-7 h-7 rounded-lg ${bgClass} flex items-center justify-center shrink-0"><i data-lucide="${icon}" class="w-3.5 h-3.5"></i></div>
                            <div class="overflow-hidden">
                                <span class="text-[10px] font-bold text-gray-700 dark:text-gray-200 truncate block">${tx.label}</span>
                                <span class="text-[8px] text-gray-400 block">${dateStr}</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-bold font-mono ${colorClass}">${amountPrefix}₱${Number(tx.amount).toLocaleString()}</span>
                            <button onclick="deleteTransaction('${tx.id}', '${accountId}', '${deleteType}')" class="opacity-0 group-hover:opacity-100 p-1 hover:bg-red-100 dark:hover:bg-red-900/30 text-red-500 rounded transition-all"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>
                    </div>
                `);
            });
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        /* --- DELETE TRANSACTION LOGIC --- */
        function deleteTransaction(txId, currentAccountId, type) {
            showConfirmModal(
                "Delete Transaction?",
                "This will permanently delete the transaction and reverse its effect on your balance.",
                () => {
                    if (type === 'expense') {
                        const expense = state.expenses.find(e => e.id == txId);
                        if (expense) {
                            const acc = state.accounts.find(a => a.id == expense.accountId);
                            if (acc) {
                                if (acc.tag === 'credit' || acc.type === 'credit') {
                                    acc.balance -= expense.amount;
                                    if (expense.interestPortion) {
                                        acc.interestBalance = Math.max(0, (acc.interestBalance || 0) - expense.interestPortion);
                                    }
                                } else {
                                    acc.balance += expense.amount;
                                }
                            }
                            state.expenses = state.expenses.filter(e => e.id != txId);
                        }
                    } else if (type === 'transfer') {
                        const transfer = state.transfers.find(t => t.id == txId);
                        if (transfer) {
                            if (transfer.from === 'deposit_external') {
                                // Reverse Deposit
                                const toAcc = state.accounts.find(a => a.id == transfer.to);
                                if (toAcc) {
                                    if (toAcc.tag === 'credit') {
                                        toAcc.balance -= transfer.amount;
                                    } else {
                                        toAcc.balance -= transfer.amount;
                                    }
                                }
                            } else {
                                // Normal Transfer
                                const fromAcc = state.accounts.find(a => a.id == transfer.from);
                                const toAcc = state.accounts.find(a => a.id == transfer.to);
                                
                                if (fromAcc) {
                                    if (fromAcc.tag === 'credit') fromAcc.balance -= transfer.amount; // Credit transfer out increases debt?
                                    else fromAcc.balance += transfer.amount; 
                                }
                                if (toAcc) {
                                    if (toAcc.tag === 'credit') toAcc.balance += transfer.amount;
                                    else toAcc.balance -= transfer.amount;
                                }
                            }
                            state.transfers = state.transfers.filter(t => t.id != txId);
                        }
                    }
                    saveData();
                    renderApp();
                    if(currentAccountId) openAccountDetails(currentAccountId); 
                }
            );
        }

        function updateTotals() {
            const elAssets = document.getElementById('total-assets-display');
            if(elAssets) {
                let liquid = 0;
                const savingsBySource = {};
                state.savings.forEach(goal => {
                    if (goal.includeInTotal) savingsBySource[goal.source] = (savingsBySource[goal.source] || 0) + Number(goal.current);
                });
                state.accounts.forEach(acc => {
                    if (acc.tag !== 'credit') { // Filter liquid assets
                        liquid += acc.balance + (savingsBySource[acc.providerId] || 0);
                    }
                });
                elAssets.innerText = `₱${liquid.toLocaleString()}`;
            }
        }

        function renderAccounts() {
            const dailyList = document.getElementById('accounts-daily-list');
            const savingsList = document.getElementById('accounts-savings-list');
            const creditList = document.getElementById('accounts-credit-list');
            
            const savingsBySource = {};
            state.savings.forEach(goal => {
                if (goal.includeInTotal) savingsBySource[goal.source] = (savingsBySource[goal.source] || 0) + Number(goal.current);
            });

            // Compact Card Function
            const createCard = (acc, isCredit = false) => {
                let provider = PROVIDERS.find(p => p.id === acc.providerId) || { color: 'bg-gray-600', icon: 'wallet' };
                const savingsHere = savingsBySource[acc.id] || 0; 
                
                if (isCredit) {
                    const limit = acc.creditLimit || 0;
                    const debt = acc.balance; 
                    const interestBal = acc.interestBalance || 0;
                    const principalDebt = Math.max(0, debt - interestBal);
                    const available = limit > 0 ? Math.max(0, limit - principalDebt) : 0;
                    
                    const todayTime = Date.now();
                    const futureExpenses = state.expenses.filter(e => e.accountId === acc.id && e.id > todayTime);
                    const installmentTotal = futureExpenses.reduce((sum, e) => sum + e.amount, 0);

                    const now = new Date();
                    const currentMonthExpenses = state.expenses.filter(e => {
                        if (e.accountId !== acc.id) return false;
                        const d = new Date(e.id);
                        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    });
                    const currentBill = currentMonthExpenses.reduce((sum, e) => sum + e.amount, 0);
                    const upcomingBill = Math.max(0, debt - currentBill);

                    const cardBg = "bg-gradient-to-br from-slate-900 to-black border-slate-800";

                    return `
                    <div onclick="openAccountDetails('${acc.id}')" class="relative group overflow-hidden rounded-xl ${cardBg} p-2.5 border border-gray-700 shadow-xl cursor-pointer transition-all hover:scale-[1.01] hover:shadow-2xl hover:border-gray-500">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center gap-1.5">
                                <div class="w-6 h-6 rounded-lg ${provider.color} flex items-center justify-center text-white shadow-lg">
                                    <i data-lucide="${provider.icon}" class="w-3 h-3"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-white text-[10px] leading-tight">${acc.name}</h3>
                                    <span class="text-[8px] text-gray-400 uppercase tracking-wider">${provider.name}</span>
                                </div>
                            </div>
                            <button onclick="event.stopPropagation(); openTransferModal('${acc.id}')" class="bg-white/10 hover:bg-white/20 text-white text-[8px] font-bold py-0.5 px-2 rounded-full backdrop-blur-sm border border-white/10 transition-colors flex items-center gap-1">
                                Pay <i data-lucide="arrow-right" class="w-2.5 h-2.5"></i>
                            </button>
                        </div>

                        <div class="mb-2">
                            <span class="block text-[8px] text-gray-400 uppercase tracking-widest mb-0.5">Outstanding</span>
                            <span class="block text-lg font-mono font-bold text-white tracking-tight leading-none">₱${debt.toLocaleString()}</span>
                        </div>

                        <div class="grid grid-cols-3 gap-1 text-center w-full mb-2">
                            <div class="overflow-hidden">
                                <span class="block text-[7px] text-gray-500 uppercase mb-0.5 truncate">Installment</span>
                                <span class="text-[9px] font-bold text-gray-300 truncate block">₱${installmentTotal.toLocaleString()}</span>
                            </div>
                            <div class="border-x border-white/10 px-1 overflow-hidden">
                                <span class="block text-[7px] text-gray-500 uppercase mb-0.5 truncate">Bill</span>
                                <span class="text-[9px] font-bold text-white truncate block">₱${currentBill.toLocaleString()}</span>
                            </div>
                            <div class="overflow-hidden">
                                <span class="block text-[7px] text-gray-500 uppercase mb-0.5 truncate">Next</span>
                                <span class="text-[9px] font-bold text-gray-300 truncate block">₱${upcomingBill.toLocaleString()}</span>
                            </div>
                        </div>

                         <div class="pt-1.5 border-t border-white/10">
                             <div class="flex justify-between text-[7px] mb-0.5 text-gray-400">
                                 <span>L: ₱${limit.toLocaleString()}</span>
                                 <span>A: ₱${available.toLocaleString()}</span>
                             </div>
                             <div class="h-1 w-full bg-gray-800 rounded-full overflow-hidden">
                                 <div class="h-full bg-cyan-600" style="width: ${limit > 0 ? (principalDebt/limit)*100 : 0}%"></div>
                             </div>
                         </div>
                        
                        <div class="absolute -bottom-10 -right-10 w-24 h-24 bg-white/5 rounded-full blur-xl pointer-events-none"></div>
                    </div>`;
                } 
                
                else {
                    const total = acc.balance + savingsHere;
                    const hasInterest = provider.interest && provider.interest !== '0%';
                    const interestBadge = hasInterest 
                        ? `<span class="text-[7px] bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 px-1 py-0 rounded-full font-medium flex items-center gap-0.5 border border-green-200 dark:border-green-800"><i data-lucide="trending-up" class="w-2 h-2"></i> ${provider.interest}</span>` 
                        : '';

                    return `
                        <div onclick="openAccountDetails('${acc.id}')" class="group bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 p-4 rounded-xl relative overflow-hidden cursor-pointer hover:border-cyan-500 transition-all shadow-sm hover:shadow-md">
                            
                            <div class="flex justify-between items-start mb-2 relative z-10">
                                <div class="flex items-center gap-1.5">
                                    <div class="w-6 h-6 rounded-lg ${provider.color} flex items-center justify-center text-white shadow-md">
                                        <i data-lucide="${provider.icon}" class="w-3 h-3"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-900 dark:text-white text-[10px]">${acc.name}</h3>
                                        <p class="text-[8px] text-gray-500">${provider.name}</p>
                                    </div>
                                </div>
                                ${interestBadge}
                            </div>

                            <div class="mb-2 relative z-10">
                                <span class="block text-[8px] text-gray-500 uppercase tracking-wider mb-0.5">Total Assets</span>
                                <span class="block text-lg font-bold text-gray-900 dark:text-white tracking-tight leading-none">₱${total.toLocaleString()}</span>
                            </div>

                            <div class="space-y-1 bg-gray-50 dark:bg-gray-800/50 rounded-lg p-1.5 border border-gray-100 dark:border-gray-800 relative z-10">
                                <div class="flex justify-between items-center text-[9px]">
                                    <span class="text-gray-500">Available</span>
                                    <span class="font-bold text-gray-700 dark:text-gray-300">₱${acc.balance.toLocaleString()}</span>
                                </div>
                                ${savingsHere > 0 ? `
                                <div class="flex justify-between items-center text-[9px] pt-0.5 border-t border-gray-200 dark:border-gray-700">
                                    <span class="text-orange-500 flex items-center gap-0.5"><i data-lucide="lock" class="w-2.5 h-2.5"></i> Locked</span>
                                    <span class="font-bold text-orange-600 dark:text-orange-400">₱${savingsHere.toLocaleString()}</span>
                                </div>` : ''}
                            </div>

                            <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity z-20">
                                <button onclick="event.stopPropagation(); openTransferModal('${acc.id}')" class="p-1 bg-gray-100 dark:bg-gray-700 hover:bg-cyan-100 dark:hover:bg-cyan-900/30 text-gray-600 dark:text-gray-300 hover:text-cyan-600 dark:hover:text-cyan-400 rounded-md transition-colors shadow-sm" title="Transfer">
                                    <i data-lucide="arrow-right-left" class="w-3 h-3"></i>
                                </button>
                            </div>
                            
                            <div class="absolute -top-10 -right-10 w-24 h-24 bg-gray-50 dark:bg-gray-800/50 rounded-full blur-2xl pointer-events-none z-0"></div>
                        </div>`;
                }
            };

            if (dailyList && savingsList && creditList) {
                const banks = state.accounts.filter(a => a.tag === 'daily' || (!a.tag && a.type !== 'credit')); 
                const savings = state.accounts.filter(a => a.tag === 'savings');
                const credits = state.accounts.filter(a => a.tag === 'credit');

                dailyList.innerHTML = banks.length ? banks.map(a => createCard(a, false)).join('') : '<div class="col-span-full text-center text-[10px] text-gray-400 py-4">No daily accounts</div>';
                savingsList.innerHTML = savings.length ? savings.map(a => createCard(a, false)).join('') : '<div class="col-span-full text-center text-[10px] text-gray-400 py-4">No savings accounts</div>';
                creditList.innerHTML = credits.length ? credits.map(a => createCard(a, true)).join('') : '<div class="col-span-full text-center text-[10px] text-gray-400 py-4">No credit accounts</div>';
            }
        }

        /* --- BILL / INSTALLMENT LOGIC --- */
        function openInstallmentModal(accId) {
            const acc = state.accounts.find(a => a.id === accId);
            if(!acc) return;
            installmentAccountId = accId;
            
            document.getElementById('install-amount').value = '';
            document.getElementById('install-interest').value = ''; 
            document.getElementById('install-date').value = new Date().toISOString().split('T')[0];
            
            const termSelect = document.getElementById('install-terms');
            if(termSelect) termSelect.value = "1";

            document.getElementById('installment-modal').classList.remove('hidden');
            calculateInstallment(); 
        }

        function closeInstallmentModal() {
            document.getElementById('installment-modal').classList.add('hidden');
        }

        function calculateInstallment() {
            const amount = Number(document.getElementById('install-amount').value);
            const interest = Number(document.getElementById('install-interest').value) || 0;
            const terms = Number(document.getElementById('install-terms').value);
            
            let monthly = 0;
            if (terms > 0) {
                monthly = (amount + interest) / terms;
            }
            document.getElementById('install-monthly-display').innerText = `₱${monthly.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
        }

        function submitInstallmentPlan() {
            const amount = Number(document.getElementById('install-amount').value);
            const interest = Number(document.getElementById('install-interest').value) || 0;
            const terms = Number(document.getElementById('install-terms').value);
            const dateVal = document.getElementById('install-date').value;
            
            if(!amount || !dateVal) return showCustomAlert("Error", "Please fill required fields");
            
            const startDate = new Date(dateVal);
            const monthlyAmount = (amount + interest) / terms;
            const monthlyInterest = interest / terms; 
            const accIndex = state.accounts.findIndex(a => a.id === installmentAccountId);
            const acc = state.accounts[accIndex];
            
            acc.balance += (amount + interest);
            acc.interestBalance = (acc.interestBalance || 0) + interest;

            for(let i = 0; i < terms; i++) {
                const dueDate = new Date(startDate);
                dueDate.setMonth(startDate.getMonth() + i);
                
                const noteLabel = terms === 1 ? `Bill/Loan - ${acc.name}` : `Installment (${i+1}/${terms}) - ${acc.name}`;

                state.expenses.push({
                    id: dueDate.getTime() + i, // Add tiny delay to id to ensure unique
                    amount: monthlyAmount,
                    interestPortion: monthlyInterest, 
                    note: noteLabel,
                    accountId: installmentAccountId,
                    category: 'bills',
                    repeat: false
                });
            }
            
            closeInstallmentModal();
            saveData();
            renderApp();
            showCustomAlert("Success", `Plan created! Debt increased by ₱${(amount + interest).toLocaleString()}.`);
        }

        /* --- ACCOUNT DETAILS MODAL (View + History) --- */
        function openAccountDetails(id) {
            const acc = state.accounts.find(a => a.id === id);
            if (!acc) return;
            currentViewingAccountId = id;

            // Common Values
            const provider = PROVIDERS.find(p => p.id === acc.providerId) || { name: 'Unknown', color: 'bg-gray-500', icon: 'wallet' };
            const balance = acc.balance;
            const num = acc.accountNumber || '•••• •••• •••• ••••';
            const displayNum = num.replace(/(.{4})/g, '$1 ').trim(); // Format as groups of 4
            
            const holder = (auth.currentUser.displayName || "CARD HOLDER").toUpperCase();
            const exp = acc.cardExpiry || 'MM/YY';
            const cvv = acc.cardCvv || '•••';
            
            const cardContainer = document.getElementById('virtual-card-container');

            // --- CHANGED: STRICT Hide Virtual Card if Credit ---
            if (acc.tag === 'credit') {
                cardContainer.classList.add('hidden');
            } else {
                cardContainer.classList.remove('hidden');

                // Populate Virtual Card
                document.getElementById('card-provider-name').innerText = provider.name.toUpperCase();
                document.getElementById('card-type-label').innerText = 'DEBIT'; // Assuming non-credit is debit/savings
                document.getElementById('card-number-display').innerText = displayNum;
                document.getElementById('card-holder-name').innerText = holder;
                document.getElementById('card-expiry-display').innerText = exp;
                document.getElementById('card-cvv-display').innerText = cvv;
                
                // Set Background Gradient based on provider or tag
                const cardBg = document.getElementById('virtual-card-bg');
                
                // Map Tailwind colors to gradients roughly
                let gradientClass = "from-gray-800 to-black";
                if (provider.color.includes('blue')) gradientClass = "from-blue-900 to-slate-900";
                else if (provider.color.includes('green')) gradientClass = "from-green-900 to-emerald-950";
                else if (provider.color.includes('red')) gradientClass = "from-red-900 to-rose-950";
                else if (provider.color.includes('cyan')) gradientClass = "from-cyan-900 to-blue-950";
                else if (provider.color.includes('purple')) gradientClass = "from-purple-900 to-indigo-950";
                else if (provider.color.includes('orange')) gradientClass = "from-orange-900 to-red-950";
                
                cardBg.className = `absolute inset-0 bg-gradient-to-br ${gradientClass} z-0`;
            }

            // Balance Section
            document.getElementById('details-account-balance').innerText = `₱${balance.toLocaleString()}`;
            
            const footerActions = document.getElementById('details-footer-actions');
            const balanceLabel = document.getElementById('details-balance-label');
            const creditProgress = document.getElementById('details-credit-progress');
            const depositBtn = document.getElementById('btn-deposit-money');

            // Default Footer Button
            footerActions.innerHTML = `
                <button onclick="closeAccountDetailsModal(); openEditAccountModal('${id}')" class="w-full bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 text-gray-900 dark:text-white font-bold py-2.5 rounded-xl text-[10px] flex items-center justify-center gap-2 transition-colors">
                    <i data-lucide="edit-2" class="w-3 h-3"></i> Edit Account
                </button>
            `;

            if (acc.tag === 'credit') {
                balanceLabel.innerText = "Total Outstanding Balance";
                balanceLabel.className = "text-[10px] text-red-500 uppercase tracking-wider block mb-0.5";
                
                creditProgress.classList.remove('hidden');
                depositBtn.classList.add('hidden'); 
                
                const limit = acc.creditLimit || 0;
                let utilization = 0;
                if(limit > 0) utilization = (balance / limit) * 100;
                
                document.getElementById('details-utilization-text').innerText = `${utilization.toFixed(1)}% Used`;
                document.getElementById('details-limit-text').innerText = `Limit: ₱${limit.toLocaleString()}`;
                document.getElementById('details-progress-bar').style.width = `${Math.min(utilization, 100)}%`;

                footerActions.innerHTML += `
                    <button onclick="closeAccountDetailsModal(); openInstallmentModal('${id}')" class="w-full bg-white/10 hover:bg-white/20 text-red-600 dark:text-red-400 border border-red-200 dark:border-red-900 font-bold py-2.5 rounded-xl text-[10px] flex items-center justify-center gap-2 transition-colors">
                        <i data-lucide="plus-circle" class="w-3 h-3"></i> Add Installment / Loan
                    </button>
                `;

            } else {
                balanceLabel.innerText = "Available Balance";
                balanceLabel.className = "text-[10px] text-gray-500 dark:text-gray-400 uppercase tracking-wider block mb-0.5";
                creditProgress.classList.add('hidden');
                depositBtn.classList.remove('hidden');
            }

            renderAccountHistory(id);
            document.getElementById('account-details-modal').classList.remove('hidden');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function closeAccountDetailsModal() {
            document.getElementById('account-details-modal').classList.add('hidden');
        }

        /* --- DEPOSIT LOGIC --- */
        function openDepositModal() {
            if(!currentViewingAccountId) return;
            document.getElementById('deposit-amount').value = '';
            document.getElementById('deposit-note').value = '';
            document.getElementById('deposit-modal').classList.remove('hidden');
        }

        function closeDepositModal() {
            document.getElementById('deposit-modal').classList.add('hidden');
        }

        function submitDeposit() {
            const amount = Number(document.getElementById('deposit-amount').value);
            const note = document.getElementById('deposit-note').value;
            
            if(!amount || amount <= 0) return showCustomAlert("Error", "Invalid amount");
            
            const accIndex = state.accounts.findIndex(a => a.id === currentViewingAccountId);
            if(accIndex === -1) return showCustomAlert("Error", "Account not found");
            
            state.accounts[accIndex].balance += amount;
            
            const record = {
                id: Date.now(),
                from: 'deposit_external',
                to: currentViewingAccountId,
                amount: amount,
                note: note || 'Cash Deposit',
                date: new Date().toISOString()
            };
            
            if(!state.transfers) state.transfers = [];
            state.transfers.push(record);
            
            saveData();
            closeDepositModal();
            renderApp();
            openAccountDetails(currentViewingAccountId); // Refresh Details
            showCustomAlert("Success", "Funds deposited successfully");
        }

        /* --- ADD/EDIT ACCOUNT MODAL (Form) --- */
        function openAddAccountModal() {
            editingId = null;
            const el = document.getElementById('add-account-modal');
            if(!el) return;
            document.getElementById('modal-account-title').innerText = "New Account";
            document.getElementById('new-account-name').value = '';
            document.getElementById('new-account-balance').value = '';
            document.getElementById('new-account-limit').value = '';
            document.getElementById('new-account-statement').value = '';
            document.getElementById('new-account-due').value = '';
            document.getElementById('account-provider-search').value = '';
            // New fields
            document.getElementById('new-account-number').value = '';
            document.getElementById('new-account-expiry').value = '';
            document.getElementById('new-account-cvv').value = '';
            
            const radios = document.getElementsByName('account-tag');
            if(radios[0]) {
                radios[0].checked = true;
                radios[0].dispatchEvent(new Event('change'));
            }
            
            document.getElementById('btn-delete-account').classList.add('hidden');
            
            selectedAccountProviderId = null;
            renderAccountProviderGrid();
            el.classList.remove('hidden');
        }

        function closeAddAccountModal() { const el = document.getElementById('add-account-modal'); if(el) el.classList.add('hidden'); }

        function openEditAccountModal(id) {
            const acc = state.accounts.find(a => a.id === id);
            const el = document.getElementById('add-account-modal');
            if (!acc || !el) return;
            editingId = id;
            document.getElementById('modal-account-title').innerText = "Edit Account";
            document.getElementById('new-account-name').value = acc.name;
            document.getElementById('new-account-balance').value = acc.balance;
            
            // New fields
            document.getElementById('new-account-number').value = acc.accountNumber || '';
            document.getElementById('new-account-expiry').value = acc.cardExpiry || '';
            document.getElementById('new-account-cvv').value = acc.cardCvv || '';

            // Trigger Radio Change First to ensure DOM is ready
            const radios = document.getElementsByName('account-tag');
            radios.forEach(r => {
                if(r.value === acc.tag) {
                    r.checked = true;
                    r.dispatchEvent(new Event('change')); 
                }
            });

            // Populate Credit Fields if Credit (Prevent 0/empty mismatch)
            if (acc.tag === 'credit') {
                document.getElementById('new-account-limit').value = acc.creditLimit != null ? acc.creditLimit : '';
                document.getElementById('new-account-statement').value = acc.statementDate != null ? acc.statementDate : '';
                document.getElementById('new-account-due').value = acc.dueDate != null ? acc.dueDate : '';
            }

            document.getElementById('btn-delete-account').classList.remove('hidden');
            selectedAccountProviderId = acc.providerId;
            renderAccountProviderGrid();
            el.classList.remove('hidden');
        }

        function renderAccountProviderGrid() {
            const container = document.getElementById('account-provider-grid');
            if (!container) return;
            container.innerHTML = '';
            const search = document.getElementById('account-provider-search').value.toLowerCase();
            
            PROVIDERS.filter(p => p.name.toLowerCase().includes(search)).forEach(p => {
                const isSel = selectedAccountProviderId === p.id;
                container.insertAdjacentHTML('beforeend', `<div onclick="selectedAccountProviderId='${p.id}'; renderAccountProviderGrid();" class="cursor-pointer flex flex-col items-center p-1.5 rounded-xl border transition-all ${isSel ? 'ring-2 ring-cyan-500 bg-cyan-50 dark:bg-cyan-900/20 border-cyan-500' : 'border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800'}"><div class="w-6 h-6 rounded-lg ${p.color} flex items-center justify-center text-white mb-0.5"><i data-lucide="${p.icon}" class="w-3 h-3"></i></div><span class="text-[8px] text-gray-700 dark:text-gray-300 text-center truncate w-full">${p.name}</span></div>`);
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function submitNewAccount() {
            const name = document.getElementById('new-account-name').value;
            const balance = Number(document.getElementById('new-account-balance').value);
            
            // Safe Number Conversion for Credit Fields
            const limit = document.getElementById('new-account-limit').value;
            const due = document.getElementById('new-account-due').value;
            const statement = document.getElementById('new-account-statement').value;

            const accountNumber = document.getElementById('new-account-number').value;
            const cardExpiry = document.getElementById('new-account-expiry').value;
            const cardCvv = document.getElementById('new-account-cvv').value;
            
            let tag = 'savings';
            const radios = document.getElementsByName('account-tag');
            radios.forEach(r => { if(r.checked) tag = r.value; });

            if(!name || !selectedAccountProviderId) return showCustomAlert("Error", "Details required");
            
            const provider = PROVIDERS.find(p => p.id === selectedAccountProviderId);
            
            const data = { 
                id: editingId || Date.now().toString(), 
                name, 
                balance, 
                providerId: selectedAccountProviderId, 
                type: provider.type, 
                tag: tag, 
                accountNumber: accountNumber,
                // Only save expiry/cvv if NOT credit
                cardExpiry: tag === 'daily' || tag === 'savings' ? cardExpiry : null,
                cardCvv: tag === 'daily' || tag === 'savings' ? cardCvv : null,
                // Explicitly save as Numbers or null for Credit
                creditLimit: tag === 'credit' ? Number(limit) : null,
                statementDate: tag === 'credit' ? Number(statement) : null,
                dueDate: tag === 'credit' ? Number(due) : null
            };

            if (editingId) {
                const idx = state.accounts.findIndex(x => x.id === editingId);
                if (idx !== -1) {
                        data.interestBalance = state.accounts[idx].interestBalance || 0;
                        state.accounts[idx] = data;
                }
            } else state.accounts.push(data);
            
            closeAddAccountModal();
            saveData(); 
            renderApp();
        }

        function deleteCurrentAccount() {
            if (editingId) {
                showConfirmModal(
                    "Delete Account?",
                    "Are you sure you want to delete this account? This cannot be undone.",
                    () => {
                        state.accounts = state.accounts.filter(x => x.id !== editingId);
                        closeAddAccountModal();
                        saveData();
                        renderApp();
                    }
                );
            }
        }

        /* --- TRANSFER CUSTOM DROPDOWN LOGIC --- */
        function toggleDropdown(id) {
            const dropdown = document.getElementById(`${id}-dropdown`);
            if(!dropdown) return;
            const isHidden = dropdown.classList.contains('hidden');
            
            document.querySelectorAll('.custom-dropdown-menu').forEach(d => d.classList.add('hidden'));
            
            if(isHidden) {
                renderDropdownOptions(id);
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        function renderDropdownOptions(targetId) {
            const container = document.getElementById(`${targetId}-dropdown`);
            if(!container) return;
            container.innerHTML = '';

            state.accounts.forEach(acc => {
                const provider = PROVIDERS.find(p => p.id === acc.providerId) || { color: 'bg-gray-600', icon: 'wallet' };
                
                container.insertAdjacentHTML('beforeend', `
                    <div onclick="selectOption('${targetId}', '${acc.id}')" class="custom-option group flex items-center justify-between my-1 flex items-center justify-between p-2 mb-1.5 last:mb-0 rounded-xl bg-gray-50 dark:bg-gray-800/50 border border-transparent hover:border-cyan-500 hover:bg-white dark:hover:bg-gray-800 cursor-pointer transition-all shadow-sm">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <div class="w-5 h-5 rounded-md ${provider.color} flex items-center justify-center text-white shrink-0">
                                <i data-lucide="${provider.icon}" class="w-3 h-3"></i>
                            </div>
                            <span class="text-xs font-medium text-gray-700 dark:text-gray-200 truncate group-hover:text-cyan-600 dark:group-hover:text-cyan-400">${acc.name}</span>
                        </div>
                        <span class="text-[10px] font-mono text-gray-500 whitespace-nowrap">₱${acc.balance.toLocaleString()}</span>
                    </div>
                `);
            });
            
            if(state.accounts.length === 0) {
                    container.innerHTML = '<div class="p-4 text-center text-[10px] text-gray-400">No accounts found.</div>';
            }
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function selectOption(targetId, accId) {
            const acc = state.accounts.find(a => a.id === accId);
            if(!acc) return;
            const provider = PROVIDERS.find(p => p.id === acc.providerId) || { color: 'bg-gray-600', icon: 'wallet' };

            document.getElementById(`${targetId}-value`).value = accId;

            const btn = document.getElementById(`${targetId}-btn`);
            btn.innerHTML = `
                <div class="flex items-center gap-2 w-full overflow-hidden">
                    <div class="w-5 h-5 rounded-md ${provider.color} flex items-center justify-center text-white shrink-0">
                        <i data-lucide="${provider.icon}" class="w-3 h-3"></i>
                    </div>
                    <span class="block text-xs font-bold text-gray-900 dark:text-white truncate flex-1 text-left">${acc.name}</span>
                    <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400 shrink-0 ml-auto"></i>
                </div>
            `;
            
            document.getElementById(`${targetId}-dropdown`).classList.add('hidden');
            
            if (targetId === 'transfer-to') {
                checkSmartPayLogic(accId);
            }

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function checkSmartPayLogic(toAccountId) {
            const acc = state.accounts.find(a => a.id === toAccountId);
            const smartPayContainer = document.getElementById('transfer-smart-pay');
            const amountInput = document.getElementById('transfer-amount');
            
            if (acc && acc.tag === 'credit') {
                const now = new Date();
                const currentMonthExpenses = state.expenses.filter(e => {
                        if (e.accountId !== acc.id) return false;
                        const d = new Date(e.id);
                        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
                const currentBill = currentMonthExpenses.reduce((sum, e) => sum + e.amount, 0);
                
                smartPayContainer.classList.remove('hidden');
                
                const suggestAmount = currentBill > 0 ? currentBill : acc.balance;
                amountInput.value = suggestAmount;

                const btnPayFull = document.getElementById('btn-pay-full');
                document.getElementById('val-pay-full').innerText = `(₱${acc.balance.toLocaleString()})`;
                
                btnPayFull.onclick = () => {
                    amountInput.value = acc.balance;
                };

            } else {
                smartPayContainer.classList.add('hidden');
                amountInput.value = '';
            }
        }

        function openTransferModal(targetId = null) {
            if (state.accounts.length < 2) return showCustomAlert("Error", "Need 2 accounts to transfer");
            
            const el = document.getElementById('transfer-modal');
            if(!el) return;
            
            document.getElementById('transfer-from-value').value = '';
            document.getElementById('transfer-to-value').value = '';
            document.getElementById('transfer-amount').value = '';
            document.getElementById('transfer-smart-pay').classList.add('hidden');
            
            const defaultContent = `
                <div class="flex items-center justify-between w-full">
                    <span class="text-gray-400 text-xs">Select Account</span>
                    <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                </div>`;
                
            document.getElementById('transfer-from-btn').innerHTML = defaultContent;
            document.getElementById('transfer-to-btn').innerHTML = defaultContent;

            if (targetId) {
                selectOption('transfer-to', targetId);
                const likelySource = state.accounts.find(a => a.tag !== 'credit' && a.id !== targetId);
                if (likelySource) selectOption('transfer-from', likelySource.id);
            }

            el.classList.remove('hidden');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function closeTransferModal() { const el = document.getElementById('transfer-modal'); if(el) el.classList.add('hidden'); }

        function submitTransfer() {
            const fromId = document.getElementById('transfer-from-value').value;
            const toId = document.getElementById('transfer-to-value').value;
            const amount = Number(document.getElementById('transfer-amount').value);
            
            if (!fromId || !toId) return showCustomAlert("Error", "Select both accounts");
            if (fromId === toId) return showCustomAlert("Error", "Same account selected");
            if (!amount || amount <= 0) return showCustomAlert("Error", "Invalid amount");

            const from = state.accounts.find(a => a.id == fromId);
            const to = state.accounts.find(a => a.id == toId);
            
            if (from.tag !== 'credit' && from.balance < amount) return showCustomAlert("Error", "Insufficient funds");
            
            const transferRecord = {
                id: Date.now(),
                from: fromId,
                to: toId,
                amount: amount,
                date: new Date().toISOString()
            };
            
            if(!state.transfers) state.transfers = [];
            state.transfers.push(transferRecord);

            if (from.tag === 'credit') {
                from.balance += amount; 
            } else {
                from.balance -= amount; 
            }
            
            if (to.tag === 'credit') {
                to.balance -= amount; 
            } else {
                to.balance += amount; 
            }
            
            closeTransferModal();
            saveData();
            renderApp();
            showCustomAlert("Success", "Transfer complete");
        }
    </script>
    <script src="script.js"></script>
</body>
</html>