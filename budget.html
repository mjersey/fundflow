<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund Flow - Allocations</title>
    <link id="favicon" rel="icon" type="image/png" href="images/fundflow-logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>tailwind.config = { darkMode: 'class', theme: { extend: { colors: { dark: { bg: '#000000', card: '#111827' } } } } }</script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .hidden { display: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }
        /* Custom Date Picker Styling */
        .custom-date-input::-webkit-calendar-picker-indicator { background: transparent; bottom: 0; color: transparent; cursor: pointer; height: auto; left: 0; position: absolute; right: 0; top: 0; width: auto; }
        /* Custom Select Arrow */
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.2em 1.2em;
        }
    </style>

    <!-- IMMEDIATE THEME INIT (Fixes Black Screen Flash) -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const isDark = savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>

    <!-- FIREBASE & AUTH GUARD -->
    <script type="module">
        import { auth, db } from "./firebase-config.js";
        import { onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.auth = auth;
        window.db = db;
        
        window.logout = () => { 
            if(window.showConfirmModal) {
                window.showConfirmModal("Sign Out", "Are you sure you want to sign out?", () => signOut(auth).then(() => window.location.href = 'index.html'));
            } else { 
                if(confirm("Sign Out?")) signOut(auth).then(() => window.location.href = 'index.html'); 
            }
        };

        window.handleDeleteAccount = async () => {
            window.showConfirmModal("DELETE ACCOUNT", "WARNING: This will permanently delete your account and ALL your data. This action cannot be undone.", async () => {
                const user = auth.currentUser;
                try {
                    await deleteDoc(doc(db, 'artifacts', 'fundflow-default', 'users', user.uid, 'data', 'mainState'));
                    await deleteUser(user);
                    window.showCustomAlert("Account Deleted", "Redirecting...");
                    setTimeout(() => window.location.href = 'index.html', 2000);
                } catch (e) {
                    window.showCustomAlert("Security Check", "Please sign out and sign in again before deleting your account.");
                }
            });
        };

        // ROBUST DATA SYNC (Fixes Data Disappearing)
        window.saveData = async () => {
            if (!window.state) return;
            // Update timestamp first to claim this version is "newest"
            window.state.lastUpdated = Date.now();
            localStorage.setItem('moneyFlowStateV3', JSON.stringify(window.state));
            
            const user = auth.currentUser;
            if (user) {
                try {
                    await setDoc(doc(db, 'artifacts', 'fundflow-default', 'users', user.uid, 'data', 'mainState'), window.state);
                } catch (e) { console.error("Cloud Save Error:", e); }
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                try {
                    const docRef = doc(db, 'artifacts', 'fundflow-default', 'users', user.uid, 'data', 'mainState');
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const cloudData = docSnap.data();
                        const localData = window.state || {};
                        
                        const cloudTime = cloudData.lastUpdated || 0;
                        const localTime = localData.lastUpdated || 0;

                        // Sync Logic: Choose the freshest data to prevent overwriting recent changes
                        if (cloudTime > localTime) {
                            console.log("Sync: Cloud is newer. Updating local.");
                            window.state = { ...window.state, ...cloudData };
                            localStorage.setItem('moneyFlowStateV3', JSON.stringify(window.state));
                        } else if (localTime > cloudTime) {
                            console.log("Sync: Local is newer. Pushing to cloud.");
                            window.saveData(); 
                        } else {
                            // If timestamps equal or generic load, merge safe
                            if(!window.state || Object.keys(window.state).length === 0) {
                                window.state = { ...cloudData };
                            }
                        }
                    } else {
                        window.saveData(); // Create initial cloud data if missing
                    }
                    
                    if(window.renderApp) window.renderApp();

                    // Restore Budget Input (Using totalBudget now, not income)
                    if (window.state) {
                        const incomeInput = document.getElementById('income-input');
                        // Initialize totalBudget if missing, but don't force overwrite if 0
                        if (window.state.totalBudget === undefined) window.state.totalBudget = 0;
                        
                        if(incomeInput) incomeInput.value = window.state.totalBudget;
                        if(window.updateTotals) window.updateTotals();
                    }
                } catch (e) { console.error("Sync Error:", e); }
            }
        });
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-950 text-gray-900 dark:text-gray-100 flex justify-center min-h-screen p-2 text-[10px] md:text-xs">

    <!-- Reduced Max Width to 6xl for tighter look -->
    <div class="w-full max-w-6xl bg-white dark:bg-black min-h-[90vh] shadow-2xl relative border border-gray-200 dark:border-gray-800 rounded-3xl flex flex-col md:flex-row overflow-hidden my-auto z-10">
        
        <!-- LEFT PANEL -->
        <aside class="w-full md:w-64 lg:w-72 bg-gray-50/80 dark:bg-gray-900/50 border-r border-gray-200 dark:border-gray-800 p-4 flex flex-col relative overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <img src="images/fundflow-logo.png" alt="Logo" class="w-6 h-6 object-contain drop-shadow-sm hover:scale-105 transition-transform">
                    <div>
                        <h1 class="text-sm font-bold tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-blue-600">FUND FLOW</h1>
                        <p class="text-[8px] text-gray-500 uppercase tracking-widest leading-none">Finance Manager</p>
                    </div>
                </div>
                <div class="flex gap-1">
                    <button onclick="toggleTheme()" class="p-1.5 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-500 hover:text-cyan-500 transition-colors">
                         <i data-lucide="moon" class="icon-moon w-3 h-3 hidden"></i>
                         <i data-lucide="sun" class="icon-sun w-3 h-3 hidden"></i>
                    </button>
                    <!-- USES SETTINGS.JS NOW -->
                    <button onclick="toggleSettings(true)" class="p-1.5 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-500 hover:text-cyan-500 transition-colors">
                        <i data-lucide="settings" class="w-3 h-3"></i>
                    </button>
                    <button onclick="logout()" class="p-1.5 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors" title="Sign Out">
                        <i data-lucide="log-out" class="w-3 h-3"></i>
                    </button>
                </div>
            </div>

            <!-- TOTAL BUDGET CARD (MODIFIED) -->
            <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 rounded-xl p-3 border border-gray-200 dark:border-gray-700 shadow-sm relative overflow-hidden mb-4">
                <label class="text-gray-500 dark:text-gray-400 text-[9px] font-medium uppercase tracking-wider mb-0.5 block">Total Budget (Plan)</label>
                <div class="flex items-center border-b border-gray-200 dark:border-gray-600 pb-1 mb-2 gap-2">
                    <span class="text-sm text-gray-400 dark:text-gray-500">₱</span>
                    <input type="number" id="income-input" class="bg-transparent text-lg font-bold w-full focus:outline-none placeholder-gray-300 dark:placeholder-gray-700" placeholder="0.00"/>
                    <button onclick="openBudgetSourceModal()" class="text-gray-400 hover:text-cyan-500 transition-colors p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700" title="Copy from Wallet">
                        <i data-lucide="import" class="w-4 h-4"></i>
                    </button>
                </div>
                <div class="space-y-1">
                    <div class="flex justify-between items-center text-[9px] p-1.5 bg-gray-100 dark:bg-black/20 rounded-lg">
                        <span class="text-gray-500 dark:text-gray-400">Remaining</span>
                        <span id="remaining-display" class="font-bold text-xs">₱0</span>
                    </div>
                    <div class="flex justify-between items-center text-[9px] px-1.5">
                        <span class="text-gray-500">Allocated</span>
                        <span id="allocated-display" class="text-gray-700 dark:text-gray-300 font-semibold">₱0</span>
                    </div>
                </div>
            </div>

            <div class="flex-1">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-cyan-600 dark:text-cyan-400 text-[10px] font-bold flex items-center gap-1.5"><i data-lucide="wallet" class="w-3 h-3"></i> Daily Accounts</h3>
                </div>
                <div id="accounts-list" class="space-y-1 overflow-y-auto max-h-[30vh] pr-1"></div>
            </div>
        </aside>


        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 p-4 lg:p-6 overflow-y-auto pb-20 bg-white dark:bg-black relative">
            <div class="mb-5">
                <div class="flex justify-between items-center mb-0.5">
                    <h2 class="text-base font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                        <i data-lucide="layers" class="text-cyan-500 w-3 h-3"></i> Allocations
                    </h2>
                    <button onclick="openAddModal()" class="bg-cyan-600 hover:bg-cyan-500 text-white text-[9px] font-bold py-2 px-3 rounded-lg flex items-center gap-1.5 shadow-lg shadow-cyan-500/20 transition-all hover:scale-105">
                        <i data-lucide="plus-circle" class="w-3 h-3"></i> 
                        <span class="hidden sm:inline">Add Row</span>
                    </button>
                </div>
                <p class="text-[10px] text-gray-500">Manage your budget categories and plans.</p>
            </div>

            <div id="allocations-list" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-2.5 mb-6 pb-24"></div>

            <!-- FLOATING NAVBAR -->
            <div class="fixed bottom-14 left-0 right-0 md:left-64 lg:left-72 flex justify-center z-50 pointer-events-none">
                <nav class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl border border-gray-200 dark:border-gray-800 shadow-2xl rounded-full px-4 py-2 flex items-center gap-1 pointer-events-auto transition-all hover:scale-105">
                    <a href="dashboard.html" class="flex flex-col items-center justify-center w-12 h-10 rounded-xl text-gray-400 hover:text-cyan-600 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all">
                        <i data-lucide="layout-dashboard" class="w-3.5 h-3.5 mb-0.5"></i>
                        <span class="text-[8px] font-medium">Home</span>
                    </a>
                    <a href="budget.html" class="flex flex-col items-center justify-center w-12 h-10 rounded-xl bg-cyan-50 dark:bg-cyan-900/20 text-cyan-600 dark:text-cyan-400 transition-all">
                        <i data-lucide="pie-chart" class="w-3.5 h-3.5 mb-0.5"></i>
                        <span class="text-[8px] font-medium">Budget</span>
                    </a>
                    <a href="savings.html" class="flex flex-col items-center justify-center w-12 h-10 rounded-xl text-gray-400 hover:text-cyan-600 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all">
                        <i data-lucide="piggy-bank" class="w-3.5 h-3.5 mb-0.5"></i>
                        <span class="text-[8px] font-bold">Save</span>
                    </a>
                    <a href="accounts.html" class="flex flex-col items-center justify-center w-12 h-10 rounded-xl text-gray-400 hover:text-cyan-600 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all">
                        <i data-lucide="wallet" class="w-3.5 h-3.5 mb-0.5"></i>
                        <span class="text-[8px] font-medium">Wallet</span>
                    </a>
                </nav>
            </div>
        </main>

        <!-- COMPACT ADD ALLOCATION MODAL -->
        <div id="add-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 hidden">
            <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 w-full max-w-sm rounded-2xl p-4 shadow-2xl animate-fade-in flex flex-col h-auto">
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200 dark:border-gray-800">
                    <h3 id="allocation-modal-title" class="font-bold text-sm text-gray-900 dark:text-white">Add Allocation</h3>
                    <button onclick="closeAddModal()" class="text-gray-500 hover:text-gray-900 dark:hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <div class="space-y-4">
                    <!-- Icon Selection -->
                    <div>
                        <label class="block text-[9px] font-bold text-gray-400 mb-1 uppercase tracking-wider">Select Icon</label>
                        <div class="grid grid-cols-6 gap-2" id="category-icon-grid">
                            <!-- Icons injected here -->
                        </div>
                    </div>

                    <!-- Simple Plan Inputs Only -->
                    <div>
                        <label class="block text-[9px] font-bold text-gray-400 mb-1 uppercase tracking-wider">Allocation Name</label>
                        <div class="flex items-center gap-2">
                            <div id="selected-icon-preview" class="w-9 h-9 rounded-lg bg-gray-100 dark:bg-gray-800 flex items-center justify-center text-gray-500">
                                <i data-lucide="tag" class="w-4 h-4"></i>
                            </div>
                            <input type="text" id="new-item-category-input" class="flex-1 bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg p-2.5 text-xs outline-none dark:text-white focus:border-cyan-500" placeholder="e.g. Groceries">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-[9px] font-bold text-gray-400 mb-1 uppercase tracking-wider">Planned Amount</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400 text-xs font-bold">₱</span>
                            <input type="number" id="new-item-amount" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-lg py-2.5 pl-6 pr-3 text-xs font-bold outline-none dark:text-white focus:border-cyan-500" placeholder="0.00">
                        </div>
                    </div>
                </div>
                
                <div class="pt-4 mt-2 flex justify-end gap-2">
                    <button id="btn-save-allocation" onclick="submitNewAllocation()" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white text-xs font-bold py-3 rounded-xl shadow-lg transition-all">Save Allocation</button>
                </div>
            </div>
        </div>

        <!-- NEW: BUDGET SOURCE MODAL -->
        <div id="budget-source-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[150] flex items-center justify-center p-4 hidden">
            <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 w-full max-w-sm rounded-2xl p-4 shadow-2xl animate-fade-in flex flex-col h-auto">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-sm text-gray-900 dark:text-white">Copy Budget from Wallet</h3>
                    <button onclick="closeBudgetSourceModal()" class="text-gray-500 hover:text-gray-900 dark:hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                <p class="text-[10px] text-gray-500 mb-3">Select a wallet account. Its current balance will be copied to your Total Budget field. <br><span class="text-cyan-600 font-bold">Note: This does NOT affect your actual wallet balance.</span></p>
                
                <div class="max-h-[50vh] overflow-y-auto pr-1 space-y-2 custom-scroll" id="budget-source-list">
                    <!-- Accounts injected here -->
                </div>
            </div>
        </div>

    </div>

    <!-- LINK SHARED SCRIPTS -->
    <script src="script.js"></script>
    <script src="settings.js"></script> 
    <script>
        // Exposed Functions for this page
        window.renderApp = renderApp;
        window.openAddModal = openAddModal;
        window.closeAddModal = closeAddModal;
        window.submitNewAllocation = submitNewAllocation;
        window.deleteCurrentAllocation = deleteCurrentAllocation;
        window.openEditAllocationModal = openEditAllocationModal;
        window.selectCategoryIcon = selectCategoryIcon;
        // New exports
        window.openBudgetSourceModal = openBudgetSourceModal;
        window.closeBudgetSourceModal = closeBudgetSourceModal;
        window.setBudgetFromAccount = setBudgetFromAccount;

        let editingId = null;
        let selectedCategoryIcon = 'tag';

        const CATEGORY_ICONS = [
            { id: 'shopping-bag', icon: 'shopping-bag', color: 'text-orange-500', bg: 'bg-orange-100' },
            { id: 'utensils', icon: 'utensils', color: 'text-red-500', bg: 'bg-red-100' },
            { id: 'car', icon: 'car', color: 'text-blue-500', bg: 'bg-blue-100' },
            { id: 'home', icon: 'home', color: 'text-green-500', bg: 'bg-green-100' },
            { id: 'film', icon: 'film', color: 'text-purple-500', bg: 'bg-purple-100' },
            { id: 'heart-pulse', icon: 'heart-pulse', color: 'text-pink-500', bg: 'bg-pink-100' },
            { id: 'zap', icon: 'zap', color: 'text-yellow-500', bg: 'bg-yellow-100' },
            { id: 'wifi', icon: 'wifi', color: 'text-cyan-500', bg: 'bg-cyan-100' },
            { id: 'gift', icon: 'gift', color: 'text-rose-500', bg: 'bg-rose-100' },
            { id: 'book-open', icon: 'book-open', color: 'text-indigo-500', bg: 'bg-indigo-100' },
            { id: 'dumbbell', icon: 'dumbbell', color: 'text-emerald-500', bg: 'bg-emerald-100' },
            { id: 'briefcase', icon: 'briefcase', color: 'text-slate-500', bg: 'bg-slate-100' }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            try {
                loadState(); 
                if(window.initTheme) window.initTheme();
                renderApp();
                
                const incomeInput = document.getElementById('income-input');
                if (incomeInput) {
                    // DECOUPLED: Use totalBudget instead of income
                    if (state.totalBudget === undefined) state.totalBudget = 0;
                    incomeInput.value = state.totalBudget || '';
                    
                    incomeInput.addEventListener('input', (e) => {
                        state.totalBudget = Number(e.target.value);
                        updateTotals();
                        saveData();
                    });
                }
            } catch (e) { console.error("Init error:", e); }
        });

        function renderApp() { renderAllocations(); updateTotals(); renderAccountsSidebar(); if (typeof lucide !== 'undefined') lucide.createIcons(); }
        
        function renderAllocations() {
            const container = document.getElementById('allocations-list');
            if (!container) return;
            container.innerHTML = '';
            
            state.allocations.forEach(item => {
                // Find icon config or default
                let iconConfig = CATEGORY_ICONS.find(i => i.id === item.icon) || { icon: 'tag', color: 'text-gray-500', bg: 'bg-gray-100' };
                
                container.insertAdjacentHTML('beforeend', `
                <div class="flex overflow-x-auto no-scrollbar snap-x snap-mandatory rounded-xl mb-2 bg-red-600 group">
                    <div onclick="openEditAllocationModal(${item.id})" class="min-w-full snap-center bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 p-3 flex items-center gap-3 transition-all hover:border-cyan-500 relative cursor-pointer">
                        <div class="w-9 h-9 rounded-lg ${iconConfig.bg} dark:bg-opacity-20 flex items-center justify-center ${iconConfig.color} shadow-sm shrink-0 relative">
                            <i data-lucide="${iconConfig.icon}" class="w-4 h-4"></i>
                        </div>
                        <div class="flex-grow min-w-0">
                            <div class="text-xs font-bold text-gray-900 dark:text-white mb-0.5 truncate">${item.name}</div>
                            <div class="flex items-center gap-1">
                                <span class="text-[8px] uppercase font-bold px-1.5 py-0.5 rounded bg-gray-100 dark:bg-gray-800 text-gray-500">Allocation</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-gray-500 text-[10px] mr-1">₱</span>
                            <span class="font-mono text-sm font-bold text-gray-900 dark:text-white">${item.amount.toLocaleString()}</span>
                        </div>
                    </div>
                    <div onclick="editingId=${item.id}; deleteCurrentAllocation()" class="min-w-[60px] snap-center flex items-center justify-center text-white cursor-pointer hover:bg-red-700 transition-colors">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </div>
                </div>`);
            });
        }

        function updateTotals() {
            const allocated = state.allocations.reduce((sum, item) => sum + Number(item.amount), 0);
            // DECOUPLED: Use state.totalBudget
            const totalBudget = state.totalBudget || 0;
            const remaining = totalBudget - allocated;
            
            const elAlloc = document.getElementById('allocated-display');
            const elRem = document.getElementById('remaining-display');
            
            if (elAlloc) elAlloc.innerText = `₱${allocated.toLocaleString()}`;
            if (elRem) {
                elRem.innerText = `₱${remaining.toLocaleString()}`;
                elRem.className = `font-bold text-sm ${remaining < 0 ? 'text-red-500' : 'text-green-600 dark:text-green-400'}`;
            }
        }

        function renderAccountsSidebar() {
            const sidebarList = document.getElementById('accounts-list');
            if(!sidebarList) return;
            
            const savingsBySource = {};
            state.savings.forEach(goal => {
                if (goal.includeInTotal) savingsBySource[goal.source] = (savingsBySource[goal.source] || 0) + Number(goal.current);
            });

            const dailyAccounts = state.accounts.filter(a => {
                const tag = (a.tag || '').toLowerCase();
                if (tag === 'daily') return true;
                if (tag === 'savings') return false;
                if (tag === 'credit' || a.type === 'credit') return false;
                return true; 
            });

            if(dailyAccounts.length === 0) {
                 sidebarList.innerHTML = '<div class="text-[10px] text-gray-400 text-center py-2">No daily accounts found.</div>';
                 return;
            }

            sidebarList.innerHTML = dailyAccounts.map(acc => {
                let provider = PROVIDERS.find(p => p.id === acc.providerId) || { color: 'bg-gray-600', icon: 'wallet' };
                const total = acc.balance + (savingsBySource[acc.id] || 0);
                return `<div class="flex justify-between items-center p-1.5 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors group">
                    <div class="flex items-center gap-2 overflow-hidden">
                        <div class="w-5 h-5 rounded-md ${provider.color} flex items-center justify-center text-white shrink-0"><i data-lucide="${provider.icon}" class="w-3 h-3"></i></div>
                        <span class="text-[10px] font-medium text-gray-700 dark:text-gray-300 truncate">${acc.name}</span>
                    </div>
                    <span class="text-[10px] font-bold text-gray-900 dark:text-white">₱${total.toLocaleString()}</span>
                </div>`
            }).join('');
        }

        /* --- ALLOCATION LOGIC --- */
        function renderIconGrid() {
            const container = document.getElementById('category-icon-grid');
            if(!container) return;
            container.innerHTML = '';
            CATEGORY_ICONS.forEach(icon => {
                const isSelected = selectedCategoryIcon === icon.id;
                container.insertAdjacentHTML('beforeend', `
                    <div onclick="selectCategoryIcon('${icon.id}')" class="w-9 h-9 rounded-lg flex items-center justify-center cursor-pointer transition-all ${isSelected ? icon.bg + ' ' + icon.color + ' ring-2 ring-cyan-500' : 'bg-gray-50 dark:bg-gray-800 text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700'}">
                        <i data-lucide="${icon.icon}" class="w-4 h-4"></i>
                    </div>
                `);
            });
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function selectCategoryIcon(id) {
            selectedCategoryIcon = id;
            renderIconGrid();
            const iconConfig = CATEGORY_ICONS.find(i => i.id === id) || { icon: 'tag' };
            document.getElementById('selected-icon-preview').innerHTML = `<i data-lucide="${iconConfig.icon}" class="w-4 h-4 text-cyan-600"></i>`;
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function openAddModal() { 
            editingId = null; 
            const el = document.getElementById('add-modal'); 
            if(el) { 
                document.getElementById('allocation-modal-title').innerText = "Add Allocation";
                document.getElementById('new-item-amount').value=''; 
                document.getElementById('new-item-category-input').value='';
                document.getElementById('btn-save-allocation').innerText = "Add Allocation";
                selectedCategoryIcon = 'tag';
                renderIconGrid();
                document.getElementById('selected-icon-preview').innerHTML = `<i data-lucide="tag" class="w-4 h-4 text-gray-500"></i>`;
                el.classList.remove('hidden'); 
                if(typeof lucide !== 'undefined') lucide.createIcons();
            } 
        }

        function openEditAllocationModal(id) { 
            const item = state.allocations.find(i=>i.id===id); 
            if(!item) return; 
            editingId=id; 
            const el=document.getElementById('add-modal'); 
            if(el){ 
                document.getElementById('allocation-modal-title').innerText = "Edit Allocation";
                document.getElementById('new-item-amount').value=item.amount; 
                document.getElementById('new-item-category-input').value=item.name; 
                document.getElementById('btn-save-allocation').innerText = "Update Plan";
                
                selectedCategoryIcon = item.icon || 'tag';
                renderIconGrid();
                const iconConfig = CATEGORY_ICONS.find(i => i.id === selectedCategoryIcon) || { icon: 'tag' };
                document.getElementById('selected-icon-preview').innerHTML = `<i data-lucide="${iconConfig.icon}" class="w-4 h-4 text-cyan-600"></i>`;
                
                el.classList.remove('hidden'); 
                if(typeof lucide !== 'undefined') lucide.createIcons();
            } 
        }

        function closeAddModal() { const el=document.getElementById('add-modal'); if(el) el.classList.add('hidden'); }

        function submitNewAllocation() { 
            const amount=Number(document.getElementById('new-item-amount').value); 
            const catName=document.getElementById('new-item-category-input').value.trim(); 
            if(!amount||!catName) return showCustomAlert("Error", "Please fill in plan name and amount"); 
            
            const data = {
                id: editingId || Date.now(),
                name: catName, 
                amount: amount,
                category: catName, 
                icon: selectedCategoryIcon,
                provider: 'planned' 
            };

            if(editingId) { 
                const idx=state.allocations.findIndex(x=>x.id===editingId); 
                if(idx!==-1) state.allocations[idx]=data; 
            } else state.allocations.push(data); 
            
            closeAddModal(); 
            saveData(); 
            renderApp(); 
        }

        function deleteCurrentAllocation() { 
            if(editingId) { 
                if(window.showConfirmModal) {
                    window.showConfirmModal("Delete Allocation?", "Remove this item from your budget plan?", () => {
                        state.allocations=state.allocations.filter(x=>x.id!==editingId); 
                        closeAddModal(); 
                        saveData(); 
                        renderApp(); 
                    });
                } else if(confirm("Delete Allocation?")) {
                    state.allocations=state.allocations.filter(x=>x.id!==editingId); 
                    closeAddModal(); 
                    saveData(); 
                    renderApp(); 
                }
            } 
        }

        /* --- NEW: BUDGET SOURCE LOGIC --- */
        function openBudgetSourceModal() {
            const container = document.getElementById('budget-source-list');
            if(!container) return;
            container.innerHTML = '';

            const dailyAccounts = state.accounts.filter(a => a.tag !== 'credit' && a.tag !== 'savings');
            
            if (dailyAccounts.length === 0) {
                container.innerHTML = '<div class="text-[10px] text-gray-400 text-center py-4">No daily accounts available.</div>';
            } else {
                dailyAccounts.forEach(acc => {
                    let provider = PROVIDERS.find(p => p.id === acc.providerId) || { color: 'bg-gray-600', icon: 'wallet' };
                    container.insertAdjacentHTML('beforeend', `
                        <div onclick="setBudgetFromAccount(${acc.balance})" class="flex items-center justify-between p-2 rounded-xl bg-gray-50 dark:bg-gray-800 border border-transparent hover:border-cyan-500 cursor-pointer transition-all">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-lg ${provider.color} flex items-center justify-center text-white"><i data-lucide="${provider.icon}" class="w-4 h-4"></i></div>
                                <div>
                                    <h4 class="text-xs font-bold text-gray-900 dark:text-white">${acc.name}</h4>
                                    <p class="text-[9px] text-gray-500">Current Balance</p>
                                </div>
                            </div>
                            <span class="text-sm font-bold text-gray-900 dark:text-white">₱${acc.balance.toLocaleString()}</span>
                        </div>
                    `);
                });
            }
            
            document.getElementById('budget-source-modal').classList.remove('hidden');
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function closeBudgetSourceModal() {
            document.getElementById('budget-source-modal').classList.add('hidden');
        }

        function setBudgetFromAccount(amount) {
            state.totalBudget = Number(amount);
            document.getElementById('income-input').value = amount;
            updateTotals();
            saveData();
            closeBudgetSourceModal();
        }
    </script>
</body>
</html>