<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund Flow - Savings</title>
    <link id="favicon" rel="icon" type="image/png" href="images/fundflow-logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>tailwind.config = { darkMode: 'class', theme: { extend: { colors: { dark: { bg: '#000000', card: '#111827' } } } } }</script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .hidden { display: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.2em 1.2em;
        }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #E5E7EB; border-radius: 10px; }
        .dark .custom-scroll::-webkit-scrollbar-thumb { background: #374151; }
    </style>

    <!-- IMMEDIATE THEME INIT (Prevents Flash) -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const isDark = savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>

    <script type="module">
        import { auth, db } from "./firebase-config.js";
        import { onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.auth = auth;
        window.db = db;
        
        window.logout = () => { 
            if(window.showConfirmModal) {
                window.showConfirmModal("Sign Out", "Are you sure you want to sign out?", () => signOut(auth).then(() => window.location.href = 'index.html'));
            } else { 
                if(confirm("Sign Out?")) signOut(auth).then(() => window.location.href = 'index.html'); 
            }
        };

        window.handleDeleteAccount = async () => {
            window.showConfirmModal("DELETE ACCOUNT", "WARNING: This will permanently delete your account and ALL your data. This action cannot be undone.", async () => {
                const user = auth.currentUser;
                try {
                    await deleteDoc(doc(db, 'artifacts', 'fundflow-default', 'users', user.uid, 'data', 'mainState'));
                    await deleteUser(user);
                    window.showCustomAlert("Account Deleted", "Redirecting...");
                    setTimeout(() => window.location.href = 'index.html', 2000);
                } catch (e) {
                    window.showCustomAlert("Security Check", "Please sign out and sign in again before deleting your account.");
                }
            });
        };

        // ROBUST DATA SYNC
        window.saveData = async () => {
            if (!window.state) return;
            // Update timestamp first to claim this version is "newest"
            window.state.lastUpdated = Date.now();
            localStorage.setItem('moneyFlowStateV3', JSON.stringify(window.state));
            
            const user = auth.currentUser;
            if (user) {
                try {
                    await setDoc(doc(db, 'artifacts', 'fundflow-default', 'users', user.uid, 'data', 'mainState'), window.state);
                    console.log("Cloud Save Success");
                } catch (e) { console.error("Cloud Save Error:", e); }
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                try {
                    const docRef = doc(db, 'artifacts', 'fundflow-default', 'users', user.uid, 'data', 'mainState');
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const cloudData = docSnap.data();
                        const localData = window.state || {};
                        
                        const cloudTime = cloudData.lastUpdated || 0;
                        const localTime = localData.lastUpdated || 0;

                        const isLocalEmpty = (!localData.accounts || localData.accounts.length === 0) && 
                                             (!localData.expenses || localData.expenses.length === 0);
                        
                        const isCloudHasData = (cloudData.accounts && cloudData.accounts.length > 0);

                        // Sync Logic: Choose the freshest data
                        if (isLocalEmpty && isCloudHasData) {
                             console.log("Sync: Local is empty. Force pulling from Cloud.");
                             window.state = { ...cloudData };
                             localStorage.setItem('moneyFlowStateV3', JSON.stringify(window.state));
                        } else if (cloudTime > localTime) {
                            console.log("Sync: Cloud is newer. Updating local.");
                            window.state = { ...window.state, ...cloudData };
                            localStorage.setItem('moneyFlowStateV3', JSON.stringify(window.state));
                        } else if (localTime > cloudTime) {
                            console.log("Sync: Local is newer. Pushing to cloud.");
                            window.saveData(); 
                        } else {
                            if(!window.state || Object.keys(window.state).length === 0) {
                                window.state = { ...cloudData };
                            }
                        }
                    } else {
                        // Initialize if no cloud data
                        if(!window.state) {
                            window.state = {
                                accounts: [], expenses: [], savings: [], allocations: [], 
                                transfers: [], savingsHistory: [], income: 0, lastUpdated: Date.now()
                            };
                        }
                        saveData(); 
                    }
                    
                    // Render UI after sync
                    if(window.renderApp) window.renderApp();
                    
                    // Restore Income Input
                    if (window.state && window.state.income) {
                        const incomeInput = document.getElementById('income-input');
                        if(incomeInput) incomeInput.value = window.state.income;
                        if(window.updateTotals) window.updateTotals();
                    }

                } catch (e) {
                    console.error("Sync Error:", e);
                }
            }
        });
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-950 text-gray-900 dark:text-gray-100 flex justify-center min-h-screen p-2 text-[10px] md:text-xs">

    <div class="w-full max-w-6xl bg-white dark:bg-black min-h-[90vh] shadow-2xl relative border border-gray-200 dark:border-gray-800 rounded-3xl flex flex-col md:flex-row overflow-hidden my-auto z-10">
        
        <aside class="w-full md:w-64 lg:w-72 bg-gray-50/80 dark:bg-gray-900/50 border-r border-gray-200 dark:border-gray-800 p-4 flex flex-col relative overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <img src="images/fundflow-logo.png" alt="Logo" class="w-6 h-6 object-contain drop-shadow-sm hover:scale-105 transition-transform">
                    <div>
                        <h1 class="text-sm font-bold tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-blue-600">FUND FLOW</h1>
                        <p class="text-[8px] text-gray-500 uppercase tracking-widest leading-none">Finance Manager</p>
                    </div>
                </div>
                <div class="flex gap-1">
                    <button onclick="toggleTheme()" class="p-1.5 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-500 hover:text-cyan-500 transition-colors">
                         <i data-lucide="moon" class="icon-moon w-3 h-3 hidden"></i>
                         <i data-lucide="sun" class="icon-sun w-3 h-3 hidden"></i>
                    </button>
                    <!-- SETTINGS TOGGLE (Uses settings.js) -->
                    <button onclick="toggleSettings(true)" class="p-1.5 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-500 hover:text-cyan-500 transition-colors">
                        <i data-lucide="settings" class="w-3 h-3"></i>
                    </button>
                    <button onclick="logout()" class="p-1.5 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors" title="Sign Out">
                        <i data-lucide="log-out" class="w-3 h-3"></i>
                    </button>
                </div>
            </div>

            <!-- Total Savings Card -->
            <div class="bg-gradient-to-br from-cyan-50 to-blue-50 dark:from-cyan-900/20 dark:to-blue-900/20 rounded-xl p-3 border border-cyan-100 dark:border-cyan-900/30 shadow-sm relative overflow-hidden mb-3">
                <label class="text-cyan-600 dark:text-cyan-400 text-[9px] font-bold uppercase tracking-wider mb-0.5 block flex items-center gap-1">
                    <i data-lucide="piggy-bank" class="w-3 h-3"></i> Total Savings
                </label>
                <div class="flex flex-col mb-2">
                    <span id="total-saved-display" class="text-xl font-black text-gray-900 dark:text-white tracking-tight">₱0</span>
                    <span id="savings-progress-display" class="text-[9px] text-gray-500 dark:text-gray-400 font-medium">0% of Goal Reached</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-800 rounded-full h-1.5 overflow-hidden mb-1">
                    <div id="total-savings-bar" class="bg-gradient-to-r from-cyan-500 to-blue-600 h-1.5 rounded-full transition-all duration-700" style="width: 0%"></div>
                </div>
                <div class="flex justify-between items-center text-[9px]">
                    <span class="text-gray-400">Target</span>
                    <span id="total-target-display" class="font-bold text-gray-600 dark:text-gray-300">₱0</span>
                </div>
            </div>

            <!-- Savings Velocity Card -->
            <div class="bg-white dark:bg-gray-900 rounded-xl p-3 border border-gray-200 dark:border-gray-800 shadow-sm mb-4">
                <h4 class="text-[9px] font-bold text-gray-500 uppercase tracking-wider mb-2 flex items-center gap-1"><i data-lucide="trending-up" class="w-3 h-3"></i> Savings Growth</h4>
                <div class="grid grid-cols-2 gap-2">
                    <div class="bg-green-50 dark:bg-green-900/10 rounded-lg p-2 border border-green-100 dark:border-green-900/20">
                        <span class="block text-[8px] text-green-600 dark:text-green-400 font-bold uppercase mb-0.5 flex items-center gap-1">
                            <i data-lucide="calendar-check" class="w-2.5 h-2.5"></i> This Week
                        </span>
                        <span id="stat-week-display" class="block text-xs font-black text-gray-900 dark:text-white">₱0</span>
                    </div>
                    <div class="bg-blue-50 dark:bg-blue-900/10 rounded-lg p-2 border border-blue-100 dark:border-blue-900/20">
                        <span class="block text-[8px] text-blue-600 dark:text-blue-400 font-bold uppercase mb-0.5 flex items-center gap-1">
                            <i data-lucide="calendar-days" class="w-2.5 h-2.5"></i> This Month
                        </span>
                        <span id="stat-month-display" class="block text-xs font-black text-gray-900 dark:text-white">₱0</span>
                    </div>
                </div>
            </div>

            <div class="flex-1">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-cyan-600 dark:text-cyan-400 text-[10px] font-bold flex items-center gap-1.5"><i data-lucide="wallet" class="w-3 h-3"></i> Savings Account</h3>
                </div>
                <div id="accounts-list" class="space-y-1 overflow-y-auto max-h-[30vh] pr-1"></div>
            </div>
        </aside>

        <main class="flex-1 p-4 lg:p-6 overflow-y-auto pb-20 bg-white dark:bg-black relative">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h2 class="text-base font-semibold text-gray-900 dark:text-white flex items-center gap-2"><i data-lucide="piggy-bank" class="text-cyan-500 w-4 h-4"></i> Savings Goals</h2>
                    <p class="text-[9px] text-gray-500 mt-0.5">Track your progress and hit your targets.</p>
                </div>
                <button onclick="openAddSavingsModal()" class="bg-cyan-600 hover:bg-cyan-500 text-white text-[9px] font-bold py-2 px-3 rounded-lg flex items-center gap-1.5 shadow-lg shadow-cyan-500/20 transition-all hover:scale-105">
                    <i data-lucide="plus-circle" class="w-3 h-3"></i> 
                    <span class="hidden sm:inline">New Goal</span>
                </button>
            </div>

            <div id="savings-grid" class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-3 mb-8"></div>

            <div class="fixed bottom-14 left-0 right-0 md:left-64 lg:left-72 flex justify-center z-50 pointer-events-none">
                <nav class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl border border-gray-200 dark:border-gray-800 shadow-2xl rounded-full px-4 py-2 flex items-center gap-1 pointer-events-auto transition-all hover:scale-105">
                    <a href="dashboard.html" class="flex flex-col items-center justify-center w-12 h-10 rounded-xl text-gray-400 hover:text-cyan-600 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all">
                        <i data-lucide="layout-dashboard" class="w-3.5 h-3.5 mb-0.5"></i>
                        <span class="text-[8px] font-medium">Home</span>
                    </a>
                    <a href="budget.html" class="flex flex-col items-center justify-center w-12 h-10 rounded-xl text-gray-400 hover:text-cyan-600 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all">
                        <i data-lucide="pie-chart" class="w-3.5 h-3.5 mb-0.5"></i>
                        <span class="text-[8px] font-medium">Budget</span>
                    </a>
                    <a href="savings.html" class="flex flex-col items-center justify-center w-12 h-10 rounded-xl bg-cyan-50 dark:bg-cyan-900/20 text-cyan-600 dark:text-cyan-400 transition-all">
                        <i data-lucide="piggy-bank" class="w-3.5 h-3.5 mb-0.5"></i>
                        <span class="text-[8px] font-bold">Save</span>
                    </a>
                    <a href="accounts.html" class="flex flex-col items-center justify-center w-12 h-10 rounded-xl text-gray-400 hover:text-cyan-600 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all">
                        <i data-lucide="wallet" class="w-3.5 h-3.5 mb-0.5"></i>
                        <span class="text-[8px] font-medium">Wallet</span>
                    </a>
                </nav>
            </div>
        </main>

        <!-- VIEW GOAL DETAILS MODAL (NEW) -->
        <div id="view-goal-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 hidden">
            <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 w-full max-w-sm rounded-2xl p-0 shadow-2xl animate-fade-in flex flex-col h-auto max-h-[85vh] overflow-hidden">
                
                <!-- Hero Header -->
                <div class="relative bg-gradient-to-r from-cyan-600 to-blue-600 p-5 pb-8">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-center gap-3">
                            <div id="view-goal-icon" class="w-10 h-10 rounded-xl bg-white/20 backdrop-blur-sm flex items-center justify-center text-white shadow-inner">
                                <i data-lucide="piggy-bank" class="w-5 h-5"></i>
                            </div>
                            <div>
                                <h2 id="view-goal-name" class="text-lg font-black text-white leading-tight">Goal Name</h2>
                                <p id="view-goal-target" class="text-[10px] text-cyan-100 font-medium">Target: ₱0</p>
                            </div>
                        </div>
                        <button onclick="closeViewGoalModal()" class="text-white/70 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                    
                    <div class="mb-1">
                        <div class="flex justify-between text-white text-[10px] font-bold mb-1">
                            <span id="view-goal-current">₱0</span>
                            <span id="view-goal-percent">0%</span>
                        </div>
                        <div class="w-full bg-black/20 rounded-full h-1.5 overflow-hidden backdrop-blur-sm">
                            <div id="view-goal-bar" class="bg-white h-1.5 rounded-full transition-all duration-700" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="flex border-b border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900 px-4 -mt-4 rounded-t-2xl relative z-10 pt-2">
                    <button onclick="switchViewTab('history')" id="tab-btn-history" class="flex-1 pb-2 text-[10px] font-bold text-cyan-600 border-b-2 border-cyan-600 transition-colors">
                        Transaction History
                    </button>
                    <button onclick="switchViewTab('monthly')" id="tab-btn-monthly" class="flex-1 pb-2 text-[10px] font-medium text-gray-400 border-b-2 border-transparent hover:text-gray-600 dark:hover:text-gray-300 transition-colors">
                        Monthly Summary
                    </button>
                </div>

                <!-- Content Area -->
                <div class="flex-1 overflow-y-auto p-4 bg-gray-50 dark:bg-black/20 custom-scroll relative">
                    
                    <!-- History Tab -->
                    <div id="view-tab-history" class="space-y-2">
                        <!-- History List populated via JS -->
                        <div id="goal-history-list" class="space-y-2"></div>
                    </div>

                    <!-- Monthly Tab -->
                    <div id="view-tab-monthly" class="hidden space-y-2">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="text-[9px] text-gray-400 uppercase tracking-wider border-b border-gray-200 dark:border-gray-800">
                                    <th class="py-2 pl-2">Month</th>
                                    <th class="py-2 text-right pr-2">Total Saved</th>
                                </tr>
                            </thead>
                            <tbody id="goal-monthly-table" class="text-[10px]"></tbody>
                        </table>
                    </div>

                </div>

                <!-- Footer Action -->
                <div class="p-3 border-t border-gray-100 dark:border-gray-800 bg-white dark:bg-gray-900">
                    <button id="view-btn-edit" class="w-full bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 text-gray-900 dark:text-white font-bold py-2.5 rounded-xl text-[10px] flex items-center justify-center gap-2 transition-colors">
                        <i data-lucide="edit-2" class="w-3 h-3"></i> Edit Goal Details
                    </button>
                </div>
            </div>
        </div>

        <!-- ADD/EDIT MODAL (Hidden logic same as before but triggers from View Modal now) -->
        <div id="savings-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] flex items-center justify-center p-4 hidden">
            <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 w-full max-w-sm rounded-2xl p-4 shadow-2xl animate-fade-in flex flex-col h-auto max-h-[90vh]">
                <div class="flex justify-between items-center mb-3 pb-2 border-b border-gray-100 dark:border-gray-800">
                    <h3 id="savings-modal-title" class="font-bold text-sm text-gray-900 dark:text-white">New Savings Goal</h3>
                    <button onclick="closeSavingsModal()" class="text-gray-500 hover:text-gray-900 dark:hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
                
                <div class="overflow-y-auto pr-1 space-y-2.5">
                    <div class="flex items-center gap-2">
                        <div class="relative shrink-0">
                            <div onclick="toggleIconGrid()" id="icon-preview-btn" class="w-9 h-9 rounded-xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center cursor-pointer hover:ring-2 hover:ring-cyan-500 transition-all text-gray-500">
                                <i data-lucide="piggy-bank" class="w-4 h-4"></i>
                            </div>
                            <div id="icon-dropdown" class="absolute top-full left-0 mt-2 w-64 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl z-50 p-2 hidden grid grid-cols-6 gap-1.5"></div>
                        </div>
                        <div class="flex-grow">
                            <input type="text" id="savings-name" placeholder="Goal Name (e.g. New Laptop)" class="w-full h-9 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 text-[10px] dark:text-white focus:border-cyan-500 outline-none">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-[9px] font-bold text-gray-500 mb-1 uppercase tracking-wider">Target</label>
                            <input type="number" id="savings-target" placeholder="0.00" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg py-2 pl-2 pr-2 text-[10px] font-bold dark:text-white focus:border-cyan-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-[9px] font-bold text-gray-500 mb-1 uppercase tracking-wider">Current</label>
                            <input type="number" id="savings-current" placeholder="0.00" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg py-2 pl-2 pr-2 text-[10px] font-bold dark:text-white focus:border-cyan-500 outline-none">
                        </div>
                    </div>

                    <div>
                        <label class="block text-[9px] font-bold text-gray-500 mb-1 uppercase tracking-wider">Target Date</label>
                        <input type="date" id="savings-date" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg p-2 text-[10px] dark:text-white focus:border-cyan-500 outline-none">
                    </div>

                    <div>
                        <label class="block text-[9px] font-bold text-gray-500 mb-1 uppercase tracking-wider">Source Account</label>
                        <div class="h-24 overflow-y-auto border border-gray-200 dark:border-gray-800 rounded-xl bg-gray-50/50 dark:bg-gray-900/50 p-1 custom-scroll">
                            <div id="savings-source-grid" class="grid grid-cols-2 gap-1"></div>
                        </div>
                    </div>

                    <div class="flex items-center gap-2 p-1.5 bg-gray-50 dark:bg-gray-800/50 rounded-lg border border-gray-200 dark:border-gray-700">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="savings-include" class="sr-only peer">
                            <div class="w-6 h-3.5 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-2.5 after:w-2.5 after:transition-all dark:border-gray-600 peer-checked:bg-cyan-600"></div>
                            <span class="ms-2 text-[9px] font-medium text-gray-600 dark:text-gray-300">Include in Total Assets</span>
                        </label>
                    </div>
                </div>

                <div class="pt-3 mt-2 border-t border-gray-200 dark:border-gray-700 flex gap-2">
                    <button onclick="submitNewSavings()" class="flex-1 bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 rounded-xl shadow-md transition-all text-[10px]">Save Goal</button>
                    <button id="btn-delete-savings" onclick="deleteCurrentSavings()" class="hidden px-2.5 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-xl transition-colors"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                </div>
            </div>
        </div>
        
    </div>

    <script src="script.js"></script>
    <script src="settings.js"></script>
    <script>
        window.renderApp = renderApp;
        window.openAddSavingsModal = openAddSavingsModal;
        window.closeSavingsModal = closeSavingsModal;
        window.submitNewSavings = submitNewSavings;
        window.deleteCurrentSavings = deleteCurrentSavings;
        window.openEditSavingsModal = openEditSavingsModal;
        window.renderSavingsSourceGrid = renderSavingsSourceGrid;
        window.renderSavingsIconGrid = renderSavingsIconGrid;
        window.toggleIconGrid = toggleIconGrid;
        window.selectIcon = selectIcon;
        // New Exports
        window.openViewGoalModal = openViewGoalModal;
        window.closeViewGoalModal = closeViewGoalModal;
        window.switchViewTab = switchViewTab;

        let editingId = null;
        let selectedSavingsSourceId = null;
        let selectedSavingsIconId = 'piggy-bank';
        let viewingGoalId = null;

        document.addEventListener('DOMContentLoaded', () => {
            try {
                loadState();
                if(window.initTheme) window.initTheme();
                renderApp();
                
                document.addEventListener('click', (e) => {
                    const dropdown = document.getElementById('icon-dropdown');
                    const btn = document.getElementById('icon-preview-btn');
                    if(dropdown && !dropdown.classList.contains('hidden') && !dropdown.contains(e.target) && !btn.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                });

            } catch (e) { console.error("Init error:", e); }
        });

        function renderApp() {
            renderSavings();
            updateTotals();
            renderAccountsSidebar();
            renderSavingsStats();
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function renderSavings() {
            const container = document.getElementById('savings-grid');
            if (!container) return;
            container.innerHTML = '';
            
            // Ensure data exists
            if(!window.state.savings) window.state.savings = [];

            window.state.savings.forEach(goal => {
                const percent = Math.min(100, Math.round((goal.current / goal.target) * 100)) || 0;
                // FIX: Look up visual from custom icons, fallback to providers only if necessary
                const customIcons = getIcons();
                let visual = customIcons.find(i => i.id === goal.icon);
                if (!visual) {
                    visual = PROVIDERS.find(p => p.id === goal.icon) || { color: 'bg-cyan-600', icon: 'piggy-bank' };
                }
                
                const linkedAcc = window.state.accounts.find(a => a.id === goal.source);
                const sourceName = linkedAcc ? linkedAcc.name : 'Unlinked';

                // CHANGED: Click opens VIEW modal now, not edit
                container.insertAdjacentHTML('beforeend', `
                    <div onclick="openViewGoalModal(${goal.id})" class="group cursor-pointer bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl p-3 hover:border-cyan-500 transition-all shadow-sm hover:shadow-cyan-500/10 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-16 h-16 bg-gradient-to-br from-cyan-500/10 to-blue-500/10 rounded-bl-[2.5rem] -mr-2 -mt-2 transition-transform group-hover:scale-110"></div>
                        <div class="flex justify-between items-start mb-2 relative z-10">
                            <div class="w-8 h-8 rounded-lg ${visual.color} flex items-center justify-center text-white shadow-lg shadow-cyan-500/20">
                                <i data-lucide="${visual.icon}" class="w-4 h-4"></i>
                            </div>
                            <div class="text-right">
                                <span class="text-[8px] text-gray-400 uppercase tracking-wider font-semibold block mb-0.5">Target</span>
                                <span class="text-[10px] font-bold text-gray-900 dark:text-white">₱${Number(goal.target).toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="mb-2 relative z-10">
                            <h3 class="font-bold text-sm text-gray-900 dark:text-white mb-0.5 truncate">${goal.name}</h3>
                            <div class="flex items-center gap-1 text-[9px] text-gray-500">
                                <i data-lucide="lock" class="w-2.5 h-2.5"></i>
                                <span>Locked in <span class="font-semibold text-gray-700 dark:text-gray-300">${sourceName}</span></span>
                            </div>
                        </div>
                        <div class="relative pt-1 z-10">
                            <div class="flex justify-between text-[9px] mb-1">
                                <span class="font-bold text-cyan-600 dark:text-cyan-400">₱${Number(goal.current).toLocaleString()}</span>
                                <span class="font-bold text-gray-500">${percent}%</span>
                            </div>
                            <div class="w-full bg-gray-100 dark:bg-gray-800 rounded-full h-2 overflow-hidden">
                                <div class="bg-gradient-to-r from-cyan-500 to-blue-600 h-2 rounded-full transition-all duration-500" style="width: ${percent}%"></div>
                            </div>
                        </div>
                    </div>
                `);
            });

            if (window.state.savings.length === 0) {
                container.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-10 text-center border-2 border-dashed border-gray-200 dark:border-gray-800 rounded-xl"><div class="w-10 h-10 bg-gray-100 dark:bg-gray-900 rounded-full flex items-center justify-center text-gray-400 mb-3"><i data-lucide="piggy-bank" class="w-5 h-5"></i></div><h3 class="text-xs font-bold text-gray-900 dark:text-white mb-0.5">No Goals Yet</h3><p class="text-[10px] text-gray-500 max-w-xs mx-auto mb-2">Create a savings goal to start tracking.</p><button onclick="openAddSavingsModal()" class="text-cyan-600 hover:text-cyan-500 font-bold text-[10px]">Create First Goal</button></div>`;
            }
        }

        // --- NEW VIEW MODAL LOGIC ---
        function openViewGoalModal(id) {
            const goal = window.state.savings.find(g => g.id === id);
            if (!goal) return;
            
            viewingGoalId = id;
            
            // Populate Header
            document.getElementById('view-goal-name').innerText = goal.name;
            document.getElementById('view-goal-target').innerText = `Target: ₱${Number(goal.target).toLocaleString()}`;
            document.getElementById('view-goal-current').innerText = `₱${Number(goal.current).toLocaleString()}`;
            
            const percent = Math.min(100, Math.round((goal.current / goal.target) * 100)) || 0;
            document.getElementById('view-goal-percent').innerText = `${percent}%`;
            document.getElementById('view-goal-bar').style.width = `${percent}%`;
            
            // FIX: Look up visual from custom icons here too
            const customIcons = getIcons();
            let visual = customIcons.find(i => i.id === goal.icon);
            if (!visual) {
                visual = PROVIDERS.find(p => p.id === goal.icon) || { color: 'bg-cyan-600', icon: 'piggy-bank' };
            }

            const iconContainer = document.getElementById('view-goal-icon');
            iconContainer.className = `w-10 h-10 rounded-xl flex items-center justify-center text-white shadow-inner ${visual.color}`;
            iconContainer.innerHTML = `<i data-lucide="${visual.icon}" class="w-5 h-5"></i>`;

            // Populate History
            renderGoalHistory(id);
            renderMonthlySummary(id);

            // Set Edit Button Action
            document.getElementById('view-btn-edit').onclick = () => {
                closeViewGoalModal();
                openEditSavingsModal(id);
            };

            // Reset Tab
            switchViewTab('history');
            document.getElementById('view-goal-modal').classList.remove('hidden');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function closeViewGoalModal() {
            document.getElementById('view-goal-modal').classList.add('hidden');
        }

        function switchViewTab(tab) {
            const historyTab = document.getElementById('view-tab-history');
            const monthlyTab = document.getElementById('view-tab-monthly');
            const btnHistory = document.getElementById('tab-btn-history');
            const btnMonthly = document.getElementById('tab-btn-monthly');

            if(tab === 'history') {
                historyTab.classList.remove('hidden');
                monthlyTab.classList.add('hidden');
                btnHistory.className = "flex-1 pb-2 text-[10px] font-bold text-cyan-600 border-b-2 border-cyan-600 transition-colors";
                btnMonthly.className = "flex-1 pb-2 text-[10px] font-medium text-gray-400 border-b-2 border-transparent hover:text-gray-600 dark:hover:text-gray-300 transition-colors";
            } else {
                historyTab.classList.add('hidden');
                monthlyTab.classList.remove('hidden');
                btnHistory.className = "flex-1 pb-2 text-[10px] font-medium text-gray-400 border-b-2 border-transparent hover:text-gray-600 dark:hover:text-gray-300 transition-colors";
                btnMonthly.className = "flex-1 pb-2 text-[10px] font-bold text-cyan-600 border-b-2 border-cyan-600 transition-colors";
            }
        }

        function renderGoalHistory(goalId) {
            const list = document.getElementById('goal-history-list');
            list.innerHTML = '';
            
            const history = (window.state.savingsHistory || []).filter(h => h.goalId === goalId).sort((a,b) => b.date - a.date);
            
            if (history.length === 0) {
                list.innerHTML = '<div class="text-center text-[9px] text-gray-400 py-4">No recent transactions.</div>';
                return;
            }

            history.forEach(tx => {
                const dateStr = new Date(tx.date).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
                // Source Logic: Try to find account name from stored sourceId, else unknown
                const sourceAcc = window.state.accounts.find(a => a.id === tx.sourceId);
                const sourceName = sourceAcc ? sourceAcc.name : (tx.sourceId ? 'Unknown Account' : 'Manual Deposit');

                list.insertAdjacentHTML('beforeend', `
                    <div class="flex justify-between items-center p-2 bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-xl">
                        <div class="flex items-center gap-2">
                            <div class="w-7 h-7 rounded-lg bg-green-50 dark:bg-green-900/20 text-green-600 flex items-center justify-center">
                                <i data-lucide="arrow-down-left" class="w-3.5 h-3.5"></i>
                            </div>
                            <div>
                                <div class="text-[9px] font-bold text-gray-900 dark:text-white">Deposit</div>
                                <div class="text-[8px] text-gray-400">From: ${sourceName}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-[9px] font-bold text-green-600 dark:text-green-400">+₱${Number(tx.amount).toLocaleString()}</div>
                            <div class="text-[8px] text-gray-400">${dateStr}</div>
                        </div>
                    </div>
                `);
            });
        }

        function renderMonthlySummary(goalId) {
            const tbody = document.getElementById('goal-monthly-table');
            tbody.innerHTML = '';
            
            const history = (window.state.savingsHistory || []).filter(h => h.goalId === goalId);
            const monthlyData = {};

            history.forEach(tx => {
                const date = new Date(tx.date);
                const key = date.toLocaleString('default', { month: 'long', year: 'numeric' });
                monthlyData[key] = (monthlyData[key] || 0) + Number(tx.amount);
            });

            if (Object.keys(monthlyData).length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" class="text-center text-gray-400 py-4 italic">No data yet</td></tr>';
                return;
            }

            Object.keys(monthlyData).forEach(month => {
                tbody.insertAdjacentHTML('beforeend', `
                    <tr class="border-b border-gray-100 dark:border-gray-800 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-800/50">
                        <td class="py-2 pl-2 font-medium text-gray-700 dark:text-gray-300">${month}</td>
                        <td class="py-2 pr-2 text-right font-bold text-cyan-600 dark:text-cyan-400">₱${monthlyData[month].toLocaleString()}</td>
                    </tr>
                `);
            });
        }

        // --- END NEW VIEW MODAL LOGIC ---

        function updateTotals() {
            if(!window.state.savings) return;
            const totalSaved = window.state.savings.reduce((sum, goal) => sum + Number(goal.current), 0);
            const totalTarget = window.state.savings.reduce((sum, goal) => sum + Number(goal.target), 0);
            const percent = totalTarget > 0 ? Math.round((totalSaved / totalTarget) * 100) : 0;
            document.getElementById('total-saved-display').innerText = `₱${totalSaved.toLocaleString()}`;
            document.getElementById('total-target-display').innerText = `₱${totalTarget.toLocaleString()}`;
            document.getElementById('savings-progress-display').innerText = `${percent}% of Goal Reached`;
            document.getElementById('total-savings-bar').style.width = `${percent}%`;
        }

        function renderSavingsStats() {
            if(!window.state.savingsHistory) window.state.savingsHistory = [];
            const history = window.state.savingsHistory;
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            startOfWeek.setHours(0,0,0,0);
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            let weekTotal = 0;
            let monthTotal = 0;
            history.forEach(item => {
                const itemDate = new Date(item.date);
                if (itemDate >= startOfWeek) weekTotal += Number(item.amount);
                if (itemDate >= startOfMonth) monthTotal += Number(item.amount);
            });
            const elWeek = document.getElementById('stat-week-display');
            const elMonth = document.getElementById('stat-month-display');
            if(elWeek) elWeek.innerText = `₱${weekTotal.toLocaleString()}`;
            if(elMonth) elMonth.innerText = `₱${monthTotal.toLocaleString()}`;
        }

        function renderAccountsSidebar() {
            const sidebarList = document.getElementById('accounts-list');
            if(!sidebarList) return;
            const savingsBySource = {};
            if(window.state.savings) {
                window.state.savings.forEach(goal => {
                    if (goal.includeInTotal) savingsBySource[goal.source] = (savingsBySource[goal.source] || 0) + Number(goal.current);
                });
            }
            if(!window.state.accounts) window.state.accounts = [];
            const validAccounts = window.state.accounts.filter(a => a.tag === 'savings');
            if (validAccounts.length === 0) {
                 sidebarList.innerHTML = '<div class="text-[9px] text-gray-400 text-center py-2">No savings accounts found.</div>';
                 return;
            }
            sidebarList.innerHTML = validAccounts.map(acc => {
                let provider = PROVIDERS.find(p => p.id === acc.providerId) || { color: 'bg-gray-600', icon: 'wallet' };
                const total = acc.balance + (savingsBySource[acc.id] || 0);
                return `<div class="flex justify-between items-center p-1 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"><div class="flex items-center gap-1.5 overflow-hidden flex-1"><div class="w-4 h-4 rounded-md ${provider.color} flex items-center justify-center text-white shrink-0"><i data-lucide="${provider.icon}" class="w-2.5 h-2.5"></i></div><span class="text-[9px] font-medium text-gray-700 dark:text-gray-300 truncate">${acc.name}</span></div><span class="text-[9px] font-bold text-gray-900 dark:text-white pl-1">₱${total.toLocaleString()}</span></div>`
            }).join('');
        }

        function openAddSavingsModal() {
            editingId = null;
            document.getElementById('savings-modal-title').innerText = "New Savings Goal";
            document.getElementById('savings-name').value = '';
            document.getElementById('savings-target').value = '';
            document.getElementById('savings-current').value = '';
            document.getElementById('savings-date').value = '';
            document.getElementById('savings-include').checked = true;
            document.getElementById('btn-delete-savings').classList.add('hidden');
            const savingsAcc = window.state.accounts.find(a => a.tag === 'savings');
            const dailyAcc = window.state.accounts.find(a => a.tag === 'daily' || (!a.tag && a.type !== 'credit'));
            selectedSavingsSourceId = savingsAcc ? savingsAcc.id : (dailyAcc ? dailyAcc.id : null);
            selectedSavingsIconId = 'piggy-bank';
            renderSavingsSourceGrid();
            renderSavingsIconGrid();
            updateIconPreview();
            document.getElementById('savings-modal').classList.remove('hidden');
        }

        function openEditSavingsModal(id) {
            const goal = window.state.savings.find(g => g.id === id);
            if (!goal) return;
            editingId = id;
            document.getElementById('savings-modal-title').innerText = "Edit Goal";
            document.getElementById('savings-name').value = goal.name;
            document.getElementById('savings-target').value = goal.target;
            document.getElementById('savings-current').value = goal.current;
            document.getElementById('savings-date').value = goal.date;
            document.getElementById('savings-include').checked = goal.includeInTotal;
            document.getElementById('btn-delete-savings').classList.remove('hidden');
            selectedSavingsSourceId = goal.source;
            selectedSavingsIconId = goal.icon;
            renderSavingsSourceGrid();
            renderSavingsIconGrid();
            updateIconPreview();
            document.getElementById('savings-modal').classList.remove('hidden');
        }

        function closeSavingsModal() {
            document.getElementById('savings-modal').classList.add('hidden');
            document.getElementById('icon-dropdown').classList.add('hidden');
        }

        function renderSavingsSourceGrid() {
            const container = document.getElementById('savings-source-grid');
            if (!container) return;
            container.innerHTML = '';
            const validAccounts = window.state.accounts.filter(a => a.tag !== 'credit' && a.type !== 'credit');
            validAccounts.forEach(acc => {
                const provider = PROVIDERS.find(p => p.id === acc.providerId) || { color: 'bg-gray-600', icon: 'wallet' };
                const isSel = selectedSavingsSourceId == acc.id;
                const isSavings = acc.tag === 'savings';
                const tag = isSavings ? '<span class="text-[8px] text-cyan-500 font-bold ml-1">(Savings)</span>' : '';
                container.insertAdjacentHTML('beforeend', `<div onclick="selectedSavingsSourceId='${acc.id}'; renderSavingsSourceGrid();" class="cursor-pointer flex items-center gap-2 p-1.5 rounded-xl border transition-all ${isSel ? 'ring-2 ring-cyan-500 bg-cyan-50 dark:bg-cyan-900/20 border-transparent' : 'border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800'}"><div class="w-5 h-5 rounded-lg ${provider.color} flex items-center justify-center text-white shrink-0"><i data-lucide="${provider.icon}" class="w-3 h-3"></i></div><div class="overflow-hidden flex-1"><span class="text-[10px] font-bold block truncate text-gray-900 dark:text-white">${acc.name} ${tag}</span><span class="text-[9px] text-gray-500 dark:text-gray-400 block">₱${acc.balance.toLocaleString()}</span></div>${isSel ? '<i data-lucide="check-circle-2" class="w-4 h-4 text-cyan-500 shrink-0"></i>' : ''}</div>`);
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function toggleIconGrid() { document.getElementById('icon-dropdown').classList.toggle('hidden'); }
        function selectIcon(id) { selectedSavingsIconId = id; updateIconPreview(); toggleIconGrid(); }
        function updateIconPreview() {
            const btn = document.getElementById('icon-preview-btn');
            const icons = getIcons();
            const selected = icons.find(i => i.id === selectedSavingsIconId) || icons[0];
            btn.className = `w-9 h-9 rounded-xl flex items-center justify-center cursor-pointer hover:opacity-90 transition-all text-white shadow-md ${selected.color}`;
            btn.innerHTML = `<i data-lucide="${selected.icon}" class="w-4 h-4"></i>`;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
        function getIcons() { return [{id:'piggy-bank',icon:'piggy-bank',color:'bg-pink-500'},{id:'car',icon:'car',color:'bg-blue-500'},{id:'home',icon:'home',color:'bg-green-500'},{id:'plane',icon:'plane',color:'bg-sky-500'},{id:'graduation-cap',icon:'graduation-cap',color:'bg-indigo-500'},{id:'smartphone',icon:'smartphone',color:'bg-purple-500'},{id:'laptop',icon:'laptop',color:'bg-gray-500'},{id:'gift',icon:'gift',color:'bg-red-500'},{id:'heart',icon:'heart',color:'bg-rose-500'},{id:'music',icon:'music',color:'bg-amber-500'},{id:'gamepad',icon:'gamepad-2',color:'bg-violet-500'},{id:'shopping-bag',icon:'shopping-bag',color:'bg-orange-500'},{id:'bike',icon:'bike',color:'bg-teal-500'},{id:'camera',icon:'camera',color:'bg-zinc-500'},{id:'watch',icon:'watch',color:'bg-emerald-500'}]; }
        function renderSavingsIconGrid() {
            const container = document.getElementById('icon-dropdown');
            if (!container) return;
            container.innerHTML = '';
            getIcons().forEach(i => {
                const isSel = selectedSavingsIconId === i.id;
                container.insertAdjacentHTML('beforeend', `<div onclick="selectIcon('${i.id}')" class="cursor-pointer w-7 h-7 rounded-lg flex items-center justify-center transition-all ${isSel ? i.color + ' text-white ring-2 ring-white dark:ring-gray-700' : 'bg-gray-100 dark:bg-gray-700 text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600'}"><i data-lucide="${i.icon}" class="w-3.5 h-3.5"></i></div>`);
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function submitNewSavings() {
            const name = document.getElementById('savings-name').value;
            const target = Number(document.getElementById('savings-target').value);
            const current = Number(document.getElementById('savings-current').value);
            const date = document.getElementById('savings-date').value;
            const include = document.getElementById('savings-include').checked;

            if (!name || !target || !selectedSavingsSourceId) return window.showCustomAlert("Error", "Please fill details and link an account");

            const data = { id: editingId || Date.now(), name, target, current, date, includeInTotal: include, source: selectedSavingsSourceId, icon: selectedSavingsIconId || 'piggy-bank' };
            
            // LOGIC: Record History + Source
            if (editingId) {
                const oldGoal = window.state.savings.find(x => x.id == editingId);
                const oldCurrent = oldGoal ? Number(oldGoal.current) : 0;
                if (current > oldCurrent) {
                    const diff = current - oldCurrent;
                    if (!window.state.savingsHistory) window.state.savingsHistory = [];
                    window.state.savingsHistory.push({
                        id: Date.now(),
                        date: Date.now(),
                        amount: diff,
                        goalId: editingId,
                        sourceId: selectedSavingsSourceId, // Save the source used for this update
                        type: 'deposit'
                    });
                }
            } else {
                if (current > 0) {
                     if (!window.state.savingsHistory) window.state.savingsHistory = [];
                     window.state.savingsHistory.push({
                        id: Date.now(),
                        date: Date.now(),
                        amount: current,
                        goalId: data.id,
                        sourceId: selectedSavingsSourceId,
                        type: 'deposit'
                    });
                }
            }

            if (editingId) {
                const idx = window.state.savings.findIndex(x => x.id == editingId);
                if (idx !== -1) window.state.savings[idx] = data;
            } else { window.state.savings.push(data); }
            
            closeSavingsModal();
            saveData();
            renderApp();
        }

        function deleteCurrentSavings() {
            if (editingId) {
                window.showConfirmModal("Delete Goal?", "Are you sure you want to delete this goal?", () => {
                    window.state.savings = window.state.savings.filter(x => x.id != editingId);
                    closeSavingsModal();
                    saveData();
                    renderApp();
                });
            }
        }
    </script>
</body>
</html>