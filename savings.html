<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund Flow - Savings</title>
    <link id="favicon" rel="icon" type="image/png" href="images/fundflow-logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>tailwind.config = { darkMode: 'class', theme: { extend: { colors: { dark: { bg: '#000000', card: '#111827' } } } } }</script>
    <style>
        body { font-family: 'Inter', sans-serif; } 
        ::-webkit-scrollbar { width: 6px; } 
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 4px; } 
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; } 
        .hidden { display: none !important; } 
        .no-scrollbar::-webkit-scrollbar { display: none; } 
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
    </style>

    <!-- FIREBASE & AUTH GUARD -->
    <script type="module">
        // IMPORT CONFIG FROM SEPARATE FILE
        import { auth, db } from "./firebase-config.js";
        
        import { 
            onAuthStateChanged, 
            signOut, 
            deleteUser
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { doc, setDoc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.auth = auth;
        window.db = db;
        
        window.logout = () => { 
            if(window.showConfirmModal) {
                // REDIRECT TO INDEX.HTML (Login Page)
                window.showConfirmModal("Sign Out", "Are you sure you want to sign out?", () => signOut(auth).then(() => window.location.href = 'index.html'));
            } else { 
                if(confirm("Sign Out?")) signOut(auth).then(() => window.location.href = 'index.html'); 
            }
        };

        window.handleDeleteAccount = async () => {
            window.showConfirmModal("DELETE ACCOUNT", "WARNING: This will permanently delete your account and ALL your data. This action cannot be undone.", async () => {
                const user = auth.currentUser;
                try {
                    await deleteDoc(doc(db, 'artifacts', 'fundflow-default', 'users', user.uid, 'data', 'mainState'));
                    await deleteUser(user);
                    window.showCustomAlert("Account Deleted", "Redirecting...");
                    // REDIRECT TO INDEX.HTML
                    setTimeout(() => window.location.href = 'index.html', 2000);
                } catch (e) {
                    window.showCustomAlert("Security Check", "Please sign out and sign in again before deleting your account.");
                }
            });
        };

        onAuthStateChanged(auth, async (user) => {
            // REDIRECT TO INDEX.HTML IF NO USER
            if (!user) window.location.href = 'index.html';
            else {
                try {
                    const docRef = doc(db, 'artifacts', 'fundflow-default', 'users', user.uid, 'data', 'mainState');
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) window.state = { ...window.state, ...docSnap.data() };
                    else saveData();
                    if(window.renderApp) window.renderApp();
                } catch (e) { console.error("Sync Error:", e); }
            }
        });

        window.saveData = async () => {
            localStorage.setItem('moneyFlowStateV3', JSON.stringify(window.state));
            const user = auth.currentUser;
            if (user) await setDoc(doc(db, 'artifacts', 'fundflow-default', 'users', user.uid, 'data', 'mainState'), window.state).catch(console.error);
        };
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-950 text-gray-900 dark:text-gray-100 flex justify-center min-h-screen p-4 transition-colors duration-300">

    <div class="w-full max-w-[1400px] bg-white dark:bg-black min-h-[90vh] shadow-2xl relative border border-gray-200 dark:border-gray-800 rounded-3xl flex flex-col md:flex-row overflow-hidden my-auto z-10">
        
        <!-- LEFT PANEL (Navigation + Sidebar Widgets) -->
        <aside class="w-full md:w-80 lg:w-96 bg-gray-50/80 dark:bg-gray-900/50 border-r border-gray-200 dark:border-gray-800 p-6 flex flex-col relative overflow-y-auto">
            
            <!-- Logo & Header Section -->
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <!-- LOGO APPLIED -->
                    <img src="images/fundflow-logo.png" alt="Logo" class="w-10 h-10 object-contain drop-shadow-sm hover:scale-105 transition-transform">
                    <div>
                        <h1 class="text-lg font-bold tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-blue-600">FUND FLOW</h1>
                        <p class="text-[9px] text-gray-500 uppercase tracking-widest leading-none">Finance Manager</p>
                    </div>
                </div>
                <div class="flex gap-1">
                    <button onclick="toggleTheme()" class="p-2 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-500 hover:text-cyan-500 transition-colors">
                        <i data-lucide="moon" class="icon-moon w-4 h-4 hidden"></i>
                        <i data-lucide="sun" class="icon-sun w-4 h-4 hidden"></i>
                    </button>
                    <button onclick="toggleSettings(true)" class="p-2 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 text-gray-500 hover:text-cyan-500 transition-colors">
                        <i data-lucide="settings" class="w-4 h-4"></i>
                    </button>
                    <!-- SIGN OUT BUTTON -->
                    <button onclick="logout()" class="p-2 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors" title="Sign Out">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>

             <!-- Total Savings Card (NO PROFILE CARD HERE) -->
             <div class="bg-gradient-to-br from-white to-gray-50 dark:from-gray-800 dark:to-gray-900 rounded-2xl p-5 border border-gray-200 dark:border-gray-700 shadow-sm mb-6 relative overflow-hidden">
                <label class="text-gray-500 dark:text-gray-400 text-[10px] font-medium uppercase tracking-wider mb-1 block">Total Savings</label>
                <div class="flex items-center pb-2 mb-3">
                    <span id="total-savings-display" class="text-3xl font-bold text-gray-900 dark:text-white">₱0</span>
                </div>
                 <div class="flex justify-between items-center text-xs p-2 bg-gray-100 dark:bg-black/20 rounded-lg">
                    <span class="text-gray-500 dark:text-gray-400">Total Goal Amount</span>
                </div>
            </div>

            <div class="flex-1">
                <div class="flex justify-between items-center mb-3"><h3 class="text-cyan-600 dark:text-cyan-400 text-xs font-bold flex items-center gap-2"><i data-lucide="wallet" class="w-4 h-4"></i> Savings Accounts</h3></div>
                <div id="accounts-list" class="space-y-2 overflow-y-auto max-h-[30vh] pr-1"></div>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="flex-1 p-6 lg:p-8 overflow-y-auto pb-20 bg-white dark:bg-black relative">
            <!-- Analytics Section -->
            <div class="mb-6">
                <h2 class="text-md font-semibold flex items-center gap-2 text-gray-700 dark:text-gray-300 mb-4"><i data-lucide="bar-chart-2" class="text-cyan-500 w-4 h-4"></i> Growth Overview</h2>
                <div id="savings-analytics" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>

            <!-- UPDATED HEADER: Smaller title on mobile, Icon Buttons on mobile -->
            <div class="flex justify-between items-center mb-6 pt-4 border-t border-gray-100 dark:border-gray-800/50">
                <h2 class="text-base md:text-lg font-semibold flex items-center gap-2 text-gray-800 dark:text-gray-200"><i data-lucide="piggy-bank" class="text-purple-500 w-5 h-5"></i> Savings Vault</h2>
                <button onclick="openSavingsModal()" class="bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold p-2 sm:py-2 sm:px-3 rounded-lg flex items-center gap-2 shadow-lg transition-all">
                    <i data-lucide="plus" class="w-4 h-4"></i> 
                    <span class="hidden sm:inline">New Goal</span>
                </button>
            </div>
            
            <div id="savings-list" class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-4 mb-8"></div>

            <div class="pt-4 border-t border-gray-100 dark:border-gray-800/50 pb-24">
                <h2 class="text-md font-semibold flex items-center gap-2 text-gray-700 dark:text-gray-300 mb-4"><i data-lucide="history" class="text-gray-500 w-4 h-4"></i> Recent Activity</h2>
                <div id="savings-history-list" class="space-y-2"></div>
            </div>

            <!-- FLOATING NAVBAR -->
            <div class="fixed bottom-14 left-0 right-0 md:left-80 lg:left-96 flex justify-center z-50 pointer-events-none">
                <nav class="bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl border border-gray-200 dark:border-gray-800 shadow-2xl rounded-full px-6 py-3 flex items-center gap-2 pointer-events-auto transition-all hover:scale-105">
                    <a href="dashboard.html" class="flex flex-col items-center justify-center w-16 h-12 rounded-2xl text-gray-400 hover:text-cyan-600 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all">
                        <i data-lucide="layout-dashboard" class="w-5 h-5 mb-0.5"></i>
                        <span class="text-[9px] font-medium">Home</span>
                    </a>
                    <a href="budget.html" class="flex flex-col items-center justify-center w-16 h-12 rounded-2xl text-gray-400 hover:text-cyan-600 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all">
                        <i data-lucide="pie-chart" class="w-5 h-5 mb-0.5"></i>
                        <span class="text-[9px] font-medium">Budget</span>
                    </a>
                    <a href="savings.html" class="flex flex-col items-center justify-center w-16 h-12 rounded-2xl bg-cyan-50 dark:bg-cyan-900/20 text-cyan-600 dark:text-cyan-400 transition-all">
                        <i data-lucide="piggy-bank" class="w-5 h-5 mb-0.5"></i>
                        <span class="text-[9px] font-bold">Save</span>
                    </a>
                    <a href="accounts.html" class="flex flex-col items-center justify-center w-16 h-12 rounded-2xl text-gray-400 hover:text-cyan-600 hover:bg-gray-50 dark:hover:bg-gray-800 transition-all">
                        <i data-lucide="wallet" class="w-5 h-5 mb-0.5"></i>
                        <span class="text-[9px] font-medium">Wallet</span>
                    </a>
                </nav>
            </div>
        </main>
    </div>

    <!-- RICH SAVINGS MODAL (MODIFIED: Wider, Shorter, Compact) -->
    <div id="savings-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 hidden">
        <!-- Changed max-w-lg to max-w-2xl (wider) and max-h-[85vh] (slightly shorter) with p-5 (compact padding) -->
        <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 w-full max-w-2xl rounded-3xl p-5 shadow-2xl animate-fade-in flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-100 dark:border-gray-800">
                <div class="flex items-center gap-3">
                    <div class="p-2.5 bg-purple-50 dark:bg-purple-900/20 rounded-xl text-purple-600 dark:text-purple-400">
                        <i data-lucide="piggy-bank" class="w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 id="savings-modal-title" class="font-bold text-lg text-gray-900 dark:text-white">New Goal</h3>
                        <p class="text-xs text-gray-500">Plan your savings journey</p>
                    </div>
                </div>
                <button onclick="closeSavingsModal()" class="text-gray-400 hover:text-gray-900 dark:hover:text-white transition-colors p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <!-- Reduced spacing from space-y-6 to space-y-4 -->
            <div class="overflow-y-auto flex-1 pr-2 space-y-4 custom-scrollbar">
                <div>
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2 ml-1">Goal Info</label>
                    <div class="flex gap-3">
                        <button onclick="toggleSavingsIconPicker()" id="savings-icon-trigger" class="flex items-center justify-center w-14 h-[50px] bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl text-gray-400 hover:text-purple-500 hover:border-purple-500 transition-all shrink-0">
                            <i data-lucide="image" class="w-6 h-6"></i>
                        </button>
                        <div class="flex-1">
                             <input type="text" id="savings-name" placeholder="Goal Name (e.g. Dream Travel)" class="w-full h-[50px] bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-xl px-4 text-sm dark:text-white outline-none focus:border-purple-500 transition-all placeholder-gray-400">
                        </div>
                    </div>
                    <div id="savings-icon-container" class="hidden mt-3 p-3 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-2xl shadow-xl grid grid-cols-6 gap-2"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1.5 ml-1">Target Amount</label>
                        <div class="relative">
                            <span class="absolute left-3 top-3.5 text-gray-400 text-xs font-bold">₱</span>
                            <input type="number" id="savings-target" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-xl py-3 pl-7 pr-3 text-sm font-bold dark:text-white outline-none focus:border-purple-500 transition-all">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1.5 ml-1">Target Date</label>
                        <div class="relative">
                            <input type="date" id="savings-date" onclick="this.showPicker()" class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-xl p-3 text-sm dark:text-white outline-none focus:border-purple-500 transition-all cursor-pointer">
                        </div>
                    </div>
                </div>
                <div class="p-5 bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/10 dark:to-pink-900/10 rounded-2xl border border-purple-100 dark:border-purple-900/30">
                    <label class="block text-xs font-bold text-purple-600 dark:text-purple-400 uppercase tracking-wider mb-2">Current Progress / Saved</label>
                    <div class="relative">
                        <span class="absolute left-4 top-3.5 text-purple-400 text-lg font-bold">₱</span>
                        <input type="number" id="savings-current" class="w-full bg-white dark:bg-black border border-purple-100 dark:border-purple-900/30 rounded-xl py-3 pl-8 pr-4 text-2xl font-bold text-purple-700 dark:text-white outline-none focus:ring-2 focus:ring-purple-500/20 transition-all shadow-sm" placeholder="0.00">
                    </div>
                </div>
                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800/50 rounded-xl border border-gray-200 dark:border-gray-700">
                    <div>
                        <span class="block text-sm font-medium text-gray-900 dark:text-gray-200">Include in Total Assets</span>
                        <span class="block text-[10px] text-gray-500">Count this towards your net worth</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="savings-include-toggle" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-purple-600"></div>
                    </label>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2 ml-1">Linked Account</label>
                    <div class="relative mb-2">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="search" class="text-gray-400 w-4 h-4"></i></div>
                        <input type="text" id="savings-source-search" oninput="renderSavingsSourceGrid()" placeholder="Search source account..." class="w-full bg-gray-50 dark:bg-black border border-gray-200 dark:border-gray-700 rounded-xl py-2.5 pl-9 pr-3 text-xs dark:text-white outline-none focus:border-purple-500 transition-all">
                    </div>
                    <div class="h-36 overflow-y-auto border border-gray-200 dark:border-gray-800 rounded-xl bg-white dark:bg-gray-900 p-1 custom-scrollbar">
                        <div id="savings-source-grid" class="grid grid-cols-1 gap-1"></div>
                    </div>
                </div>
                <div id="goal-history-section" class="hidden pt-4 border-t border-gray-100 dark:border-gray-800">
                    <h4 class="text-xs font-bold text-gray-500 mb-3 uppercase tracking-wider flex items-center gap-2"><i data-lucide="history" class="w-3 h-3"></i> Transaction History</h4>
                    <div id="goal-history-list" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar pr-1"></div>
                </div>
            </div>
            <div class="pt-4 mt-2 border-t border-gray-100 dark:border-gray-800 flex gap-3">
                <button id="btn-delete-savings" onclick="deleteCurrentSavings()" class="hidden w-12 flex items-center justify-center bg-red-50 hover:bg-red-100 dark:bg-red-900/20 dark:hover:bg-red-900/30 text-red-600 dark:text-red-400 rounded-xl transition-colors">
                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
                <button id="btn-save-savings" onclick="submitNewSavings()" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-purple-500/20 transition-all active:scale-[0.98]">
                    Save Goal
                </button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL (Redesigned) -->
    <div id="settings-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 hidden">
        <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 w-full max-w-lg rounded-3xl p-6 shadow-2xl animate-fade-in flex flex-col h-auto max-h-[85vh]">
            <div class="flex justify-between items-center mb-6 pb-2 border-b border-gray-100 dark:border-gray-800">
                <div class="flex items-center gap-2">
                    <div class="p-2 bg-gray-100 dark:bg-gray-800 rounded-lg"><i data-lucide="settings" class="w-5 h-5 text-gray-500 dark:text-white"></i></div>
                    <h3 class="font-bold text-lg dark:text-white">App Settings</h3>
                </div>
                <button onclick="toggleSettings(false)" class="text-gray-400 hover:text-gray-900 dark:hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="overflow-y-auto pr-2 space-y-6">
                <div class="bg-gradient-to-r from-cyan-50 to-blue-50 dark:from-cyan-900/10 dark:to-blue-900/10 p-5 rounded-2xl border border-cyan-100 dark:border-cyan-900/30">
                    <h4 class="text-xs font-bold text-cyan-600 dark:text-cyan-400 uppercase tracking-wider mb-3 flex items-center gap-2"><i data-lucide="file-text" class="w-4 h-4"></i> Statement of Account</h4>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="col-span-2">
                            <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-wider">Select Period Type</label>
                            <select id="report-type-selector" onchange="toggleReportInputs()" class="custom-select w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-2.5 text-sm dark:text-white outline-none cursor-pointer">
                                <option value="standard">Standard (Week/Month/All)</option>
                                <option value="specific-month">Specific Month</option>
                                <option value="custom">Custom Date Range</option>
                            </select>
                        </div>
                        <div id="report-input-standard" class="col-span-2">
                            <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-wider">Range</label>
                            <select id="report-range" class="custom-select w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-2.5 text-sm dark:text-white outline-none">
                                <option value="week">Current Week</option>
                                <option value="month">Current Month</option>
                                <option value="all">All Time History</option>
                            </select>
                        </div>
                        <div id="report-input-month" class="hidden col-span-2">
                            <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-wider">Select Month</label>
                            <input type="month" id="report-month-val" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-2.5 text-sm dark:text-white outline-none">
                        </div>
                        <div id="report-input-custom" class="hidden col-span-2 grid-cols-2 gap-2">
                            <div><label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-wider">From</label><input type="date" id="report-start" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-2.5 text-sm dark:text-white outline-none"></div>
                            <div><label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-wider">To</label><input type="date" id="report-end" class="w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-2.5 text-sm dark:text-white outline-none"></div>
                        </div>
                    </div>
                    <button onclick="generateReport()" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-xl text-xs flex items-center justify-center gap-2 shadow-lg shadow-cyan-500/20 transition-all"><i data-lucide="printer" class="w-4 h-4"></i> Generate & Print Report</button>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-3">Preferences</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="block text-xs font-medium text-gray-600 dark:text-gray-300 mb-1">Dashboard Payable View</label>
                            <select id="setting-dashboard-view" class="custom-select w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-3 dark:text-white focus:border-cyan-500 outline-none transition-colors">
                                <option value="weekly">This Week</option>
                                <option value="monthly">This Month</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 dark:text-gray-300 mb-1">Recurring Income</label>
                            <div class="relative"><span class="absolute left-3 top-3 text-gray-400 text-xs">₱</span><input type="number" id="setting-amount" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl py-3 pl-6 pr-3 text-sm dark:text-white focus:border-cyan-500 outline-none transition-colors"></div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 dark:text-gray-300 mb-1">Frequency</label>
                            <select id="setting-frequency" onchange="updateSettingsUI()" class="custom-select w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-3 text-sm dark:text-white focus:border-cyan-500 outline-none transition-colors">
                                <option value="weekly">Weekly</option>
                                <option value="semi-monthly">Semi-Monthly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                    </div>
                    <div id="setting-weekly-container" class="mt-3">
                        <label class="block text-xs font-medium text-gray-600 dark:text-gray-300 mb-1">Day of Week</label>
                        <select id="setting-day" class="custom-select w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-3 text-sm dark:text-white outline-none"><option value="1">Monday</option><option value="2">Tuesday</option><option value="3">Wednesday</option><option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option><option value="0">Sunday</option></select>
                    </div>
                    <div id="setting-monthly-container" class="hidden mt-3">
                        <label class="block text-xs font-medium text-gray-600 dark:text-gray-300 mb-1">Day of Month</label>
                        <input type="number" id="setting-date" min="1" max="31" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-3 text-sm dark:text-white outline-none">
                    </div>
                </div>
                <div class="pt-4 border-t border-gray-200 dark:border-gray-700 space-y-2">
                    <h4 class="text-xs font-bold text-red-500 uppercase tracking-wider mb-3">Danger Zone</h4>
                    <button onclick="window.showConfirmModal('Reset Data', 'Are you sure you want to delete ALL transactions and goals? This cannot be undone.', confirmResetData)" class="w-full bg-red-50 hover:bg-red-100 dark:bg-red-900/10 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400 font-bold py-3.5 rounded-xl border border-red-100 dark:border-red-900/30 transition-colors text-xs flex items-center justify-center gap-2 group"><i data-lucide="trash-2" class="w-4 h-4 group-hover:scale-110 transition-transform"></i> Reset All Data</button>
                    <button onclick="handleDeleteAccount()" class="w-full bg-transparent hover:bg-red-50 dark:hover:bg-red-900/20 text-red-500 dark:text-red-500 font-bold py-3 rounded-xl border border-transparent hover:border-red-100 dark:hover:border-red-900/30 transition-colors text-xs flex items-center justify-center gap-2"><i data-lucide="user-x" class="w-4 h-4"></i> Delete Account</button>
                </div>
            </div>
            <div class="pt-4 mt-2 border-t border-gray-200 dark:border-gray-700">
                <button onclick="saveSettings()" class="w-full bg-gray-900 dark:bg-white hover:bg-gray-800 dark:hover:bg-gray-100 text-white dark:text-gray-900 font-bold py-3.5 rounded-xl transition-all shadow-lg">Save Changes</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>

    <!-- PAGE SPECIFIC SCRIPT -->
    <script>
        // Exposed Functions for this page
        window.renderApp = renderApp;
        window.openSavingsModal = openSavingsModal;
        window.closeSavingsModal = closeSavingsModal;
        window.openEditSavingsModal = openEditSavingsModal;
        window.submitNewSavings = submitNewSavings;
        window.deleteCurrentSavings = deleteCurrentSavings;
        window.renderSavingsSourceGrid = renderSavingsSourceGrid;
        window.toggleSavingsIconPicker = toggleSavingsIconPicker;
        window.updateSavingsIconTrigger = updateSavingsIconTrigger;

        let selectedSavingsSourceId = null;
        let selectedSavingsIconId = null;
        let editingId = null;

        document.addEventListener('DOMContentLoaded', () => {
            try {
                loadState(); 
                if(!state.savingsHistory) state.savingsHistory = []; // Ensure history exists
                initTheme();
                renderApp();
                
                // Close dropdowns on click outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#savings-icon-trigger') && !e.target.closest('#savings-icon-container')) {
                        document.getElementById('savings-icon-container').classList.add('hidden');
                    }
                });
            } catch (e) { console.error("Init error:", e); }
        });

        /* --- RENDERERS --- */
        function renderApp() {
            renderSavings();
            renderSavingsAnalytics();
            renderSavingsHistory();
            updateTotals();
            renderAccountsSidebar();
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function renderSavingsAnalytics() {
            const container = document.getElementById('savings-analytics');
            if(!container) return;
            
            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            let addedThisWeek = 0;
            let addedThisMonth = 0;

            (state.savingsHistory || []).forEach(tx => {
                const date = new Date(tx.date);
                if (tx.amount > 0) {
                    if (date >= oneWeekAgo) addedThisWeek += tx.amount;
                    if (date >= firstDayOfMonth) addedThisMonth += tx.amount;
                }
            });

            // UPDATED: Single Line Card Design (Text Field Style)
            container.innerHTML = `
                <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl p-3 flex items-center justify-between shadow-sm h-14">
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Added This Week</span>
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-bold text-green-600 dark:text-green-400">+₱${addedThisWeek.toLocaleString()}</span>
                        <div class="p-1 bg-green-100 dark:bg-green-900/30 rounded-md text-green-600"><i data-lucide="trending-up" class="w-4 h-4"></i></div>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-xl p-3 flex items-center justify-between shadow-sm h-14">
                    <span class="text-xs font-bold text-gray-500 uppercase tracking-wider ml-1">Added This Month</span>
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-bold text-cyan-600 dark:text-cyan-400">+₱${addedThisMonth.toLocaleString()}</span>
                        <div class="p-1 bg-cyan-100 dark:bg-cyan-900/30 rounded-md text-cyan-600"><i data-lucide="calendar" class="w-4 h-4"></i></div>
                    </div>
                </div>
            `;
        }

        function renderSavingsHistory() {
            const container = document.getElementById('savings-history-list');
            if(!container) return;
            container.innerHTML = '';
            
            const history = (state.savingsHistory || []).sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 10); // Last 10

            if (history.length === 0) {
                container.innerHTML = '<div class="text-xs text-gray-400 text-center py-4">No recent activity</div>';
                return;
            }

            history.forEach(tx => {
                const goal = state.savings.find(g => g.id == tx.goalId);
                const goalName = goal ? goal.name : 'Unknown Goal';
                const dateStr = new Date(tx.date).toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                const isDeposit = tx.amount >= 0;

                container.insertAdjacentHTML('beforeend', `
                    <div class="flex justify-between items-center p-3 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg ${isDeposit ? 'bg-green-100 text-green-600 dark:bg-green-900/30 dark:text-green-400' : 'bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400'} flex items-center justify-center">
                                <i data-lucide="${isDeposit ? 'arrow-up-right' : 'arrow-down-left'}" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <h4 class="text-sm font-bold text-gray-900 dark:text-white">${goalName}</h4>
                                <span class="text-[10px] text-gray-500">${dateStr} • ${tx.note || 'Update'}</span>
                            </div>
                        </div>
                        <span class="text-sm font-bold font-mono ${isDeposit ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                            ${isDeposit ? '+' : ''}₱${tx.amount.toLocaleString()}
                        </span>
                    </div>
                `);
            });
        }

        function renderGoalHistory(goalId) {
            const container = document.getElementById('goal-history-list');
            if (!container) return;
            container.innerHTML = '';

            const history = (state.savingsHistory || [])
                .filter(tx => tx.goalId == goalId)
                .sort((a,b) => new Date(b.date) - new Date(a.date));

            if (history.length === 0) {
                container.innerHTML = '<div class="text-xs text-gray-400 italic text-center py-2">No transactions recorded yet.</div>';
                return;
            }

            history.forEach(tx => {
                const dateStr = new Date(tx.date).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: '2-digit' });
                const isDeposit = tx.amount >= 0;
                container.insertAdjacentHTML('beforeend', `
                    <div class="flex justify-between items-center py-2 border-b border-gray-50 dark:border-gray-800 last:border-0">
                        <div class="flex flex-col">
                            <span class="text-xs font-medium text-gray-700 dark:text-gray-300">${tx.note || (isDeposit ? 'Deposit' : 'Withdrawal')}</span>
                            <span class="text-[9px] text-gray-400">${dateStr}</span>
                        </div>
                        <span class="text-xs font-bold font-mono ${isDeposit ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                            ${isDeposit ? '+' : ''}₱${tx.amount.toLocaleString()}
                        </span>
                    </div>
                `);
            });
        }

        function renderSavings() {
            const container = document.getElementById('savings-list');
            if (!container) return;
            container.innerHTML = '';
            state.savings.forEach(goal => {
                const percentage = Math.min(100, Math.round((goal.current / goal.target) * 100)) || 0;
                const iconProvider = PROVIDERS.find(p => p.id === goal.icon) || { icon: 'piggy-bank', color: 'bg-cyan-600' };
                // Source is now an Account ID
                const sourceAccount = state.accounts.find(a => a.id === goal.source);
                const sourceName = sourceAccount ? sourceAccount.name : 'Unknown Account';
                
                container.insertAdjacentHTML('beforeend', `
                    <div onclick="openEditSavingsModal('${goal.id}')" class="cursor-pointer bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl p-5 relative overflow-hidden group hover:border-cyan-500 transition-colors shadow-sm hover:shadow-md">
                        <div class="flex gap-3 items-start"><div class="w-10 h-10 rounded-lg ${iconProvider.color} flex items-center justify-center text-white shrink-0 mt-0.5"><i data-lucide="${iconProvider.icon}" class="w-5 h-5"></i></div>
                        <div class="flex-1 min-w-0"><div class="flex justify-between items-start mb-1"><div><h4 class="text-sm font-bold text-gray-900 dark:text-white truncate">${goal.name}</h4><p class="text-[10px] text-gray-500">Linked to: <b>${sourceName}</b></p></div>${goal.date ? `<span class="text-[9px] bg-gray-100 dark:bg-gray-800 px-1.5 py-0.5 rounded text-gray-500">Target: ${goal.date}</span>` : ''}</div>
                        <div class="flex justify-between items-end mb-1"><span class="text-[12px] font-mono text-cyan-600 dark:text-cyan-400 font-bold">₱${goal.current.toLocaleString()}</span><span class="text-[10px] font-mono text-gray-400">/ ₱${goal.target.toLocaleString()}</span></div>
                        <div class="h-1.5 w-full bg-gray-200 dark:bg-gray-800 rounded-full overflow-hidden"><div class="h-full ${iconProvider.color} transition-all duration-500" style="width: ${percentage}%"></div></div></div></div>
                    </div>`);
            });
        }

        function updateTotals() {
            const elSav = document.getElementById('total-savings-display');
            if(elSav) {
                const totalSav = state.savings.reduce((acc, curr) => acc + Number(curr.current), 0);
                elSav.innerText = `₱${totalSav.toLocaleString()}`;
            }
        }

        // --- OVERRIDE SHARED RENDERER ---
        function renderAccountsSidebar() {
            const sidebarList = document.getElementById('accounts-list');
            if(!sidebarList) return;
            
            const savingsBySource = {};
            state.savings.forEach(goal => {
                if (goal.includeInTotal) savingsBySource[goal.source] = (savingsBySource[goal.source] || 0) + Number(goal.current);
            });

            // For the sidebar, sticking to "Savings" tagged ones for cleaner view in Savings page
            const savingsAccounts = state.accounts.filter(a => a.tag === 'savings');

            sidebarList.innerHTML = savingsAccounts.map(acc => {
                let provider = PROVIDERS.find(p => p.id === acc.providerId) || { color: 'bg-gray-600', icon: 'wallet' };
                const total = acc.balance + (savingsBySource[acc.id] || 0); // Use acc.id
                return `<div class="flex justify-between items-center p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                    <div class="flex items-center gap-2 overflow-hidden">
                        <div class="w-6 h-6 rounded-md ${provider.color} flex items-center justify-center text-white shrink-0"><i data-lucide="${provider.icon}" class="w-3 h-3"></i></div>
                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300 truncate">${acc.name}</span>
                    </div>
                    <span class="text-xs font-bold text-gray-900 dark:text-white">₱${total.toLocaleString()}</span>
                </div>`
            }).join('') || '<div class="text-xs text-gray-400 text-center py-2">No savings accounts</div>';
        }

        /* --- SAVINGS LOGIC --- */
        function openSavingsModal() {
            editingId = null;
            const el = document.getElementById('savings-modal');
            if(!el) return;
            document.getElementById('savings-modal-title').innerText = "New Goal";
            document.getElementById('savings-name').value = '';
            document.getElementById('savings-target').value = '';
            document.getElementById('savings-current').value = '';
            document.getElementById('savings-date').value = '';
            document.getElementById('btn-delete-savings').classList.add('hidden');
            document.getElementById('goal-history-section').classList.add('hidden');
            selectedSavingsSourceId = null;
            selectedSavingsIconId = 'piggy-bank';
            updateSavingsIconTrigger();
            renderSavingsSourceGrid();
            el.classList.remove('hidden');
        }

        function closeSavingsModal() { const el = document.getElementById('savings-modal'); if(el) el.classList.add('hidden'); }

        function openEditSavingsModal(id) {
            const goal = state.savings.find(s => s.id == id);
            const el = document.getElementById('savings-modal');
            if (!goal || !el) return;
            editingId = id;
            document.getElementById('savings-modal-title').innerText = "Edit Goal";
            document.getElementById('savings-name').value = goal.name;
            document.getElementById('savings-target').value = goal.target;
            document.getElementById('savings-current').value = goal.current;
            document.getElementById('savings-date').value = goal.date || '';
            if(document.getElementById('savings-include-toggle')) document.getElementById('savings-include-toggle').checked = goal.includeInTotal;
            
            document.getElementById('btn-delete-savings').classList.remove('hidden');
            document.getElementById('goal-history-section').classList.remove('hidden'); // Show history
            
            selectedSavingsSourceId = goal.source;
            selectedSavingsIconId = goal.icon;
            
            updateSavingsIconTrigger();
            renderSavingsSourceGrid();
            renderGoalHistory(id); // Render specific history
            el.classList.remove('hidden');
        }

        // UPDATED: Show ALL Liquid Assets (Cash & Banks) regardless of tag
        function renderSavingsSourceGrid() {
            const container = document.getElementById('savings-source-grid');
            if (!container) return;
            container.innerHTML = '';
            const search = document.getElementById('savings-source-search')?.value.toLowerCase() || '';
            
            // Filter: All non-credit accounts (Liquid Assets)
            const availableAccounts = state.accounts.filter(a => a.tag !== 'credit' && a.name.toLowerCase().includes(search));

            if (availableAccounts.length === 0) {
                container.innerHTML = '<div class="col-span-1 text-center text-xs text-gray-400 py-4">No liquid accounts found. Please add a Cash or Bank account first.</div>';
                return;
            }

            availableAccounts.forEach(acc => {
                const provider = PROVIDERS.find(p => p.id === acc.providerId) || { color: 'bg-gray-600', icon: 'wallet' };
                const isSel = selectedSavingsSourceId === acc.id;
                // Check if it's already a savings account for visual cue
                const isSavingsTag = acc.tag === 'savings';
                
                container.insertAdjacentHTML('beforeend', `
                    <div onclick="selectedSavingsSourceId = '${acc.id}'; renderSavingsSourceGrid();" class="cursor-pointer flex items-center justify-between p-3 rounded-xl border transition-all ${isSel ? 'ring-2 ring-purple-500 bg-purple-50 dark:bg-purple-900/20 border-purple-200 dark:border-purple-800' : 'border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800'}">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg ${provider.color} flex items-center justify-center text-white shrink-0">
                                <i data-lucide="${provider.icon}" class="w-4 h-4"></i>
                            </div>
                            <div class="flex flex-col">
                                <span class="text-xs font-bold text-gray-700 dark:text-gray-300 leading-none">${acc.name}</span>
                                <span class="text-[10px] text-gray-400 mt-0.5">${isSavingsTag ? 'Savings Account' : 'Account'} • ₱${acc.balance.toLocaleString()}</span>
                            </div>
                        </div>
                        ${isSel ? '<i data-lucide="check-circle" class="w-4 h-4 text-purple-500"></i>' : ''}
                    </div>`);
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function toggleSavingsIconPicker() {
            const container = document.getElementById('savings-icon-container');
            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                container.innerHTML = PROVIDERS.filter(p => p.type === 'generic').map(p => `<div onclick="selectedSavingsIconId='${p.id}'; toggleSavingsIconPicker(); updateSavingsIconTrigger();" class="cursor-pointer p-2 border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 flex justify-center hover:border-purple-500 transition-all"><div class="w-6 h-6 rounded ${p.color} text-white flex items-center justify-center"><i data-lucide="${p.icon}" class="w-3 h-3"></i></div></div>`).join('');
                if (typeof lucide !== 'undefined') lucide.createIcons();
            } else {
                container.classList.add('hidden');
            }
        }

        function updateSavingsIconTrigger() {
            const p = PROVIDERS.find(x => x.id === selectedSavingsIconId) || { icon: 'piggy-bank', color: 'bg-cyan-600' };
            const btn = document.getElementById('savings-icon-trigger');
            if(btn) {
                btn.innerHTML = `<i data-lucide="${p.icon}" class="w-6 h-6"></i>`;
                // Remove generic color and apply provider color
                btn.className = `flex items-center justify-center w-14 h-[50px] text-white rounded-xl transition-colors ${p.color} shadow-md`;
            }
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function submitNewSavings() {
            const name = document.getElementById('savings-name').value;
            const target = Number(document.getElementById('savings-target').value);
            const current = Number(document.getElementById('savings-current').value);
            const date = document.getElementById('savings-date').value;
            const include = document.getElementById('savings-include-toggle') ? document.getElementById('savings-include-toggle').checked : true;
            
            if(!name || !target || !selectedSavingsSourceId) return showCustomAlert("Error", "Complete details required (Name, Target, Account Source)");
            
            // Logic to calculate difference and log transaction
            let diff = current;
            let note = "Initial Deposit";
            
            if (editingId) {
                const oldGoal = state.savings.find(g => g.id == editingId);
                if (oldGoal) {
                    diff = current - oldGoal.current;
                    if (diff > 0) note = "Deposit";
                    else if (diff < 0) note = "Withdrawal";
                    else note = "Update"; // No change
                }
            }

            // Only log if there's a difference and it's not a trivial 0 change on edit
            if (diff !== 0) {
                 if(!state.savingsHistory) state.savingsHistory = [];
                 state.savingsHistory.push({
                     id: Date.now(),
                     goalId: editingId || Date.now(), // If new, this ID might mismatch slightly if not sync'd, fixing below
                     amount: diff,
                     date: new Date().toISOString(),
                     note: note
                 });
            }

            const newId = editingId || Date.now();

            // Correct ID reference in history for new items
            if (!editingId && diff !== 0) {
                state.savingsHistory[state.savingsHistory.length - 1].goalId = newId;
            }

            const data = { id: newId, name, target, current, date, includeInTotal: include, source: selectedSavingsSourceId, icon: selectedSavingsIconId || 'save' };
            
            // Auto-tag account as 'savings' if it isn't already (simple tag update)
            const accIndex = state.accounts.findIndex(a => a.id === selectedSavingsSourceId);
            if (accIndex !== -1 && state.accounts[accIndex].tag !== 'savings') {
                state.accounts[accIndex].tag = 'savings'; 
            }

            if (editingId) {
                const idx = state.savings.findIndex(x => x.id == editingId);
                if (idx !== -1) state.savings[idx] = data;
            } else state.savings.push(data);
            
            closeSavingsModal();
            saveData();
            renderApp();
        }

        function deleteCurrentSavings() {
            if (editingId) {
                showConfirmModal(
                    "Delete Goal?",
                    "Are you sure you want to delete this savings goal?",
                    () => {
                        state.savings = state.savings.filter(x => x.id != editingId);
                        // Also clear history for this goal? Optional. Keeping it for record usually better, but let's leave it.
                        closeSavingsModal();
                        saveData();
                        renderApp();
                    }
                );
            }
        }
    </script>
</body>
</html>